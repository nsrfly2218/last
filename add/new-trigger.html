<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إضافة مشغل جديد</title>
    <link rel="stylesheet" href="../style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .wd-content-body {
        padding: 20px;
        margin: 0 auto;
      }

      .wd-form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 30px;
      }

      .wd-form-header {
        margin-bottom: 30px;
        text-align: center;
      }

      .wd-form-header h2 {
        color: #333;
        margin-bottom: 10px;
      }

      .wd-form-header p {
        color: #666;
        font-size: 14px;
      }

      .wd-form-group {
        margin-bottom: 25px;
      }

      .wd-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .wd-form-group input,
      .wd-form-group select,
      .wd-form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .wd-form-group input:focus,
      .wd-form-group select:focus,
      .wd-form-group textarea:focus {
        outline: none;
        border-color: #25d366;
        box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.1);
      }

      .wd-form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .wd-inline-options {
        display: flex;
        gap: 15px;
      }

      .wd-inline-options label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      /* Action type cards (match new-campaign message type) */
      .wd-message-type {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }

      .wd-message-type-option {
        flex: 1;
        padding: 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .wd-message-type-option i {
        color: #4a90e2;
        font-size: 18px;
      }

      .wd-message-type-option:hover {
        border-color: #4a90e2;
        background-color: #f8f9fa;
      }

      .wd-message-type-option.selected {
        border-color: #4a90e2;
        background-color: #e9f0f9;
      }

      /* Template preview subset */
      .wd-message-container {
        display: flex;
        flex-direction: row;
        gap: 20px;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .wd-message-form {
        flex: 1;
      }
      .wd-message-preview {
        width: 350px;
      }
      .wd-preview-title {
        font-weight: 500;
        margin-bottom: 10px;
        color: #333;
      }

      .wd-template-preview {
        width: 350px;
        margin: 0 auto;
        background: #e5ddd5;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        height: 400px;
        border: 1px solid #e0e0e0;
      }

      .wd-preview-content {
        flex: 1;
        background: transparent;
        padding: 20px;
        overflow-y: auto;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .wd-preview-message {
        background: #fff;
        border-radius: 7.5px 7.5px 7.5px 0;
        padding: 10px 12px;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        max-width: 85%;
        width: 280px;
        min-height: 45px;
        align-self: flex-start;
        position: relative;
      }
      .wd-preview-message::before {
        content: "";
        position: absolute;
        top: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-top: 8px solid #fff;
        border-left: 8px solid transparent;
      }
      .wd-preview-body {
        font-size: 14px;
        color: #303030;
        line-height: 19px;
        white-space: pre-wrap;
      }
      .wd-preview-buttons {
        margin-top: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
        background: white;
        padding: 0;
        max-width: 85%;
        width: 280px;
        align-self: flex-start;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        border-radius: 0 0 7.5px 7.5px;
        overflow: hidden;
        margin-bottom: 15px;
      }
      .wd-preview-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 10px 12px;
        background: white;
        color: #128c7e;
        border: none;
        border-top: 1px solid #f0f0f0;
        font-size: 14px;
        cursor: pointer;
        font-weight: 500;
        text-align: center;
        outline: none;
      }

      @media (max-width: 992px) {
        .wd-message-container {
          flex-direction: column;
        }
        .wd-message-preview {
          width: 100%;
          max-width: 350px;
          margin: 0 auto;
        }
      }

      .wd-toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .wd-toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .wd-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .wd-toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .wd-toggle-slider {
        background-color: #25d366;
      }

      input:checked + .wd-toggle-slider:before {
        transform: translateX(26px);
      }

      .wd-toggle-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .wd-toggle-container span {
        font-size: 14px;
        color: #666;
      }

      .wd-flow-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wd-flow-selector:hover {
        border-color: #25d366;
        background: #f0f9f0;
      }

      .wd-flow-selector i {
        color: #25d366;
        font-size: 16px;
      }

      .wd-flow-selector span {
        color: #333;
        font-size: 14px;
      }

      .wd-form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .wd-btn-secondary {
        padding: 12px 24px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        color: #666;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .wd-btn-secondary:hover {
        background: #f8f9fa;
        border-color: #ccc;
      }

      .wd-btn-primary {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #25d366;
        color: white;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .wd-btn-primary:hover {
        background: #1ea952;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3);
      }

      .wd-conditions-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .wd-conditions-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .wd-conditions-header i {
        color: #25d366;
        font-size: 16px;
      }

      .wd-conditions-header h4 {
        color: #333;
        margin: 0;
      }

      .wd-condition-item {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }

      .wd-condition-item select {
        flex: 1;
        max-width: 200px;
      }

      .wd-condition-item input {
        flex: 1;
        max-width: 200px;
      }

      .wd-add-condition {
        color: #25d366;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 8px 0;
      }

      .wd-add-condition:hover {
        color: #1ea952;
      }

      @media (max-width: 768px) {
        .wd-content-body {
          padding: 15px;
        }

        .wd-form-container {
          padding: 20px;
        }

        .wd-form-actions {
          flex-direction: column;
        }

        .wd-form-actions .wd-btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- القسم الأول: الشريط الجانبي الرئيسي -->
    <aside class="wd-sidebar">
      <div class="wd-logo">
        <img src="../imgs/logo.png" alt="شعار المنصة" />
      </div>
      <nav class="wd-nav">
        <ul>
          <li class="wd-nav-item">
            <i class="fa-solid fa-gauge"></i>
            <span
              ><a href="../index.html" class="wd-nav-link">لوحة التحكم</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-comments"></i>
            <span
              ><a href="../chat.html" class="wd-nav-link">المحادثات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-users"></i>
            <span
              ><a href="../contacts.html" class="wd-nav-link"
                >جهات الاتصال</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-diagram-project"></i>
            <span
              ><a href="../flows.html" class="wd-nav-link">التدفقات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-bullhorn"></i>
            <span
              ><a href="../campaigns.html" class="wd-nav-link">الحملات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-calendar"></i>
            <span
              ><a href="../calendar.html" class="wd-nav-link">التقويم</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-file-alt"></i>
            <span
              ><a href="../contents.html" class="wd-nav-link"
                >المحتويات</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-code"></i>
            <span
              ><a href="../developers.html" class="wd-nav-link"
                >المطورين</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-cog"></i>
            <span
              ><a href="../settings.html" class="wd-nav-link"
                >الإعدادات</a
              ></span
            >
          </li>
        </ul>
      </nav>
    </aside>

    <!-- القسم الثالث: المحتوى الرئيسي -->
    <div class="wd-main-content" style="right: 65px">
      <div class="wd-content-header" style="right: 65px">
        <div class="wd-header-left">
          <button
            class="wd-back-btn"
            onclick="window.location.href='../contents/triggers.html'"
          >
            <i class="fas fa-arrow-right"></i>
          </button>
          <h1>إضافة مشغل جديد</h1>
        </div>
      </div>

      <div class="wd-content-body" style="right: 65px">
        <div class="wd-form-container">
          <form>
            <div class="wd-form-group">
              <label for="trigger-name">اسم المشغل</label>
              <input
                type="text"
                id="trigger-name"
                placeholder="أدخل اسم المشغل..."
                required
              />
            </div>

            <div class="wd-form-group">
              <label for="trigger-operator">نوع المشغل</label>
              <select id="trigger-operator" required>
                <option value="">اختر نوع المشغل</option>
                <option value="tag-added">تم إضافة وسم</option>
                <option value="tag-removed">تم إزالة وسم</option>
                <option value="group-added">تم إضافة مجموعة</option>
                <option value="group-removed">تم إزالة مجموعة</option>
              </select>
            </div>

            <div
              id="operator-extra"
              class="wd-form-group"
              style="display: none"
            ></div>

            <div class="wd-form-group">
              <label for="reminder-type">نوع التذكير</label>
              <select id="reminder-type">
                <option value="">اختر نوع التذكير</option>
                <option value="immediately">فوراً</option>
                <option value="before">قبل الحدث</option>
                <option value="after">بعد الحدث</option>
              </select>
            </div>

            <div
              class="wd-form-group"
              id="reminder-unit-group"
              style="display: none"
            >
              <label for="reminder-unit">وحدة التذكير</label>
              <select id="reminder-unit">
                <option value="">اختر وحدة التذكير</option>
                <option value="minutes">دقائق</option>
                <option value="hours">ساعات</option>
                <option value="days">أيام</option>
              </select>
            </div>

            <div
              class="wd-form-group"
              id="reminder-time-group"
              style="display: none"
            >
              <label for="reminder-time">وقت التذكير</label>
              <input
                type="number"
                id="reminder-time"
                min="1"
                placeholder="أدخل القيمة"
              />
            </div>

            <div class="wd-form-group">
              <label>نوع الإجراء</label>
              <div class="wd-message-type" id="action-type">
                <div
                  class="wd-message-type-option selected"
                  data-action-type="text"
                >
                  <i class="fas fa-align-left"></i>
                  <div>نص</div>
                </div>
                <div class="wd-message-type-option" data-action-type="template">
                  <i class="fas fa-envelope-open-text"></i>
                  <div>قالب</div>
                </div>
                <div class="wd-message-type-option" data-action-type="flow">
                  <i class="fa-solid fa-diagram-project"></i>
                  <div>تدفق</div>
                </div>
              </div>
            </div>

            <div class="wd-form-group" id="action-details"></div>

            <div class="wd-form-group">
              <div class="wd-toggle-container">
                <label class="wd-toggle-switch">
                  <input type="checkbox" checked />
                  <span class="wd-toggle-slider"></span>
                </label>
                <span>تفعيل المشغل فوراً</span>
              </div>
            </div>

            <div class="wd-form-actions">
              <a href="../contents/triggers.html" class="wd-btn-secondary">
                <i class="fas fa-times"></i>
                إلغاء
              </a>
              <button type="submit" class="wd-btn-primary">
                <i class="fas fa-save"></i>
                حفظ المشغل
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="../script.js"></script>
    <script>
      (function () {
        const operatorSelect = document.getElementById("trigger-operator");
        const operatorExtra = document.getElementById("operator-extra");

        function handleOperatorChange() {
          const value = operatorSelect.value;
          if (!value) {
            operatorExtra.style.display = "none";
            operatorExtra.innerHTML = "";
            return;
          }

          if (value === "tag-added" || value === "tag-removed") {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر الوسم</label>
              <select id="tag-select">
                <option value="">اختر الوسم</option>
                <option value="vip">VIP</option>
                <option value="interested">مهتم</option>
                <option value="followup">متابعة</option>
              </select>
            `;
          } else if (value === "group-added" || value === "group-removed") {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر المجموعة</label>
              <select id="group-select">
                <option value="">اختر المجموعة</option>
                <option value="new-customers">العملاء الجدد</option>
                <option value="vip-customers">عملاء مميزون</option>
                <option value="followup-list">قائمة المتابعة</option>
              </select>
            `;
          } else {
            operatorExtra.style.display = "none";
            operatorExtra.innerHTML = "";
          }
        }

        operatorSelect.addEventListener("change", handleOperatorChange);

        function updateTemplatePreview() {
          const select = document.getElementById("action-template");
          if (!select) return;
          const previewBody = document.getElementById("templatePreviewBody");
          const previewContent = document.getElementById("previewContent");
          if (!previewBody || !previewContent) return;

          const templates = {
            welcome: {
              content: "مرحباً! يسعدنا تواصلك معنا. هذا قالب ترحيبي.",
              buttons: ["زيارة الموقع", "تواصل معنا"],
            },
            followup: {
              content: "متابعة سريعة بخصوص استفسارك السابق. هل لازلت مهتماً؟",
              buttons: ["نعم مهتم", "لاحقاً"],
            },
          };

          const value = select.value;
          const oldButtons = previewContent.querySelector(
            ".wd-preview-buttons"
          );
          if (oldButtons) oldButtons.remove();

          if (value && templates[value]) {
            previewBody.textContent = templates[value].content;
            const buttonsContainer = document.createElement("div");
            buttonsContainer.className = "wd-preview-buttons";
            templates[value].buttons.forEach((b) => {
              const btn = document.createElement("button");
              btn.className = "wd-preview-button";
              btn.textContent = b;
              buttonsContainer.appendChild(btn);
            });
            previewContent.appendChild(buttonsContainer);
          } else {
            previewBody.textContent = "اختر قالب لعرض المعاينة";
          }
        }

        function renderActionDetails(type) {
          const container = document.getElementById("action-details");
          if (type === "text") {
            container.innerHTML = `
              <label>النص</label>
              <textarea id="action-text" placeholder="اكتب الرسالة..."></textarea>
            `;
          } else if (type === "template") {
            container.innerHTML = `
              <div class="wd-message-container">
                <div class="wd-message-form">
                  <label>اختر القالب</label>
                  <select id="action-template">
                    <option value="">اختر القالب</option>
                    <option value="welcome">قالب ترحيب</option>
                    <option value="followup">قالب متابعة</option>
                  </select>
                </div>
                <div class="wd-message-preview">
                  <div class="wd-preview-title">معاينة القالب</div>
                  <div class="wd-template-preview" id="templatePreviewSection">
                    <div class="wd-preview-content" id="previewContent">
                      <div class="wd-preview-message">
                        <div class="wd-preview-body" id="templatePreviewBody">اختر قالب لعرض المعاينة</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            const templateSelect = document.getElementById("action-template");
            if (templateSelect)
              templateSelect.addEventListener("change", updateTemplatePreview);
          } else {
            container.innerHTML = `
              <label>اختر التدفق</label>
              <select id="action-flow">
                <option value="">اختر التدفق</option>
                <option value="welcome-flow">تدفق الترحيب</option>
                <option value="followup-flow">تدفق المتابعة</option>
              </select>
            `;
          }
        }

        // Card selection for action type
        document
          .querySelectorAll("#action-type .wd-message-type-option")
          .forEach((opt) => {
            opt.addEventListener("click", () => {
              document
                .querySelectorAll("#action-type .wd-message-type-option")
                .forEach((o) => o.classList.remove("selected"));
              opt.classList.add("selected");
              const type = opt.getAttribute("data-action-type");
              renderActionDetails(type);
            });
          });

        // تهيئة أولية
        renderActionDetails("text");

        // منطق إظهار حقول التذكير تدريجياً
        const reminderTypeSelect = document.getElementById("reminder-type");
        const reminderUnitGroup = document.getElementById(
          "reminder-unit-group"
        );
        const reminderUnitSelect = document.getElementById("reminder-unit");
        const reminderTimeGroup = document.getElementById(
          "reminder-time-group"
        );

        function toggleReminderUnit() {
          const hasType = reminderTypeSelect && reminderTypeSelect.value !== "";

          // إذا كان النوع "فوراً"، أخفي كلاً من وحدة التذكير ووقت التذكير
          if (
            reminderTypeSelect &&
            reminderTypeSelect.value === "immediately"
          ) {
            if (reminderUnitGroup) reminderUnitGroup.style.display = "none";
            if (reminderTimeGroup) reminderTimeGroup.style.display = "none";
            return;
          }

          // للأنواع الأخرى (قبل الحدث، بعد الحدث)
          if (reminderUnitGroup)
            reminderUnitGroup.style.display = hasType ? "block" : "none";
          if (!hasType && reminderTimeGroup)
            reminderTimeGroup.style.display = "none";
        }

        function toggleReminderTime() {
          const hasUnit = reminderUnitSelect && reminderUnitSelect.value !== "";
          if (!hasUnit || reminderUnitSelect.value === "immediately") {
            if (reminderTimeGroup) reminderTimeGroup.style.display = "none";
          } else {
            if (reminderTimeGroup) reminderTimeGroup.style.display = "block";
          }
        }

        if (reminderTypeSelect)
          reminderTypeSelect.addEventListener("change", toggleReminderUnit);
        if (reminderUnitSelect)
          reminderUnitSelect.addEventListener("change", toggleReminderTime);
        // تهيئة أولية
        toggleReminderUnit();
        toggleReminderTime();
      })();
    </script>
  </body>
</html>
