<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إضافة مشغل جديد</title>
    <link rel="stylesheet" href="../style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .wd-content-body {
        padding: 20px;
        margin: 0 auto;
      }

      .wd-form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 30px;
      }

      .wd-form-header {
        margin-bottom: 30px;
        text-align: center;
      }

      .wd-form-header h2 {
        color: #333;
        margin-bottom: 10px;
      }

      .wd-form-header p {
        color: #666;
        font-size: 14px;
      }

      .wd-form-group {
        margin-bottom: 25px;
      }

      .wd-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .wd-form-group input,
      .wd-form-group select,
      .wd-form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .wd-form-group input:focus,
      .wd-form-group select:focus,
      .wd-form-group textarea:focus {
        outline: none;
        border-color: #25d366;
        box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.1);
      }

      .wd-form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .wd-inline-options {
        display: flex;
        gap: 15px;
      }

      .wd-inline-options label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      /* Action type cards (match new-campaign message type) */
      .wd-message-type {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }

      .wd-message-type-option {
        flex: 1;
        padding: 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        min-height: 80px;
      }

      .wd-message-type-option i {
        color: #4a90e2;
        font-size: 18px;
        margin-top: 2px;
        flex-shrink: 0;
      }

      .wd-message-type-option div {
        flex: 1;
        text-align: right;
      }

      .wd-message-type-option div div {
        font-weight: 500;
        margin-bottom: 4px;
        color: #333;
      }

      .wd-message-type-option small {
        color: #666;
        font-size: 12px;
        line-height: 1.4;
        display: block;
      }

      .wd-message-type-option:hover {
        border-color: #4a90e2;
        background-color: #f8f9fa;
      }

      .wd-message-type-option.selected {
        border-color: #4a90e2;
        background-color: #e9f0f9;
      }

      /* Template preview subset */
      .wd-message-container {
        display: flex;
        flex-direction: row;
        gap: 20px;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .wd-message-form {
        flex: 1;
      }
      .wd-message-preview {
        width: 350px;
      }
      .wd-preview-title {
        font-weight: 500;
        margin-bottom: 10px;
        color: #333;
      }

      .wd-template-preview {
        width: 350px;
        margin: 0 auto;
        background: #e5ddd5;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        height: 400px;
        border: 1px solid #e0e0e0;
      }

      .wd-preview-content {
        flex: 1;
        background: transparent;
        padding: 20px;
        overflow-y: auto;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .wd-preview-message {
        background: #fff;
        border-radius: 7.5px 7.5px 7.5px 0;
        padding: 10px 12px;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        max-width: 85%;
        width: 280px;
        min-height: 45px;
        align-self: flex-start;
        position: relative;
      }
      .wd-preview-message::before {
        content: "";
        position: absolute;
        top: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-top: 8px solid #fff;
        border-left: 8px solid transparent;
      }
      .wd-preview-body {
        font-size: 14px;
        color: #303030;
        line-height: 19px;
        white-space: pre-wrap;
      }
      .wd-preview-buttons {
        margin-top: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
        background: white;
        padding: 0;
        max-width: 85%;
        width: 280px;
        align-self: flex-start;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        border-radius: 0 0 7.5px 7.5px;
        overflow: hidden;
        margin-bottom: 15px;
      }
      .wd-preview-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 10px 12px;
        background: white;
        color: #128c7e;
        border: none;
        border-top: 1px solid #f0f0f0;
        font-size: 14px;
        cursor: pointer;
        font-weight: 500;
        text-align: center;
        outline: none;
      }

      @media (max-width: 992px) {
        .wd-message-container {
          flex-direction: column;
        }
        .wd-message-preview {
          width: 100%;
          max-width: 350px;
          margin: 0 auto;
        }
      }

      .wd-toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .wd-toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .wd-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .wd-toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .wd-toggle-slider {
        background-color: #25d366;
      }

      input:checked + .wd-toggle-slider:before {
        transform: translateX(26px);
      }

      .wd-toggle-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .wd-toggle-container span {
        font-size: 14px;
        color: #666;
      }

      .wd-flow-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wd-flow-selector:hover {
        border-color: #25d366;
        background: #f0f9f0;
      }

      .wd-flow-selector i {
        color: #25d366;
        font-size: 16px;
      }

      .wd-flow-selector span {
        color: #333;
        font-size: 14px;
      }

      .wd-form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .wd-btn-secondary {
        padding: 12px 24px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        color: #666;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .wd-btn-secondary:hover {
        background: #f8f9fa;
        border-color: #ccc;
      }

      .wd-btn-primary {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #25d366;
        color: white;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .wd-btn-primary:hover {
        background: #1ea952;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3);
      }

      .wd-conditions-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .wd-conditions-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .wd-conditions-header i {
        color: #25d366;
        font-size: 16px;
      }

      .wd-conditions-header h4 {
        color: #333;
        margin: 0;
      }

      .wd-condition-item {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }

      .wd-condition-item select {
        flex: 1;
        max-width: 200px;
      }

      .wd-condition-item input {
        flex: 1;
        max-width: 200px;
      }

      .wd-add-condition {
        color: #25d366;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 8px 0;
      }

      .wd-add-condition:hover {
        color: #1ea952;
      }

      /* Text Editor and Formatting Toolbar Styles */
      .wd-text-editor {
        position: relative;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: visible;
      }

      .wd-formatting-toolbar {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        flex-wrap: wrap;
      }

      .wd-toolbar-btn {
        padding: 8px 10px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
      }

      .wd-toolbar-btn:hover {
        background: #e9ecef;
        border-color: #ced4da;
        color: #333;
      }

      .wd-toolbar-btn.active {
        background: #25d366;
        color: white;
        border-color: #25d366;
      }

      .wd-toolbar-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .wd-toolbar-separator {
        width: 1px;
        height: 20px;
        background: #dee2e6;
        margin: 0 4px;
      }

      .wd-textarea-wrapper {
        position: relative;
        overflow: visible;
      }

      .wd-textarea-wrapper textarea {
        width: 100%;
        border: none;
        border-radius: 0;
        resize: vertical;
        min-height: 100px;
        padding: 12px 15px;
        font-size: 14px;
        line-height: 1.5;
        outline: none;
        box-sizing: border-box;
      }

      .wd-textarea-wrapper textarea:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px rgba(37, 211, 102, 0.1);
      }

      /* Variables Dropdown Styles */
      .wd-variables-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 280px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        margin-top: 8px;
        pointer-events: none;
        display: block;
        max-height: 300px;
        overflow-y: auto;
      }

      /* Template Variables Styles */
      .wd-variable-input {
        display: flex;
        gap: 10px;
        position: relative;
      }

      .wd-variable-input input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .wd-variable-input input:focus {
        outline: none;
        border-color: #25d366;
        box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.1);
      }

      .wd-variable-button {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
      }

      .wd-variable-button:hover {
        background-color: #e9ecef;
        color: #333;
      }

      .wd-variable-list {
        position: static;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 5px;
        width: 100%;
        max-width: 300px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        top: 100%;
        right: 0;
        display: none;
      }

      .wd-variable-search {
        padding: 12px;
        border-bottom: 1px solid #eee;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
        position: relative;
      }

      .wd-variable-search input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .wd-variable-search input:focus {
        border-color: #25d366;
        outline: none;
        box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
      }

      .wd-variable-search i {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
      }

      .wd-variable-options {
        max-height: 200px;
        overflow-y: auto;
        padding: 8px 0;
      }

      .wd-variable-option {
        padding: 10px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .wd-variable-option:hover {
        background-color: #f0fff4;
        color: #25d366;
      }

      .wd-variable-option i {
        color: #25d366;
        font-size: 12px;
        width: 16px;
        text-align: center;
      }

      .wd-template-variables {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        border: 1px solid #e0e0e0;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .wd-template-variables h4 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .wd-template-variables h4 i {
        color: #25d366;
      }

      .wd-variable-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 768px) {
        .wd-variable-fields {
          grid-template-columns: 1fr;
        }
      }

      .wd-variables-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
        display: block;
      }

      .wd-variables-dropdown::before {
        content: "";
        position: absolute;
        top: -8px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid white;
      }

      .wd-variables-dropdown::after {
        content: "";
        position: absolute;
        top: -9px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid #e0e0e0;
      }

      .wd-variables-list {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .wd-variable-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 13px;
      }

      .wd-variable-item:hover {
        border-color: #25d366;
        background: #f0fff4;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(37, 211, 102, 0.1);
      }

      .wd-variable-item i {
        color: #25d366;
        font-size: 14px;
        width: 16px;
        text-align: center;
      }

      .wd-variable-item span {
        color: #333;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .wd-content-body {
          padding: 15px;
        }

        .wd-form-container {
          padding: 20px;
        }

        .wd-form-actions {
          flex-direction: column;
        }

        .wd-form-actions .wd-btn {
          width: 100%;
          justify-content: center;
        }

        .wd-formatting-toolbar {
          gap: 1px;
          padding: 6px 8px;
        }

        .wd-toolbar-btn {
          padding: 6px 8px;
          min-width: 28px;
          height: 28px;
          font-size: 12px;
        }

        .wd-variables-dropdown {
          left: 0;
          width: 100%;
          max-width: 280px;
        }
      }
    </style>
  </head>
  <body>
    <!-- القسم الأول: الشريط الجانبي الرئيسي -->
    <aside class="wd-sidebar">
      <div class="wd-logo">
        <img src="../imgs/logo.png" alt="شعار المنصة" />
      </div>
      <nav class="wd-nav">
        <ul>
          <li class="wd-nav-item">
            <i class="fa-solid fa-gauge"></i>
            <span
              ><a href="../index.html" class="wd-nav-link">لوحة التحكم</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-comments"></i>
            <span
              ><a href="../chat.html" class="wd-nav-link">المحادثات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-users"></i>
            <span
              ><a href="../contacts.html" class="wd-nav-link"
                >جهات الاتصال</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-diagram-project"></i>
            <span
              ><a href="../flows.html" class="wd-nav-link">التدفقات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-bullhorn"></i>
            <span
              ><a href="../campaigns.html" class="wd-nav-link">الحملات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-calendar"></i>
            <span
              ><a href="../calendar.html" class="wd-nav-link">التقويم</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-file-alt"></i>
            <span
              ><a href="../contents.html" class="wd-nav-link"
                >المحتويات</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-code"></i>
            <span
              ><a href="../developers.html" class="wd-nav-link"
                >المطورين</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-cog"></i>
            <span
              ><a href="../settings.html" class="wd-nav-link"
                >الإعدادات</a
              ></span
            >
          </li>
        </ul>
      </nav>
    </aside>

    <!-- القسم الثالث: المحتوى الرئيسي -->
    <div class="wd-main-content" style="right: 65px">
      <div class="wd-content-header" style="right: 65px">
        <div class="wd-header-left">
          <button
            class="wd-back-btn"
            onclick="window.location.href='../contents/triggers.html'"
          >
            <i class="fas fa-arrow-right"></i>
          </button>
          <h1>إضافة مشغل جديد</h1>
        </div>
      </div>

      <div class="wd-content-body" style="right: 65px">
        <div class="wd-form-container">
          <form>
            <div class="wd-form-group">
              <label for="trigger-name">اسم المشغل</label>
              <input
                type="text"
                id="trigger-name"
                placeholder="أدخل اسم المشغل..."
                required
              />
            </div>

            <div class="wd-form-group">
              <label for="trigger-operator">نوع المشغل</label>
              <select id="trigger-operator" required>
                <option value="">اختر نوع المشغل</option>
                <option value="tag-added">تم إضافة وسم</option>
                <option value="tag-removed">تم إزالة وسم</option>
                <option value="group-added">تم إضافة الى مجموعة</option>
                <option value="group-removed">تم إزالة من مجموعة</option>
              </select>
            </div>

            <div
              id="operator-extra"
              class="wd-form-group"
              style="display: none"
            ></div>

            <div class="wd-form-group">
              <label for="reminder-type">نوع التذكير</label>
              <select id="reminder-type">
                <option value="">اختر نوع التذكير</option>
                <option value="immediately">فوراً</option>
                <option value="before">قبل الحدث</option>
                <option value="after">بعد الحدث</option>
              </select>
            </div>

            <div
              class="wd-form-group"
              id="reminder-unit-group"
              style="display: none"
            >
              <label for="reminder-unit">وحدة التذكير</label>
              <select id="reminder-unit">
                <option value="">اختر وحدة التذكير</option>
                <option value="minutes">دقائق</option>
                <option value="hours">ساعات</option>
                <option value="days">أيام</option>
              </select>
            </div>

            <div
              class="wd-form-group"
              id="reminder-time-group"
              style="display: none"
            >
              <label for="reminder-time">وقت التذكير</label>
              <input
                type="number"
                id="reminder-time"
                min="1"
                placeholder="أدخل القيمة"
              />
            </div>

            <div class="wd-form-group">
              <label>نوع الإجراء</label>
              <div class="wd-message-type" id="action-type">
                <div
                  class="wd-message-type-option selected"
                  data-action-type="text"
                >
                  <i class="fas fa-align-left"></i>
                  <div>
                    <div>نص</div>
                    <small
                      >في حال تكون المحادثة مفتوحة او لم يمر عليها 24
                      ساعة</small
                    >
                  </div>
                </div>
                <div class="wd-message-type-option" data-action-type="template">
                  <i class="fas fa-envelope-open-text"></i>
                  <div>
                    <div>قالب</div>
                    <small
                      >في حال تكون المحادثة مغلقة او مر عليها 24 ساعة</small
                    >
                  </div>
                </div>
                <div class="wd-message-type-option" data-action-type="flow">
                  <i class="fa-solid fa-diagram-project"></i>
                  <div>
                    <div>تدفق</div>
                    <small
                      >اختيار روبوت دردشة, نصوص, قوالب وخيارات متعددة</small
                    >
                  </div>
                </div>
              </div>
            </div>

            <div class="wd-form-group" id="action-details"></div>

            <div class="wd-form-group">
              <div class="wd-toggle-container">
                <label class="wd-toggle-switch">
                  <input type="checkbox" checked />
                  <span class="wd-toggle-slider"></span>
                </label>
                <span>تفعيل المشغل فوراً</span>
              </div>
            </div>

            <div class="wd-form-actions">
              <a href="../contents/triggers.html" class="wd-btn-secondary">
                <i class="fas fa-times"></i>
                إلغاء
              </a>
              <button type="submit" class="wd-btn-primary">
                <i class="fas fa-save"></i>
                حفظ المشغل
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="../script.js"></script>
    <script>
      (function () {
        const operatorSelect = document.getElementById("trigger-operator");
        const operatorExtra = document.getElementById("operator-extra");

        function handleOperatorChange() {
          const value = operatorSelect.value;
          if (!value) {
            operatorExtra.style.display = "none";
            operatorExtra.innerHTML = "";
            return;
          }

          if (value === "tag-added" || value === "tag-removed") {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر الوسم</label>
              <select id="tag-select">
                <option value="">اختر الوسم</option>
                <option value="vip">VIP</option>
                <option value="interested">مهتم</option>
                <option value="followup">متابعة</option>
              </select>
            `;
          } else if (value === "group-added" || value === "group-removed") {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر المجموعة</label>
              <select id="group-select">
                <option value="">اختر المجموعة</option>
                <option value="new-customers">العملاء الجدد</option>
                <option value="vip-customers">عملاء مميزون</option>
                <option value="followup-list">قائمة المتابعة</option>
              </select>
            `;
          } else {
            operatorExtra.style.display = "none";
            operatorExtra.innerHTML = "";
          }
        }

        operatorSelect.addEventListener("change", handleOperatorChange);

        function updateTemplatePreview() {
          const select = document.getElementById("action-template");
          if (!select) return;
          const previewBody = document.getElementById("templatePreviewBody");
          const previewContent = document.getElementById("previewContent");
          if (!previewBody || !previewContent) return;

          const templates = {
            welcome: {
              content:
                "مرحباً {{contact_name}}! يسعدنا تواصلك معنا. هذا قالب ترحيبي من {{company_name}}.",
              buttons: ["زيارة الموقع", "تواصل معنا"],
            },
            followup: {
              content:
                "متابعة سريعة بخصوص استفسارك السابق حول {{product_name}}. هل لازلت مهتماً؟",
              buttons: ["نعم مهتم", "لاحقاً"],
            },
            custom: {
              content:
                "مرحباً {{contact_name}}! شكراً لاهتمامك بـ {{service_name}}. يمكنك التواصل معنا على {{contact_phone}} أو {{contact_email}}.",
              buttons: ["احجز الآن", "استفسار"],
            },
          };

          const value = select.value;
          const oldButtons = previewContent.querySelector(
            ".wd-preview-buttons"
          );
          if (oldButtons) oldButtons.remove();

          if (value && templates[value]) {
            let content = templates[value].content;

            // استبدال المتغيرات بالقيم المدخلة
            if (value === "custom") {
              const var1 =
                document.getElementById("template-var1")?.value ||
                "{{contact_name}}";
              const var2 =
                document.getElementById("template-var2")?.value ||
                "{{service_name}}";

              content = content
                .replace("{{contact_name}}", var1)
                .replace("{{service_name}}", var2)
                .replace("{{contact_phone}}", "{{contact_phone}}")
                .replace("{{contact_email}}", "{{contact_email}}");
            } else {
              // استبدال المتغيرات الافتراضية
              content = content
                .replace("{{contact_name}}", "اسم العميل")
                .replace("{{company_name}}", "اسم الشركة")
                .replace("{{product_name}}", "اسم المنتج")
                .replace("{{service_name}}", "اسم الخدمة")
                .replace("{{contact_phone}}", "رقم الهاتف")
                .replace("{{contact_email}}", "البريد الإلكتروني");
            }

            previewBody.textContent = content;

            if (
              templates[value].buttons &&
              templates[value].buttons.length > 0
            ) {
              const buttonsContainer = document.createElement("div");
              buttonsContainer.className = "wd-preview-buttons";
              templates[value].buttons.forEach((b) => {
                const btn = document.createElement("button");
                btn.className = "wd-preview-button";
                btn.textContent = b;
                buttonsContainer.appendChild(btn);
              });
              previewContent.appendChild(buttonsContainer);
            }
          } else {
            previewBody.textContent = "اختر قالب لعرض المعاينة";
          }
        }

        function renderActionDetails(type) {
          const container = document.getElementById("action-details");
          if (type === "text") {
            container.innerHTML = `
               <label>النص</label>
               <div class="wd-text-editor">
                 <div class="wd-formatting-toolbar">
                   <button type="button" class="wd-toolbar-btn" id="bold-btn" title="عريض">
                     <i class="fas fa-bold"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="italic-btn" title="مائل">
                     <i class="fas fa-italic"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="link-btn" title="إدراج رابط">
                     <i class="fas fa-link"></i>
                   </button>
                   <div class="wd-toolbar-separator"></div>
                   <button type="button" class="wd-toolbar-btn" id="undo-btn" title="تراجع">
                     <i class="fas fa-undo"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="redo-btn" title="إعادة">
                     <i class="fas fa-redo"></i>
                   </button>
                   <div class="wd-toolbar-separator"></div>
                   <button type="button" class="wd-toolbar-btn" id="list-btn" title="قائمة">
                     <i class="fas fa-list"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="variables-btn" title="إضافة متغير">
                     <i class="fas fa-code"></i>
                   </button>
                 </div>
                 <div class="wd-textarea-wrapper">
                   <textarea id="action-text" placeholder="اكتب الرسالة..."></textarea>
                 </div>
                 <div class="wd-variables-dropdown" id="variables-dropdown">
                   <div class="wd-variables-list">
                     <div class="wd-variable-item" data-variable="{{contact_name}}">
                       <i class="fas fa-user"></i>
                       <span>اسم جهة الاتصال</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{contact_phone}}">
                       <i class="fas fa-phone"></i>
                       <span>رقم الهاتف</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{contact_email}}">
                       <i class="fas fa-envelope"></i>
                       <span>البريد الإلكتروني</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{company_name}}">
                       <i class="fas fa-building"></i>
                       <span>اسم الشركة</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{current_date}}">
                       <i class="fas fa-calendar"></i>
                       <span>التاريخ الحالي</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{current_time}}">
                       <i class="fas fa-clock"></i>
                       <span>الوقت الحالي</span>
                     </div>
                   </div>
                 </div>
               </div>
             `;

            // إضافة event listeners لشريط الأدوات
            initializeToolbar();

            // إضافة event listeners للمتغيرات
            setupVariablesDropdown();
          } else if (type === "template") {
            container.innerHTML = `
               <div class="wd-message-container">
                 <div class="wd-message-form">
                   <label>اختر القالب</label>
                   <select id="action-template">
                     <option value="">اختر القالب</option>
                     <option value="welcome">قالب ترحيب</option>
                     <option value="followup">قالب متابعة</option>
                     <option value="custom">قالب مخصص</option>
                   </select>
                   
                   <div class="wd-template-variables" id="template-variables" style="display: none;">
                     <h4><i class="fas fa-cogs"></i> متغيرات القالب</h4>
                     <div class="wd-variable-fields">
                       <div class="wd-form-group">
                         <label for="template-var1">المتغير الأول</label>
                         <div class="wd-variable-input">
                           <input
                             type="text"
                             id="template-var1"
                             class="wd-form-control"
                             placeholder="أدخل المتغير الأول أو اختر من القائمة"
                           />
                           <button
                             type="button"
                             class="wd-variable-button"
                             onclick="showVariableList('template-var1')"
                           >
                             <i class="fas fa-list"></i>
                           </button>
                         </div>
                         <div class="wd-variable-list" id="template-var1List">
                           <div class="wd-variable-search">
                             <input
                               type="text"
                               placeholder="ابحث عن متغير..."
                               oninput="searchVariables('template-var1', this.value)"
                             />
                             <i class="fas fa-search"></i>
                           </div>
                           <div class="wd-variable-options">
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'اسم العميل', '{{contact_name}}')">
                               <i class="fas fa-user"></i>
                               اسم العميل
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'اسم الشركة', '{{company_name}}')">
                               <i class="fas fa-building"></i>
                               اسم الشركة
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'المنتج', '{{product_name}}')">
                               <i class="fas fa-box"></i>
                               المنتج
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'الخدمة', '{{service_name}}')">
                               <i class="fas fa-cogs"></i>
                               الخدمة
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'التاريخ', '{{current_date}}')">
                               <i class="fas fa-calendar"></i>
                               التاريخ
                             </div>
                           </div>
                         </div>
                       </div>
                       
                       <div class="wd-form-group">
                         <label for="template-var2">المتغير الثاني</label>
                         <div class="wd-variable-input">
                           <input
                             type="text"
                             id="template-var2"
                             class="wd-form-control"
                             placeholder="أدخل المتغير الثاني أو اختر من القائمة"
                           />
                           <button
                             type="button"
                             class="wd-variable-button"
                             onclick="showVariableList('template-var2')"
                           >
                             <i class="fas fa-list"></i>
                           </button>
                         </div>
                         <div class="wd-variable-list" id="template-var2List">
                           <div class="wd-variable-search">
                             <input
                               type="text"
                               placeholder="ابحث عن متغير..."
                               oninput="searchVariables('template-var2', this.value)"
                             />
                             <i class="fas fa-search"></i>
                           </div>
                           <div class="wd-variable-options">
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'رقم الهاتف', '{{contact_phone}}')">
                               <i class="fas fa-phone"></i>
                               رقم الهاتف
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'البريد الإلكتروني', '{{contact_email}}')">
                               <i class="fas fa-envelope"></i>
                               البريد الإلكتروني
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'السعر', '{{price}}')">
                               <i class="fas fa-tag"></i>
                               السعر
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'الوقت', '{{current_time}}')">
                               <i class="fas fa-clock"></i>
                               الوقت
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'الموقع', '{{location}}')">
                               <i class="fas fa-map-marker-alt"></i>
                               الموقع
                             </div>
                           </div>
                         </div>
                       </div>
                     </div>
                   </div>
                 </div>
                 <div class="wd-message-preview">
                   <div class="wd-preview-title">معاينة القالب</div>
                   <div class="wd-template-preview" id="templatePreviewSection">
                     <div class="wd-preview-content" id="previewContent">
                       <div class="wd-preview-message">
                         <div class="wd-preview-body" id="templatePreviewBody">اختر قالب لعرض المعاينة</div>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>
             `;
            const templateSelect = document.getElementById("action-template");
            if (templateSelect) {
              templateSelect.addEventListener("change", updateTemplatePreview);
              templateSelect.addEventListener(
                "change",
                toggleTemplateVariables
              );
            }

            // إضافة event listeners لحقول المتغيرات
            const var1Input = document.getElementById("template-var1");
            const var2Input = document.getElementById("template-var2");

            if (var1Input) {
              var1Input.addEventListener("input", updateTemplatePreview);
            }
            if (var2Input) {
              var2Input.addEventListener("input", updateTemplatePreview);
            }
          } else {
            container.innerHTML = `
              <label>اختر التدفق</label>
              <select id="action-flow">
                <option value="">اختر التدفق</option>
                <option value="welcome-flow">تدفق الترحيب</option>
                <option value="followup-flow">تدفق المتابعة</option>
              </select>
            `;
          }
        }

        // Card selection for action type
        document
          .querySelectorAll("#action-type .wd-message-type-option")
          .forEach((opt) => {
            opt.addEventListener("click", () => {
              document
                .querySelectorAll("#action-type .wd-message-type-option")
                .forEach((o) => o.classList.remove("selected"));
              opt.classList.add("selected");
              const type = opt.getAttribute("data-action-type");
              renderActionDetails(type);
            });
          });

        // تهيئة أولية
        renderActionDetails("text");

        // منطق إظهار حقول التذكير تدريجياً
        const reminderTypeSelect = document.getElementById("reminder-type");
        const reminderUnitGroup = document.getElementById(
          "reminder-unit-group"
        );
        const reminderUnitSelect = document.getElementById("reminder-unit");
        const reminderTimeGroup = document.getElementById(
          "reminder-time-group"
        );

        function toggleReminderUnit() {
          const hasType = reminderTypeSelect && reminderTypeSelect.value !== "";

          // إذا كان النوع "فوراً"، أخفي كلاً من وحدة التذكير ووقت التذكير
          if (
            reminderTypeSelect &&
            reminderTypeSelect.value === "immediately"
          ) {
            if (reminderUnitGroup) reminderUnitGroup.style.display = "none";
            if (reminderTimeGroup) reminderTimeGroup.style.display = "none";
            return;
          }

          // للأنواع الأخرى (قبل الحدث، بعد الحدث)
          if (reminderUnitGroup)
            reminderUnitGroup.style.display = hasType ? "block" : "none";
          if (!hasType && reminderTimeGroup)
            reminderTimeGroup.style.display = "none";
        }

        function toggleReminderTime() {
          const hasUnit = reminderUnitSelect && reminderUnitSelect.value !== "";
          if (!hasUnit || reminderUnitSelect.value === "immediately") {
            if (reminderTimeGroup) reminderTimeGroup.style.display = "none";
          } else {
            if (reminderTimeGroup) reminderTimeGroup.style.display = "block";
          }
        }

        if (reminderTypeSelect)
          reminderTypeSelect.addEventListener("change", toggleReminderUnit);
        if (reminderUnitSelect)
          reminderUnitSelect.addEventListener("change", toggleReminderTime);
        // تهيئة أولية
        toggleReminderUnit();
        toggleReminderTime();

        // دوال إدارة متغيرات القوالب
        function toggleTemplateVariables() {
          const templateSelect = document.getElementById("action-template");
          const variablesSection =
            document.getElementById("template-variables");

          if (templateSelect && variablesSection) {
            if (templateSelect.value === "custom") {
              variablesSection.style.display = "block";
            } else {
              variablesSection.style.display = "none";
            }
            updateTemplatePreview();
          }
        }

        // وظائف المتغيرات
        window.showVariableList = function (variableId) {
          const list = document.getElementById(variableId + "List");
          if (list) {
            list.style.display =
              list.style.display === "none" ? "block" : "none";
          }
        };

        window.searchVariables = function (variableId, searchTerm) {
          const options = document.querySelectorAll(
            `#${variableId}List .wd-variable-option`
          );
          searchTerm = searchTerm.toLowerCase();

          options.forEach((option) => {
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(searchTerm) ? "block" : "none";
          });
        };

        window.selectVariable = function (
          variableId,
          displayText,
          variableCode
        ) {
          const input = document.getElementById(variableId);
          const list = document.getElementById(variableId + "List");

          if (input) {
            input.value = displayText;
          }
          if (list) {
            list.style.display = "none";
          }

          // تحديث المعاينة إذا كان القالب المخصص محدد
          const templateSelect = document.getElementById("action-template");
          if (templateSelect && templateSelect.value === "custom") {
            updateTemplatePreview();
          }
        };

        // إغلاق قوائم المتغيرات عند النقر خارجها
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".wd-variable-input")) {
            document.querySelectorAll(".wd-variable-list").forEach((list) => {
              list.style.display = "none";
            });
          }
        });

        // دالة إعداد قائمة المتغيرات المنسدلة
        function setupVariablesDropdown() {
          setTimeout(() => {
            const variablesBtn = document.getElementById("variables-btn");
            const variablesDropdown =
              document.getElementById("variables-dropdown");

            console.log(
              "Setting up variables dropdown...",
              variablesBtn,
              variablesDropdown
            );

            if (variablesBtn && variablesDropdown) {
              // إضافة event listener للزر
              variablesBtn.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("Variables button clicked!");

                const isVisible = variablesDropdown.classList.contains("show");
                console.log("Dropdown is currently visible:", isVisible);

                if (isVisible) {
                  variablesDropdown.classList.remove("show");
                  console.log("Hiding dropdown");
                } else {
                  variablesDropdown.classList.add("show");
                  console.log("Showing dropdown");
                }
              });

              // إضافة event listeners للمتغيرات
              document.querySelectorAll(".wd-variable-item").forEach((item) => {
                item.addEventListener("click", function (e) {
                  e.preventDefault();
                  e.stopPropagation();

                  const variable = this.getAttribute("data-variable");
                  const textarea = document.getElementById("action-text");

                  if (textarea && variable) {
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const textAfter = textarea.value.substring(cursorPos);
                    textarea.value = textBefore + variable + textAfter;

                    // تحديث موضع المؤشر
                    const newCursorPos = cursorPos + variable.length;
                    textarea.setSelectionRange(newCursorPos, newCursorPos);
                    textarea.focus();

                    // إغلاق القائمة
                    variablesDropdown.classList.remove("show");
                  }
                });
              });

              // إغلاق القائمة عند النقر خارجها
              document.addEventListener("click", function (e) {
                if (
                  !variablesBtn.contains(e.target) &&
                  !variablesDropdown.contains(e.target)
                ) {
                  variablesDropdown.classList.remove("show");
                }
              });
            }
          }, 100);
        }

        // دالة تهيئة شريط الأدوات
        function initializeToolbar() {
          const textarea = document.getElementById("action-text");
          const boldBtn = document.getElementById("bold-btn");
          const italicBtn = document.getElementById("italic-btn");
          const linkBtn = document.getElementById("link-btn");
          const undoBtn = document.getElementById("undo-btn");
          const redoBtn = document.getElementById("redo-btn");
          const listBtn = document.getElementById("list-btn");

          let undoStack = [];
          let redoStack = [];
          let lastValue = "";

          // حفظ الحالة للتراجع
          function saveState() {
            if (textarea.value !== lastValue) {
              undoStack.push(lastValue);
              redoStack = [];
              lastValue = textarea.value;
            }
          }

          // تطبيق التنسيق
          function applyFormatting(format) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (selectedText) {
              let formattedText = "";
              switch (format) {
                case "bold":
                  formattedText = `**${selectedText}**`;
                  break;
                case "italic":
                  formattedText = `*${selectedText}*`;
                  break;
                case "link":
                  const url = prompt("أدخل الرابط:");
                  if (url) {
                    formattedText = `[${selectedText}](${url})`;
                  } else {
                    return;
                  }
                  break;
                case "list":
                  const lines = selectedText.split("\n");
                  formattedText = lines.map((line) => `• ${line}`).join("\n");
                  break;
              }

              saveState();
              textarea.value =
                textarea.value.substring(0, start) +
                formattedText +
                textarea.value.substring(end);
              textarea.setSelectionRange(start, start + formattedText.length);
              textarea.focus();
            }
          }

          // تراجع
          function undo() {
            if (undoStack.length > 0) {
              redoStack.push(textarea.value);
              textarea.value = undoStack.pop();
              lastValue = textarea.value;
            }
          }

          // إعادة
          function redo() {
            if (redoStack.length > 0) {
              undoStack.push(textarea.value);
              textarea.value = redoStack.pop();
              lastValue = textarea.value;
            }
          }

          // Event listeners
          if (boldBtn) {
            boldBtn.addEventListener("click", () => applyFormatting("bold"));
          }

          if (italicBtn) {
            italicBtn.addEventListener("click", () =>
              applyFormatting("italic")
            );
          }

          if (linkBtn) {
            linkBtn.addEventListener("click", () => applyFormatting("link"));
          }

          if (undoBtn) {
            undoBtn.addEventListener("click", undo);
          }

          if (redoBtn) {
            redoBtn.addEventListener("click", redo);
          }

          if (listBtn) {
            listBtn.addEventListener("click", () => applyFormatting("list"));
          }

          // حفظ الحالة عند الكتابة
          if (textarea) {
            textarea.addEventListener("input", saveState);
            textarea.addEventListener("keydown", function (e) {
              if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                  case "z":
                    if (e.shiftKey) {
                      e.preventDefault();
                      redo();
                    } else {
                      e.preventDefault();
                      undo();
                    }
                    break;
                  case "y":
                    e.preventDefault();
                    redo();
                    break;
                }
              }
            });
          }
        }
      })();
    </script>
  </body>
</html>
