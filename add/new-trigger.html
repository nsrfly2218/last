<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إضافة مشغل جديد</title>
    <link rel="stylesheet" href="../style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .wd-content-body {
        padding: 20px;
        margin: 0 auto;
      }

      .wd-form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 30px;
      }

      .wd-form-header {
        margin-bottom: 30px;
        text-align: center;
      }

      .wd-form-header h2 {
        color: #333;
        margin-bottom: 10px;
      }

      .wd-form-header p {
        color: #666;
        font-size: 14px;
      }

      .wd-form-group {
        margin-bottom: 25px;
      }

      .wd-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .wd-form-group input,
      .wd-form-group select,
      .wd-form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .wd-form-group input:focus,
      .wd-form-group select:focus,
      .wd-form-group textarea:focus {
        outline: none;
        border-color: #25d366;
        box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.1);
      }

      .wd-form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .wd-inline-options {
        display: flex;
        gap: 15px;
      }

      .wd-inline-options label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      /* Action type cards (match new-campaign message type) */
      .wd-message-type {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }

      .wd-message-type-option {
        flex: 1;
        padding: 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        min-height: 80px;
      }

      .wd-message-type-option i {
        color: #4a90e2;
        font-size: 18px;
        margin-top: 2px;
        flex-shrink: 0;
      }

      .wd-message-type-option div {
        flex: 1;
        text-align: right;
      }

      .wd-message-type-option div div {
        font-weight: 500;
        margin-bottom: 4px;
        color: #333;
      }

      .wd-message-type-option small {
        color: #666;
        font-size: 12px;
        line-height: 1.4;
        display: block;
      }

      .wd-message-type-option:hover {
        border-color: #4a90e2;
        background-color: #f8f9fa;
      }

      .wd-message-type-option.selected {
        border-color: #4a90e2;
        background-color: #e9f0f9;
      }

      /* Template preview subset */
      .wd-message-container {
        display: flex;
        flex-direction: row;
        gap: 20px;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .wd-message-form {
        flex: 1;
      }
      .wd-message-preview {
        width: 350px;
      }
      .wd-preview-title {
        font-weight: 500;
        margin-bottom: 10px;
        color: #333;
      }

      .wd-template-preview {
        width: 350px;
        margin: 0 auto;
        background: #e5ddd5;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        height: 400px;
        border: 1px solid #e0e0e0;
      }

      .wd-preview-content {
        flex: 1;
        background: transparent;
        padding: 20px;
        overflow-y: auto;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .wd-preview-message {
        background: #fff;
        border-radius: 7.5px 7.5px 7.5px 0;
        padding: 10px 12px;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        max-width: 85%;
        width: 280px;
        min-height: 45px;
        align-self: flex-start;
        position: relative;
      }
      .wd-preview-message::before {
        content: "";
        position: absolute;
        top: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-top: 8px solid #fff;
        border-left: 8px solid transparent;
      }
      .wd-preview-body {
        font-size: 14px;
        color: #303030;
        line-height: 19px;
        white-space: pre-wrap;
      }
      .wd-preview-buttons {
        margin-top: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
        background: white;
        padding: 0;
        max-width: 85%;
        width: 280px;
        align-self: flex-start;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        border-radius: 0 0 7.5px 7.5px;
        overflow: hidden;
        margin-bottom: 15px;
      }
      .wd-preview-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 10px 12px;
        background: white;
        color: #128c7e;
        border: none;
        border-top: 1px solid #f0f0f0;
        font-size: 14px;
        cursor: pointer;
        font-weight: 500;
        text-align: center;
        outline: none;
      }

      @media (max-width: 992px) {
        .wd-message-container {
          flex-direction: column;
        }
        .wd-message-preview {
          width: 100%;
          max-width: 350px;
          margin: 0 auto;
        }
      }

      .wd-toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .wd-toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .wd-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .wd-toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .wd-toggle-slider {
        background-color: #25d366;
      }

      input:checked + .wd-toggle-slider:before {
        transform: translateX(26px);
      }

      .wd-toggle-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .wd-toggle-container span {
        font-size: 14px;
        color: #666;
      }

      .wd-flow-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wd-flow-selector:hover {
        border-color: #25d366;
        background: #f0f9f0;
      }

      .wd-flow-selector i {
        color: #25d366;
        font-size: 16px;
      }

      .wd-flow-selector span {
        color: #333;
        font-size: 14px;
      }

      /* أنماط الاختيار المتعدد مثل صفحة new-contact.html */
      .wd-group-search {
        position: relative;
      }

      .wd-group-list {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .wd-group-item {
        padding: 12px 16px;
        cursor: pointer;
        color: #333;
        font-weight: 500;
        transition: all 0.2s ease;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .wd-group-item:last-child {
        border-bottom: none;
      }

      .wd-group-item:hover {
        background: #e9ecef;
      }

      .wd-group-item.selected {
        background: #e8f5e8;
        color: #2e7d32;
        border-left: 3px solid #2e7d32;
      }

      .wd-group-item.selected::after {
        content: "✓";
        color: #2e7d32;
        font-weight: bold;
        font-size: 16px;
      }

      .wd-group-search input:focus + .wd-group-list {
        display: block;
      }

      .wd-selected-groups {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
        min-height: 20px;
      }

      .wd-selected-group-tag {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: 1px solid #a5d6a7;
      }

      .wd-selected-group-tag .remove-btn {
        background: none;
        border: none;
        color: #2e7d32;
        cursor: pointer;
        font-size: 14px;
        padding: 0;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s ease;
      }

      .wd-selected-group-tag .remove-btn:hover {
        background: #2e7d32;
        color: white;
      }

      /* أنماط قسم الإجراءات الجديد */
      .wd-actions-container {
        margin-bottom: 20px;
      }

      .wd-action-item {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
      }

      .wd-action-row {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .wd-action-selector {
        flex: 1;
      }

      .wd-action-selector select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        font-size: 14px;
      }

      .wd-action-options {
        flex: 1;
      }

      .wd-action-option-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        font-size: 14px;
      }

      .wd-remove-action-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 12px;
        cursor: pointer;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
      }

      .wd-remove-action-btn:hover {
        background: #c82333;
      }

      .wd-add-action-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 12px 20px;
        cursor: pointer;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .wd-add-action-btn:hover {
        background: #218838;
      }

      /* أنماط قسم الرسالة */
      .wd-message-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .wd-message-form .wd-form-group {
        margin-bottom: 15px;
      }

      .wd-message-form .wd-form-group:last-child {
        margin-bottom: 0;
      }

      .wd-message-form textarea {
        resize: vertical;
        min-height: 100px;
      }

      /* تنسيق الحقول بجانب بعضها البعض */
      .wd-form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .wd-form-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 280px;
      }

      /* تنسيق ذكي للحقول */
      .wd-form-row.auto-fit {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }

      /* تنسيق خاص للحقول القصيرة */
      .wd-form-row.compact {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .wd-form-col .wd-form-group {
        margin-bottom: 0;
      }

      /* عداد الحروف */
      .wd-char-counter {
        text-align: left;
        margin-top: 5px;
        font-size: 12px;
        color: #666;
        direction: ltr;
      }

      .wd-char-counter span {
        font-weight: 600;
        color: #4a90e2;
      }

      .wd-char-counter.warning span {
        color: #ff9800;
      }

      .wd-char-counter.danger span {
        color: #f44336;
      }

      /* أنماط قسم الرسالة المنفصل */
      .wd-message-type {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }

      .wd-message-type-option {
        flex: 1;
        padding: 20px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .wd-message-type-option:hover {
        border-color: #4a90e2;
        background: #f8f9ff;
      }

      .wd-message-type-option.selected {
        border-color: #4a90e2;
        background: #e8f4fd;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
      }

      .wd-message-type-option i {
        font-size: 24px;
        color: #4a90e2;
        min-width: 24px;
      }

      .wd-message-type-option div {
        flex: 1;
      }

      .wd-message-type-option div div {
        font-weight: 600;
        font-size: 16px;
        color: #333;
        margin-bottom: 5px;
      }

      .wd-message-type-option small {
        color: #666;
        font-size: 12px;
        line-height: 1.4;
      }

      /* تنسيق خاص لحقول التذكير */
      #reminder-unit-col,
      #reminder-time-col {
        transition: all 0.3s ease;
      }

      /* تنسيق متجاوب للحقول */
      @media screen and (max-width: 768px) {
        .wd-form-row {
          flex-direction: column;
          gap: 0;
        }

        .wd-form-col {
          margin-bottom: 24px;
        }

        .wd-form-col:last-child {
          margin-bottom: 0;
        }

        /* حقول التذكير تتكيف مع الشاشات الصغيرة */
        #reminder-unit-col,
        #reminder-time-col {
          margin-bottom: 24px;
        }

        #reminder-time-col:last-child {
          margin-bottom: 0;
        }
      }

      @media screen and (min-width: 769px) and (max-width: 1024px) {
        .wd-form-row {
          gap: 15px;
        }
      }

      /* تنسيق محسن للشاشات الكبيرة */
      @media screen and (min-width: 1200px) {
        .wd-form-row {
          gap: 30px;
        }

        .wd-form-col {
          min-width: 300px;
        }
      }

      /* تنسيق خاص لحقول الإجراءات */
      .wd-actions-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      /* تنسيق متجاوب للإجراءات */
      @media screen and (min-width: 768px) {
        .wd-action-row {
          display: grid;
          grid-template-columns: 1fr 1fr auto;
          gap: 15px;
          align-items: center;
        }
      }

      @media screen and (max-width: 767px) {
        .wd-action-row {
          display: flex;
          flex-direction: column;
          gap: 15px;
        }

        .wd-remove-action-btn {
          align-self: flex-end;
        }
      }

      /* تحسين تنسيق أزرار الإجراءات */
      .wd-add-action-btn {
        width: 100%;
        justify-content: center;
      }

      @media screen and (min-width: 480px) {
        .wd-add-action-btn {
          width: auto;
          align-self: flex-start;
        }
      }

      /* تنسيق خيارات الراديو للمستقبل */
      .wd-recipient-options {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }

      /* تنسيق خاص لخيارات المستقبل */
      .wd-recipient-options .wd-message-type-option {
        cursor: pointer;
      }

      .wd-recipient-options .wd-message-type-option i {
        font-size: 20px;
        color: #4a90e2;
      }

      /* تنسيق حقل رقم الجوال المخصص */
      #custom-phone-field {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      #custom-phone-field label {
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      /* تنسيق رفع صورة القالب */
      .wd-template-image-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .wd-image-upload-container {
        margin-top: 10px;
      }

      .wd-image-preview {
        height: 150px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
        overflow: hidden;
      }

      .wd-image-preview:hover {
        border-color: #4a90e2;
        background: #f8f9ff;
      }

      .wd-image-preview.has-image {
        border-style: solid;
        padding: 0;
      }

      .wd-image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
      }

      .wd-image-preview i {
        font-size: 32px;
        color: #4a90e2;
        margin-bottom: 10px;
      }

      .wd-image-preview p {
        margin: 0;
        color: #666;
        font-size: 14px;
        text-align: center;
      }

      .wd-remove-image-btn {
        margin-top: 10px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s ease;
      }

      .wd-remove-image-btn:hover {
        background: #c82333;
      }

      /* تنسيق قسم الرسالة */
      @media screen and (min-width: 768px) {
        .wd-message-type {
          gap: 20px;
        }
      }

      @media screen and (min-width: 1024px) {
        .wd-message-type {
          gap: 25px;
        }
      }

      /* تنسيق متجاوب لخيارات الراديو */
      @media screen and (max-width: 768px) {
        .wd-recipient-options {
          flex-direction: column;
          gap: 15px;
        }

        .wd-image-preview {
          width: 100%;
          max-width: 200px;
          height: 120px;
        }

        .wd-template-image-section {
          padding: 10px;
        }
      }

      .wd-form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .wd-btn-secondary {
        padding: 12px 24px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        color: #666;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .wd-btn-secondary:hover {
        background: #f8f9fa;
        border-color: #ccc;
      }

      .wd-btn-primary {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #25d366;
        color: white;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .wd-btn-primary:hover {
        background: #1ea952;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3);
      }

      .wd-conditions-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .wd-conditions-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .wd-conditions-header i {
        color: #25d366;
        font-size: 16px;
      }

      .wd-conditions-header h4 {
        color: #333;
        margin: 0;
      }

      .wd-condition-item {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }

      .wd-condition-item select {
        flex: 1;
        max-width: 200px;
      }

      .wd-condition-item input {
        flex: 1;
        max-width: 200px;
      }

      .wd-add-condition {
        color: #25d366;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 8px 0;
      }

      .wd-add-condition:hover {
        color: #1ea952;
      }

      /* Text Editor and Formatting Toolbar Styles */
      .wd-text-editor {
        position: relative;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: visible;
      }

      .wd-formatting-toolbar {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        flex-wrap: wrap;
      }

      .wd-toolbar-btn {
        padding: 8px 10px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
      }

      .wd-toolbar-btn:hover {
        background: #e9ecef;
        border-color: #ced4da;
        color: #333;
      }

      .wd-toolbar-btn.active {
        background: #25d366;
        color: white;
        border-color: #25d366;
      }

      .wd-toolbar-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .wd-toolbar-separator {
        width: 1px;
        height: 20px;
        background: #dee2e6;
        margin: 0 4px;
      }

      .wd-textarea-wrapper {
        position: relative;
        overflow: visible;
      }

      .wd-textarea-wrapper textarea {
        width: 100%;
        border: none;
        border-radius: 0;
        resize: vertical;
        min-height: 100px;
        padding: 12px 15px;
        font-size: 14px;
        line-height: 1.5;
        outline: none;
        box-sizing: border-box;
      }

      .wd-textarea-wrapper textarea:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px rgba(37, 211, 102, 0.1);
      }

      /* Variables Dropdown Styles */
      .wd-variables-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 280px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        margin-top: 8px;
        pointer-events: none;
        display: block;
        max-height: 300px;
        overflow-y: auto;
      }

      /* Template Variables Styles */
      .wd-variable-input {
        display: flex;
        gap: 10px;
        position: relative;
      }

      .wd-variable-input input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .wd-variable-input input:focus {
        outline: none;
        border-color: #25d366;
        box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.1);
      }

      .wd-variable-button {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
      }

      .wd-variable-button:hover {
        background-color: #e9ecef;
        color: #333;
      }

      .wd-variable-list {
        position: static;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 5px;
        width: 100%;
        max-width: 300px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        top: 100%;
        right: 0;
        display: none;
      }

      .wd-variable-search {
        padding: 12px;
        border-bottom: 1px solid #eee;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
        position: relative;
      }

      .wd-variable-search input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .wd-variable-search input:focus {
        border-color: #25d366;
        outline: none;
        box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
      }

      .wd-variable-search i {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
      }

      .wd-variable-options {
        max-height: 200px;
        overflow-y: auto;
        padding: 8px 0;
      }

      .wd-variable-option {
        padding: 10px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .wd-variable-option:hover {
        background-color: #f0fff4;
        color: #25d366;
      }

      .wd-variable-option i {
        color: #25d366;
        font-size: 12px;
        width: 16px;
        text-align: center;
      }

      .wd-template-variables {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        border: 1px solid #e0e0e0;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .wd-template-variables h4 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .wd-template-variables h4 i {
        color: #25d366;
      }

      .wd-variable-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 768px) {
        .wd-variable-fields {
          grid-template-columns: 1fr;
        }
      }

      .wd-variables-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
        display: block;
      }

      .wd-variables-dropdown::before {
        content: "";
        position: absolute;
        top: -8px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid white;
      }

      .wd-variables-dropdown::after {
        content: "";
        position: absolute;
        top: -9px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid #e0e0e0;
      }

      .wd-variables-list {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .wd-variable-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 13px;
      }

      .wd-variable-item:hover {
        border-color: #25d366;
        background: #f0fff4;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(37, 211, 102, 0.1);
      }

      .wd-variable-item i {
        color: #25d366;
        font-size: 14px;
        width: 16px;
        text-align: center;
      }

      .wd-variable-item span {
        color: #333;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .wd-content-body {
          padding: 15px;
        }

        .wd-form-container {
          padding: 20px;
        }

        .wd-form-actions {
          flex-direction: column;
        }

        .wd-form-actions .wd-btn {
          width: 100%;
          justify-content: center;
        }

        .wd-formatting-toolbar {
          gap: 1px;
          padding: 6px 8px;
        }

        .wd-toolbar-btn {
          padding: 6px 8px;
          min-width: 28px;
          height: 28px;
          font-size: 12px;
        }

        .wd-variables-dropdown {
          left: 0;
          width: 100%;
          max-width: 280px;
        }
      }
    </style>
  </head>
  <body>
    <!-- القسم الأول: الشريط الجانبي الرئيسي -->
    <aside class="wd-sidebar">
      <div class="wd-logo">
        <img src="../imgs/logo.png" alt="شعار المنصة" />
      </div>
      <nav class="wd-nav">
        <ul>
          <li class="wd-nav-item">
            <i class="fa-solid fa-gauge"></i>
            <span
              ><a href="../index.html" class="wd-nav-link">لوحة التحكم</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-comments"></i>
            <span
              ><a href="../chat.html" class="wd-nav-link">المحادثات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-users"></i>
            <span
              ><a href="../contacts.html" class="wd-nav-link"
                >جهات الاتصال</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-diagram-project"></i>
            <span
              ><a href="../flows.html" class="wd-nav-link">التدفقات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-bullhorn"></i>
            <span
              ><a href="../campaigns.html" class="wd-nav-link">الحملات</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-calendar"></i>
            <span
              ><a href="../calendar.html" class="wd-nav-link">التقويم</a></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-file-alt"></i>
            <span
              ><a href="../contents.html" class="wd-nav-link"
                >المحتويات</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-code"></i>
            <span
              ><a href="../developers.html" class="wd-nav-link"
                >المطورين</a
              ></span
            >
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-cog"></i>
            <span
              ><a href="../settings.html" class="wd-nav-link"
                >الإعدادات</a
              ></span
            >
          </li>
        </ul>
      </nav>
    </aside>

    <!-- القسم الثالث: المحتوى الرئيسي -->
    <div class="wd-main-content" style="right: 65px">
      <div class="wd-content-header" style="right: 65px">
        <div class="wd-header-left">
          <button
            class="wd-back-btn"
            onclick="window.location.href='../contents/triggers.html'"
          >
            <i class="fas fa-arrow-right"></i>
          </button>
          <h1>إضافة مشغل جديد</h1>
        </div>
      </div>

      <div class="wd-content-body" style="right: 65px">
        <div class="wd-form-container">
          <form>
            <div class="wd-form-row">
              <div class="wd-form-col">
                <div class="wd-form-group">
                  <label for="trigger-name">اسم المشغل</label>
                  <input
                    type="text"
                    id="trigger-name"
                    placeholder="أدخل اسم المشغل..."
                    maxlength="25"
                    required
                  />
                  <div class="wd-char-counter">
                    <span id="char-count">0</span> / 25 حرف
                  </div>
                </div>
              </div>
              <div class="wd-form-col">
                <div class="wd-form-group">
                  <label for="reminder-type">نوع التذكير</label>
                  <select id="reminder-type">
                    <option value="">اختر نوع التذكير</option>
                    <option value="immediately">فوراً</option>
                    <option value="after">بعد</option>
                  </select>
                </div>
              </div>
              <div
                class="wd-form-col"
                id="reminder-unit-col"
                style="display: none"
              >
                <div class="wd-form-group">
                  <label for="reminder-unit">وحدة التذكير</label>
                  <select id="reminder-unit">
                    <option value="">اختر وحدة التذكير</option>
                    <option value="minutes">دقائق</option>
                    <option value="hours">ساعات</option>
                    <option value="days">أيام</option>
                  </select>
                </div>
              </div>
              <div
                class="wd-form-col"
                id="reminder-time-col"
                style="display: none"
              >
                <div class="wd-form-group">
                  <label for="reminder-time">وقت التذكير</label>
                  <input
                    type="number"
                    id="reminder-time"
                    min="1"
                    placeholder="أدخل القيمة"
                  />
                </div>
              </div>
            </div>

            <div
              id="operator-extra"
              class="wd-form-group"
              style="display: none"
            ></div>

            <!-- القسم الأول: الإجراءات -->
            <div class="wd-form-group">
              <label>الإجراءات</label>
              <div class="wd-actions-container" id="actions-container">
                <!-- الإجراء الأول -->
                <div class="wd-action-item">
                  <div class="wd-action-row">
                    <div class="wd-action-selector">
                      <select class="wd-action-type">
                        <option value="">اختر إجراء</option>
                        <option value="conversation-status">
                          تغيير حالة المحادثة
                        </option>
                        <option value="add-tag">إضافة وسم</option>
                        <option value="remove-tag">إزالة وسم</option>
                        <option value="duplicate-tag">تكرار وسم</option>
                        <option value="add-group">إضافة إلى مجموعة</option>
                        <option value="remove-group">إزالة من مجموعة</option>
                        <option value="assign-staff">إسناد لموظف</option>
                        <option value="remove-assignment">
                          إزالة إسناد من موظف
                        </option>
                        <option value="subscription-status">
                          تغيير حالة الاشتراك
                        </option>
                      </select>
                    </div>
                    <div class="wd-action-options" id="action-options-1">
                      <select class="wd-action-option-select">
                        <option value="">اختر الخيار</option>
                      </select>
                    </div>
                    <button
                      type="button"
                      class="wd-remove-action-btn"
                      onclick="removeAction(this)"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <button
                type="button"
                class="wd-add-action-btn"
                onclick="addAction()"
              >
                <i class="fas fa-plus"></i>
                إضافة إجراء
              </button>
            </div>

            <!-- قسم إرسال الرسالة -->
            <div class="wd-form-group">
              <!-- خيارات تحديد المستقبل -->
              <div class="wd-form-group">
                <label>إرسال الرسالة إلى:</label>
                <div class="wd-recipient-options">
                  <div class="wd-message-type-option" data-recipient="client">
                    <input
                      type="radio"
                      name="recipient"
                      value="client"
                      style="display: none"
                    />
                    <i class="fas fa-user"></i>
                    <div>
                      <div>العميل</div>
                      <small>إرسال الرسالة للعميل الحالي</small>
                    </div>
                  </div>
                  <div class="wd-message-type-option" data-recipient="group">
                    <input
                      type="radio"
                      name="recipient"
                      value="group"
                      style="display: none"
                    />
                    <i class="fas fa-users"></i>
                    <div>
                      <div>اختيار مجموعة</div>
                      <small>إرسال الرسالة لأعضاء مجموعة محددة</small>
                    </div>
                  </div>
                </div>

                <!-- حقل رقم الجوال المخصص -->
                <div
                  class="wd-form-group"
                  id="group-select-field"
                  style="display: none"
                >
                  <label for="group-select">اختر المجموعة</label>
                  <select id="group-select" class="wd-form-control">
                    <option value="">اختر المجموعة</option>
                    <option value="vip-clients">العملاء المميزون</option>
                    <option value="recent-leads">العملاء المحتملون</option>
                    <option value="abandoned-carts">سلات متروكة</option>
                    <option value="followup-list">قائمة المتابعة</option>
                    <option value="support-group">مجموعة الدعم</option>
                  </select>
                </div>
              </div>

              <!-- نوع الرسالة -->
              <label>الرسالة</label>
              <div class="wd-message-type" id="action-type">
                <div class="wd-message-type-option" data-action-type="text">
                  <i class="fas fa-align-left"></i>
                  <div>
                    <div>نص</div>
                    <small
                      >في حال تكون المحادثة مفتوحة او لم يمر عليها 24
                      ساعة</small
                    >
                  </div>
                </div>
                <div class="wd-message-type-option" data-action-type="template">
                  <i class="fas fa-envelope-open-text"></i>
                  <div>
                    <div>قالب</div>
                    <small
                      >في حال تكون المحادثة مغلقة او مر عليها 24 ساعة</small
                    >
                  </div>
                </div>
                <div class="wd-message-type-option" data-action-type="flow">
                  <i class="fa-solid fa-diagram-project"></i>
                  <div>
                    <div>تدفق</div>
                    <small
                      >اختيار روبوت دردشة, نصوص, قوالب وخيارات متعددة</small
                    >
                  </div>
                </div>
              </div>
            </div>

            <div class="wd-form-group" id="action-details"></div>

            <div class="wd-form-group"></div>

            <!-- قسم رسالة الإيميل -->
            <div class="wd-form-group">
              <label>رسالة بريد إلكتروني</label>
              <div class="wd-message-type" id="email-action-type">
                <div
                  class="wd-message-type-option"
                  data-email-action-type="text"
                >
                  <i class="fas fa-align-left"></i>
                  <div>
                    <div>نص</div>
                    <small>كتابة رسالة بريد إلكتروني مخصصة</small>
                  </div>
                </div>
                <div
                  class="wd-message-type-option"
                  data-email-action-type="template"
                >
                  <i class="fas fa-envelope-open-text"></i>
                  <div>
                    <div>قالب</div>
                    <small>اختيار قالب بريد إلكتروني جاهز</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="wd-form-group" id="email-action-details"></div>

            <div class="wd-form-actions">
              <a href="../contents/triggers.html" class="wd-btn-secondary">
                <i class="fas fa-times"></i>
                إلغاء
              </a>
              <button type="submit" class="wd-btn-primary">
                <i class="fas fa-save"></i>
                حفظ المشغل
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="../script.js"></script>
    <script>
      (function () {
        const operatorExtra = document.getElementById("operator-extra");

        // التحقق من نوع المشغل المرسل من URL
        const urlParams = new URLSearchParams(window.location.search);
        const triggerType = urlParams.get("trigger_type");

        function handleOperatorChange(triggerType) {
          if (!triggerType) {
            operatorExtra.style.display = "none";
            operatorExtra.innerHTML = "";
            return;
          }

          if (
            triggerType === "tag-added" ||
            triggerType === "tag-removed" ||
            triggerType === "tag-duplicated"
          ) {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر الوسوم (يمكن اختيار أكثر من وسم)</label>
              <div class="wd-group-search">
                <input
                  type="text"
                  id="tagSearch"
                  class="wd-form-control"
                  placeholder="انقر لاختيار الوسوم..."
                  readonly
                />
                <div class="wd-group-list" id="tagList">
                  <div class="wd-group-item" data-group="VIP">VIP</div>
                  <div class="wd-group-item" data-group="مهتم">مهتم</div>
                  <div class="wd-group-item" data-group="متابعة">متابعة</div>
                  <div class="wd-group-item" data-group="عميل جديد">عميل جديد</div>
                  <div class="wd-group-item" data-group="أولوية">أولوية</div>
                </div>
              </div>
              <div class="wd-selected-groups" id="selectedTagsDisplay"></div>
              <input type="hidden" id="selectedTags" />
            `;
            // تهيئة اختيار الوسوم
            setTimeout(() => {
              initializeTagSelection();
            }, 100);
          } else if (
            triggerType === "group-added" ||
            triggerType === "group-removed"
          ) {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر المجموعات (يمكن اختيار أكثر من مجموعة)</label>
              <div class="wd-group-search">
                <input
                  type="text"
                  id="groupSearch"
                  class="wd-form-control"
                  placeholder="انقر لاختيار المجموعات..."
                  readonly
                />
                <div class="wd-group-list" id="groupList">
                  <div class="wd-group-item" data-group="العملاء الجدد">العملاء الجدد</div>
                  <div class="wd-group-item" data-group="عملاء مميزون">عملاء مميزون</div>
                  <div class="wd-group-item" data-group="قائمة المتابعة">قائمة المتابعة</div>
                  <div class="wd-group-item" data-group="مجموعة الدعم">مجموعة الدعم</div>
                  <div class="wd-group-item" data-group="مجموعة المبيعات">مجموعة المبيعات</div>
                </div>
              </div>
              <div class="wd-selected-groups" id="selectedGroupsDisplay"></div>
              <input type="hidden" id="selectedGroups" />
            `;
            // تهيئة اختيار المجموعات
            setTimeout(() => {
              initializeGroupSelection();
            }, 100);
          } else if (triggerType === "assigned") {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر الموظف</label>
              <select id="staff-select">
                <option value="">اختر الموظف</option>
                <option value="staff-1">أحمد محمد</option>
                <option value="staff-2">فاطمة علي</option>
                <option value="staff-3">محمد حسن</option>
                <option value="staff-4">نورا أحمد</option>
                <option value="staff-5">خالد إبراهيم</option>
              </select>
            `;
          } else if (triggerType === "variable-updated") {
            operatorExtra.style.display = "";
            operatorExtra.innerHTML = `
              <label>اختر المتغيرات (يمكن اختيار أكثر من متغير)</label>
              <div class="wd-group-search">
                <input
                  type="text"
                  id="variableSearch"
                  class="wd-form-control"
                  placeholder="انقر لاختيار المتغيرات..."
                  readonly
                />
                <div class="wd-group-list" id="variableList">
                  <div class="wd-group-item" data-group="متغيرات النظام">
                    <span style="font-weight: bold; color: #666; font-size: 12px;">متغيرات النظام</span>
                  </div>
                  <div class="wd-group-item" data-variable="{{company_name}}">
                    اسم الشركة
                  </div>
                  <div class="wd-group-item" data-variable="{{current_date}}">
                    التاريخ الحالي
                  </div>
                  <div class="wd-group-item" data-variable="{{current_time}}">
                    الوقت الحالي
                  </div>
                  <div class="wd-group-item" data-variable="{{conversation_id}}">
                    رقم المحادثة
                  </div>
                  <div class="wd-group-item" data-variable="{{agent_name}}">
                    اسم الموظف
                  </div>
                  <div class="wd-group-item" data-group="متغيرات المستخدم">
                    <span style="font-weight: bold; color: #666; font-size: 12px;">متغيرات المستخدم</span>
                  </div>
                  <div class="wd-group-item" data-variable="{{contact_name}}">
                    اسم جهة الاتصال
                  </div>
                  <div class="wd-group-item" data-variable="{{contact_phone}}">
                    رقم الهاتف
                  </div>
                  <div class="wd-group-item" data-variable="{{contact_email}}">
                    البريد الإلكتروني
                  </div>
                  <div class="wd-group-item" data-variable="{{user_age}}">
                    العمر
                  </div>
                  <div class="wd-group-item" data-variable="{{user_location}}">
                    الموقع
                  </div>
                </div>
              </div>
              <div class="wd-selected-groups" id="selectedVariablesDisplay"></div>
              <input type="hidden" id="selectedVariables" />
            `;
            // تهيئة اختيار المتغيرات
            setTimeout(() => {
              initializeVariableSelection();
            }, 100);
          } else {
            operatorExtra.style.display = "none";
            operatorExtra.innerHTML = "";
          }
        }

        // تهيئة المشغل حسب النوع المرسل من URL
        if (triggerType) {
          handleOperatorChange(triggerType);
        }

        // دوال التحكم في القوائم المنسدلة
        // وظائف الاختيار المتعدد للوسوم والمجموعات والمتغيرات مثل صفحة new-contact.html
        let pickedTags = [];
        let pickedGroups = [];
        let pickedVariables = [];

        window.initializeTagSelection = function () {
          const tagSearch = document.getElementById("tagSearch");
          const tagList = document.getElementById("tagList");
          const selectedTags = document.getElementById("selectedTags");
          const tagItems = tagList.querySelectorAll(".wd-group-item");

          if (!tagSearch || !tagList) return;

          tagSearch.addEventListener("click", () => {
            tagList.style.display =
              tagList.style.display === "block" ? "none" : "block";
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            if (!tagSearch.contains(e.target) && !tagList.contains(e.target)) {
              tagList.style.display = "none";
            }
          });

          function refreshPickedTagsUI() {
            // Update hidden input
            if (selectedTags) selectedTags.value = JSON.stringify(pickedTags);

            // Update visual indicators in dropdown
            tagItems.forEach((item) => {
              const tag = item.dataset.group;
              if (pickedTags.includes(tag)) {
                item.classList.add("selected");
              } else {
                item.classList.remove("selected");
              }
            });

            // Update selected tags display
            const displayContainer = document.getElementById(
              "selectedTagsDisplay"
            );
            if (displayContainer) {
              displayContainer.innerHTML = "";

              pickedTags.forEach((tag) => {
                const tagElement = document.createElement("div");
                tagElement.className = "wd-selected-group-tag";
                tagElement.innerHTML = `
                  <span>${tag}</span>
                  <button type="button" class="remove-btn" onclick="removeTag('${tag}')">×</button>
                `;
                displayContainer.appendChild(tagElement);
              });

              // Update search input placeholder
              if (pickedTags.length > 0) {
                tagSearch.placeholder = `تم اختيار ${pickedTags.length} وسم`;
              } else {
                tagSearch.placeholder = "انقر لاختيار الوسوم...";
              }
            }
          }

          // Add global function to remove tags
          window.removeTag = function (tagName) {
            const index = pickedTags.indexOf(tagName);
            if (index > -1) {
              pickedTags.splice(index, 1);
              refreshPickedTagsUI();
            }
          };

          tagItems.forEach((item) => {
            item.addEventListener("click", () => {
              const tag = item.dataset.group;
              const idx = pickedTags.indexOf(tag);
              if (idx === -1) pickedTags.push(tag);
              else pickedTags.splice(idx, 1);
              refreshPickedTagsUI();
            });
          });
        };

        window.initializeGroupSelection = function () {
          const groupSearch = document.getElementById("groupSearch");
          const groupList = document.getElementById("groupList");
          const selectedGroups = document.getElementById("selectedGroups");
          const groupItems = groupList.querySelectorAll(".wd-group-item");

          if (!groupSearch || !groupList) return;

          groupSearch.addEventListener("click", () => {
            groupList.style.display =
              groupList.style.display === "block" ? "none" : "block";
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            if (
              !groupSearch.contains(e.target) &&
              !groupList.contains(e.target)
            ) {
              groupList.style.display = "none";
            }
          });

          function refreshPickedGroupsUI() {
            // Update hidden input
            if (selectedGroups)
              selectedGroups.value = JSON.stringify(pickedGroups);

            // Update visual indicators in dropdown
            groupItems.forEach((item) => {
              const group = item.dataset.group;
              if (pickedGroups.includes(group)) {
                item.classList.add("selected");
              } else {
                item.classList.remove("selected");
              }
            });

            // Update selected groups display
            const displayContainer = document.getElementById(
              "selectedGroupsDisplay"
            );
            if (displayContainer) {
              displayContainer.innerHTML = "";

              pickedGroups.forEach((group) => {
                const groupElement = document.createElement("div");
                groupElement.className = "wd-selected-group-tag";
                groupElement.innerHTML = `
                  <span>${group}</span>
                  <button type="button" class="remove-btn" onclick="removeGroup('${group}')">×</button>
                `;
                displayContainer.appendChild(groupElement);
              });

              // Update search input placeholder
              if (pickedGroups.length > 0) {
                groupSearch.placeholder = `تم اختيار ${pickedGroups.length} مجموعة`;
              } else {
                groupSearch.placeholder = "انقر لاختيار المجموعات...";
              }
            }
          }

          // Add global function to remove groups
          window.removeGroup = function (groupName) {
            const index = pickedGroups.indexOf(groupName);
            if (index > -1) {
              pickedGroups.splice(index, 1);
              refreshPickedGroupsUI();
            }
          };

          groupItems.forEach((item) => {
            item.addEventListener("click", () => {
              const group = item.dataset.group;
              const idx = pickedGroups.indexOf(group);
              if (idx === -1) pickedGroups.push(group);
              else pickedGroups.splice(idx, 1);
              refreshPickedGroupsUI();
            });
          });
        };

        window.initializeVariableSelection = function () {
          const variableSearch = document.getElementById("variableSearch");
          const variableList = document.getElementById("variableList");
          const selectedVariables =
            document.getElementById("selectedVariables");
          const variableItems = variableList.querySelectorAll(
            ".wd-group-item[data-variable]"
          );

          if (!variableSearch || !variableList) return;

          variableSearch.addEventListener("click", () => {
            variableList.style.display =
              variableList.style.display === "block" ? "none" : "block";
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            if (
              !variableSearch.contains(e.target) &&
              !variableList.contains(e.target)
            ) {
              variableList.style.display = "none";
            }
          });

          function refreshPickedVariablesUI() {
            // Update hidden input
            if (selectedVariables)
              selectedVariables.value = JSON.stringify(pickedVariables);

            // Update visual indicators in dropdown
            variableItems.forEach((item) => {
              const variable = item.dataset.variable;
              if (pickedVariables.includes(variable)) {
                item.classList.add("selected");
              } else {
                item.classList.remove("selected");
              }
            });

            // Update selected variables display
            const displayContainer = document.getElementById(
              "selectedVariablesDisplay"
            );
            if (displayContainer) {
              displayContainer.innerHTML = "";

              pickedVariables.forEach((variable) => {
                const variableElement = document.createElement("div");
                variableElement.className = "wd-selected-group-tag";

                // العثور على النص المناسب للمتغير
                const variableItem = Array.from(variableItems).find(
                  (item) => item.dataset.variable === variable
                );
                const variableText = variableItem
                  ? variableItem.textContent.trim()
                  : variable;

                variableElement.innerHTML = `
                  <span>${variableText}</span>
                  <button type="button" class="remove-btn" onclick="removeVariable('${variable}')">×</button>
                `;
                displayContainer.appendChild(variableElement);
              });

              // Update search input placeholder
              if (pickedVariables.length > 0) {
                variableSearch.placeholder = `تم اختيار ${pickedVariables.length} متغير`;
              } else {
                variableSearch.placeholder = "انقر لاختيار المتغيرات...";
              }
            }
          }

          // Add global function to remove variables
          window.removeVariable = function (variableName) {
            const index = pickedVariables.indexOf(variableName);
            if (index > -1) {
              pickedVariables.splice(index, 1);
              refreshPickedVariablesUI();
            }
          };

          variableItems.forEach((item) => {
            item.addEventListener("click", () => {
              const variable = item.dataset.variable;
              const idx = pickedVariables.indexOf(variable);
              if (idx === -1) pickedVariables.push(variable);
              else pickedVariables.splice(idx, 1);
              refreshPickedVariablesUI();
            });
          });
        };

        // دوال إدارة الإجراءات
        let actionCounter = 1;

        window.addAction = function () {
          actionCounter++;
          const actionsContainer = document.getElementById("actions-container");
          const newAction = document.createElement("div");
          newAction.className = "wd-action-item";
          newAction.innerHTML = `
            <div class="wd-action-row">
              <div class="wd-action-selector">
                <select class="wd-action-type" onchange="handleActionTypeChange(this)">
                  <option value="">اختر إجراء</option>
                  <option value="conversation-status">تغيير حالة المحادثة</option>
                  <option value="add-tag">إضافة وسم</option>
                  <option value="remove-tag">إزالة وسم</option>
                  <option value="duplicate-tag">تكرار وسم</option>
                  <option value="add-group">إضافة إلى مجموعة</option>
                  <option value="remove-group">إزالة من مجموعة</option>
                  <option value="assign-staff">إسناد لموظف</option>
                  <option value="remove-assignment">إزالة إسناد من موظف</option>
                  <option value="subscription-status">تغيير حالة الاشتراك</option>
                </select>
              </div>
              <div class="wd-action-options" id="action-options-${actionCounter}">
                <select class="wd-action-option-select">
                  <option value="">اختر الخيار</option>
                </select>
              </div>
              <button type="button" class="wd-remove-action-btn" onclick="removeAction(this)">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          actionsContainer.appendChild(newAction);
          updateRemoveButtonsVisibility();
        };

        window.removeAction = function (button) {
          const actionItem = button.closest(".wd-action-item");
          actionItem.remove();
          updateRemoveButtonsVisibility();
        };

        function updateRemoveButtonsVisibility() {
          const actionItems = document.querySelectorAll(".wd-action-item");
          const removeButtons = document.querySelectorAll(
            ".wd-remove-action-btn"
          );

          // إظهار زر الحذف دائماً
          removeButtons.forEach((btn) => (btn.style.display = "flex"));
        }

        window.handleActionTypeChange = function (select) {
          const actionType = select.value;
          const actionItem = select.closest(".wd-action-item");
          const optionsContainer =
            actionItem.querySelector(".wd-action-options");
          const optionsSelect = optionsContainer.querySelector(
            ".wd-action-option-select"
          );

          // إعادة تعيين خيارات الإجراء
          optionsSelect.innerHTML = '<option value="">اختر الخيار</option>';

          if (actionType) {
            // إضافة الخيارات حسب نوع الإجراء
            switch (actionType) {
              case "conversation-status":
                optionsSelect.innerHTML = `
                  <option value="">اختر الحالة</option>
                  <option value="open">فتح المحادثة</option>
                  <option value="closed">إغلاق المحادثة</option>
                `;
                break;
              case "add-tag":
              case "remove-tag":
              case "duplicate-tag":
                optionsSelect.innerHTML = `
                <option value="">اختر الوسم</option>
                <option value="vip">VIP</option>
                <option value="interested">مهتم</option>
                <option value="followup">متابعة</option>
                  <option value="new-customer">عميل جديد</option>
                  <option value="priority">أولوية</option>
                  <option value="urgent">عاجل</option>
                  <option value="completed">مكتمل</option>
                `;
                break;
              case "add-group":
              case "remove-group":
                optionsSelect.innerHTML = `
                <option value="">اختر المجموعة</option>
                <option value="new-customers">العملاء الجدد</option>
                <option value="vip-customers">عملاء مميزون</option>
                <option value="followup-list">قائمة المتابعة</option>
                  <option value="support-group">مجموعة الدعم</option>
                  <option value="sales-group">مجموعة المبيعات</option>
                  <option value="marketing-group">مجموعة التسويق</option>
                  <option value="technical-group">مجموعة التقنية</option>
                `;
                break;
              case "assign-staff":
                optionsSelect.innerHTML = `
                  <option value="">اختر الموظف</option>
                  <option value="staff-1">أحمد محمد</option>
                  <option value="staff-2">فاطمة علي</option>
                  <option value="staff-3">محمد حسن</option>
                  <option value="staff-4">نورا أحمد</option>
                  <option value="staff-5">خالد إبراهيم</option>
                  <option value="staff-6">سارة خالد</option>
                  <option value="staff-7">عبدالله سالم</option>
                `;
                break;
              case "remove-assignment":
                optionsSelect.innerHTML = `
                  <option value="">اختر الموظف</option>
                  <option value="staff-1">أحمد محمد</option>
                  <option value="staff-2">فاطمة علي</option>
                  <option value="staff-3">محمد حسن</option>
                  <option value="staff-4">نورا أحمد</option>
                  <option value="staff-5">خالد إبراهيم</option>
                  <option value="staff-6">سارة خالد</option>
                  <option value="staff-7">عبدالله سالم</option>
                `;
                break;
              case "subscription-status":
                optionsSelect.innerHTML = `
                  <option value="">اختر حالة الاشتراك</option>
                  <option value="subscribed">مشترك</option>
                  <option value="unsubscribed">غير مشترك</option>
                `;
                break;
            }
          }
        };

        // تهيئة الإجراء الأول
        document.addEventListener("DOMContentLoaded", function () {
          updateRemoveButtonsVisibility();

          // تهيئة event listener للإجراء الأول
          const firstActionSelect = document.querySelector(".wd-action-type");
          if (firstActionSelect) {
            firstActionSelect.addEventListener("change", function () {
              handleActionTypeChange(this);
            });
          }

          // تهيئة عداد الحروف
          initializeCharCounter();

          // تهيئة خيارات الراديو للمستقبل
          initializeRecipientOptions();

          // تهيئة قسم الرسالة المنفصل
          initializeMessageSection();

          // تهيئة قسم رسالة الإيميل
          initializeEmailSection();

          // تهيئة رفع صورة القالب
          initializeTemplateImageUpload();
        });

        // تهيئة عداد الحروف
        function initializeCharCounter() {
          const nameInput = document.getElementById("trigger-name");
          const charCount = document.getElementById("char-count");
          const counter = document.querySelector(".wd-char-counter");

          if (nameInput && charCount && counter) {
            // تحديث العداد عند الكتابة
            nameInput.addEventListener("input", function () {
              const currentLength = this.value.length;
              const maxLength = parseInt(this.getAttribute("maxlength"));

              // تحديث الرقم
              charCount.textContent = currentLength;

              // تحديث الألوان حسب النسبة
              counter.classList.remove("warning", "danger");

              if (currentLength >= maxLength * 0.9) {
                counter.classList.add("danger");
              } else if (currentLength >= maxLength * 0.7) {
                counter.classList.add("warning");
              }
            });

            // تحديث أولي
            nameInput.dispatchEvent(new Event("input"));
          }
        }

        // تهيئة خيارات الراديو للمستقبل
        function initializeRecipientOptions() {
          const recipientOptions = document.querySelectorAll(
            ".wd-recipient-options .wd-message-type-option"
          );
          const groupField = document.getElementById("group-select-field");
          const groupSelect = document.getElementById("group-select");

          recipientOptions.forEach((option) => {
            option.addEventListener("click", function () {
              const wasSelected = option.classList.contains("selected");

              recipientOptions.forEach((opt) => {
                opt.classList.remove("selected");
                const radio = opt.querySelector('input[type="radio"]');
                if (radio) radio.checked = false;
              });

              if (wasSelected) {
                if (groupField) groupField.style.display = "none";
                if (groupSelect) groupSelect.value = "";
                return;
              }

              option.classList.add("selected");
              const radio = option.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;

                if (radio.value === "group") {
                  if (groupField) groupField.style.display = "block";
                } else {
                  if (groupField) groupField.style.display = "none";
                  if (groupSelect) groupSelect.value = "";
                }
              }
            });
          });

          if (groupField) groupField.style.display = "none";
        }

        // تهيئة رفع صورة القالب
        function initializeTemplateImageUpload() {
          const imagePreview = document.getElementById(
            "template-image-preview"
          );
          const imageInput = document.getElementById("template-image-input");
          const removeBtn = document.getElementById("remove-image-btn");

          if (imagePreview && imageInput && removeBtn) {
            // النقر على منطقة المعاينة
            imagePreview.addEventListener("click", function () {
              if (!imagePreview.classList.contains("has-image")) {
                imageInput.click();
              }
            });

            // تغيير الملف المختار
            imageInput.addEventListener("change", function (e) {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                  // إنشاء عنصر الصورة
                  const img = document.createElement("img");
                  img.src = e.target.result;
                  img.alt = "صورة القالب";

                  // مسح المحتوى السابق
                  imagePreview.innerHTML = "";
                  imagePreview.appendChild(img);
                  imagePreview.classList.add("has-image");

                  // إظهار زر الإزالة
                  removeBtn.style.display = "flex";
                };
                reader.readAsDataURL(file);
              }
            });

            // زر إزالة الصورة
            removeBtn.addEventListener("click", function (e) {
              e.stopPropagation();

              // إعادة تعيين المحتوى
              imagePreview.innerHTML = `
                <i class="fas fa-cloud-upload-alt"></i>
                <p>انقر لرفع صورة</p>
              `;
              imagePreview.classList.remove("has-image");

              // إخفاء زر الإزالة
              removeBtn.style.display = "none";

              // مسح الملف المختار
              imageInput.value = "";
            });
          }
        }

        // تهيئة قسم الرسالة المنفصل
        function initializeMessageSection() {
          // Card selection for message type
          document
            .querySelectorAll("#action-type .wd-message-type-option")
            .forEach((opt) => {
              opt.addEventListener("click", () => {
                const wasSelected = opt.classList.contains("selected");
                document
                  .querySelectorAll("#action-type .wd-message-type-option")
                  .forEach((o) => o.classList.remove("selected"));
                const container = document.getElementById("action-details");
                if (wasSelected) {
                  if (container) container.innerHTML = "";
                } else {
                  opt.classList.add("selected");
                  const type = opt.getAttribute("data-action-type");
                  renderActionDetails(type);
                }
              });
            });

          // تهيئة أولية
          const actionDetails = document.getElementById("action-details");
          if (actionDetails) {
            actionDetails.innerHTML = "";
          }
        }

        // تهيئة قسم رسالة الإيميل
        function initializeEmailSection() {
          document
            .querySelectorAll("#email-action-type .wd-message-type-option")
            .forEach((opt) => {
              opt.addEventListener("click", () => {
                const wasSelected = opt.classList.contains("selected");
                document
                  .querySelectorAll(
                    "#email-action-type .wd-message-type-option"
                  )
                  .forEach((o) => o.classList.remove("selected"));
                const emailContainer = document.getElementById(
                  "email-action-details"
                );
                if (wasSelected) {
                  if (emailContainer) emailContainer.innerHTML = "";
                } else {
                  opt.classList.add("selected");
                  const type = opt.getAttribute("data-email-action-type");
                  renderEmailDetails(type);
                }
              });
            });

          const emailDetails = document.getElementById("email-action-details");
          if (emailDetails) {
            emailDetails.innerHTML = "";
          }
        }

        function renderEmailDetails(type) {
          const container = document.getElementById("email-action-details");
          if (!container) return;

          if (type === "text") {
            container.innerHTML = `
              <div class="wd-form-row auto-fit">
                <div class="wd-form-group">
                  <label for="email-subject">عنوان البريد الإلكتروني:</label>
                  <input
                    type="text"
                    id="email-subject"
                    placeholder="اكتب عنوان البريد الإلكتروني..."
                  />
                </div>
              </div>
              <label>محتوى البريد الإلكتروني:</label>
              <div class="wd-text-editor">
                <div class="wd-formatting-toolbar">
                  <button type="button" class="wd-toolbar-btn" id="email-bold-btn" title="عريض">
                    <i class="fas fa-bold"></i>
                  </button>
                  <button type="button" class="wd-toolbar-btn" id="email-italic-btn" title="مائل">
                    <i class="fas fa-italic"></i>
                  </button>
                  <button type="button" class="wd-toolbar-btn" id="email-link-btn" title="إدراج رابط">
                    <i class="fas fa-link"></i>
                  </button>
                  <div class="wd-toolbar-separator"></div>
                  <button type="button" class="wd-toolbar-btn" id="email-undo-btn" title="تراجع">
                    <i class="fas fa-undo"></i>
                  </button>
                  <button type="button" class="wd-toolbar-btn" id="email-redo-btn" title="إعادة">
                    <i class="fas fa-redo"></i>
                  </button>
                  <div class="wd-toolbar-separator"></div>
                  <button type="button" class="wd-toolbar-btn" id="email-list-btn" title="قائمة">
                    <i class="fas fa-list"></i>
                  </button>
                  <button type="button" class="wd-toolbar-btn" id="email-variables-btn" title="إضافة متغير">
                    <i class="fas fa-code"></i>
                  </button>
                </div>
                <div class="wd-textarea-wrapper">
                  <textarea
                    id="email-body"
                    placeholder="اكتب محتوى البريد الإلكتروني هنا..."
                    style="min-height: 160px; resize: vertical;"
                  ></textarea>
                </div>
                <div class="wd-variables-dropdown" id="email-variables-dropdown">
                  <div class="wd-variables-list">
                    <div class="wd-variable-item" data-variable="{{contact_name}}">
                      <i class="fas fa-user"></i>
                      <span>اسم جهة الاتصال</span>
                    </div>
                    <div class="wd-variable-item" data-variable="{{contact_email}}">
                      <i class="fas fa-envelope"></i>
                      <span>البريد الإلكتروني</span>
                    </div>
                    <div class="wd-variable-item" data-variable="{{contact_phone}}">
                      <i class="fas fa-phone"></i>
                      <span>رقم الهاتف</span>
                    </div>
                    <div class="wd-variable-item" data-variable="{{company_name}}">
                      <i class="fas fa-building"></i>
                      <span>اسم الشركة</span>
                    </div>
                    <div class="wd-variable-item" data-variable="{{current_date}}">
                      <i class="fas fa-calendar"></i>
                      <span>التاريخ الحالي</span>
                    </div>
                    <div class="wd-variable-item" data-variable="{{current_time}}">
                      <i class="fas fa-clock"></i>
                      <span>الوقت الحالي</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
            initializeEmailToolbar();
          } else {
            container.innerHTML = `
              <div class="wd-message-container">
                <div class="wd-message-form">
                  <label for="email-template-select">اختر قالب البريد الإلكتروني</label>
                  <select id="email-template-select">
                    <option value="">اختر القالب</option>
                    <option value="welcome-email">قالب ترحيبي</option>
                    <option value="followup-email">قالب متابعة</option>
                    <option value="custom-email">قالب مخصص</option>
                  </select>
                  <div class="wd-form-group" id="custom-email-vars" style="display: none; margin-top: 15px;">
                    <label for="custom-email-variable">متغيرات القالب</label>
                    <div class="wd-variable-input">
                      <input
                        type="text"
                        id="custom-email-variable"
                        class="wd-form-control"
                        placeholder="أدخل المتغير أو اختر من القائمة"
                      />
                      <button
                        type="button"
                        class="wd-variable-button"
                        onclick="showVariableList('custom-email-variable')"
                      >
                        <i class="fas fa-list"></i>
                      </button>
                    </div>
                    <div class="wd-variable-list" id="custom-email-variableList">
                      <div class="wd-variable-search">
                        <input
                          type="text"
                          placeholder="ابحث عن متغير..."
                          oninput="searchVariables('custom-email-variable', this.value)"
                        />
                        <i class="fas fa-search"></i>
                      </div>
                      <div class="wd-variable-options">
                        <div class="wd-variable-option" onclick="selectVariable('custom-email-variable', 'اسم العميل', '{{contact_name}}')">
                          <i class="fas fa-user"></i>
                          اسم العميل
                        </div>
                        <div class="wd-variable-option" onclick="selectVariable('custom-email-variable', 'اسم الشركة', '{{company_name}}')">
                          <i class="fas fa-building"></i>
                          اسم الشركة
                        </div>
                        <div class="wd-variable-option" onclick="selectVariable('custom-email-variable', 'رقم الهاتف', '{{contact_phone}}')">
                          <i class="fas fa-phone"></i>
                          رقم الهاتف
                        </div>
                        <div class="wd-variable-option" onclick="selectVariable('custom-email-variable', 'البريد الإلكتروني', '{{contact_email}}')">
                          <i class="fas fa-envelope"></i>
                          البريد الإلكتروني
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="wd-message-preview">
                  <div class="wd-preview-title">معاينة الإيميل</div>
                  <div class="wd-template-preview" style="background: #fff; height: auto; border: 1px solid #eee; padding: 0;">
                    <div style="padding: 20px; font-size: 14px; color: #333;" id="email-template-preview">
                      اختر قالب الإيميل لعرض المعاينة هنا
                    </div>
                  </div>
                </div>
              </div>
            `;

            const emailTemplateSelect = document.getElementById(
              "email-template-select"
            );
            const customVars = document.getElementById("custom-email-vars");
            const preview = document.getElementById("email-template-preview");

            if (emailTemplateSelect && preview) {
              emailTemplateSelect.addEventListener("change", () => {
                const value = emailTemplateSelect.value;
                switch (value) {
                  case "welcome-email":
                    preview.innerHTML = `
                      <strong>مرحباً {{contact_name}},</strong><br /><br />
                      يسعدنا انضمامك إلينا. نحن هنا لدعمك في أي وقت.<br /><br />
                      مع التحية،<br />
                      {{company_name}}
                    `;
                    if (customVars) customVars.style.display = "none";
                    break;
                  case "followup-email":
                    preview.innerHTML = `
                      <strong>مرحباً {{contact_name}},</strong><br /><br />
                      نود متابعة طلبك السابق والتأكد من رضاك عن خدماتنا.<br /><br />
                      يمكنك الرد على هذه الرسالة أو التواصل على {{contact_email}}.<br /><br />
                      فريق {{company_name}}
                    `;
                    if (customVars) customVars.style.display = "none";
                    break;
                  case "custom-email":
                    preview.innerHTML = `
                      <strong>عنوان القالب المخصص</strong><br /><br />
                      يمكنك تخصيص محتوى القالب عبر المتغيرات أسفل هذا النص.<br /><br />
                      مع التحية،<br />
                      فريق العمل.
                    `;
                    if (customVars) customVars.style.display = "block";
                    break;
                  default:
                    preview.textContent = "اختر قالب الإيميل لعرض المعاينة هنا";
                    if (customVars) customVars.style.display = "none";
                    break;
                }
              });
            }
          }
        }

        // إغلاق القوائم عند النقر خارجها
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".wd-multi-select-container")) {
            document
              .querySelectorAll(".wd-multi-select-menu")
              .forEach((menu) => {
                menu.classList.remove("show");
              });
          }
        });

        function updateTemplatePreview() {
          const select = document.getElementById("action-template");
          if (!select) return;
          const previewBody = document.getElementById("templatePreviewBody");
          const previewContent = document.getElementById("previewContent");
          if (!previewBody || !previewContent) return;

          const templates = {
            welcome: {
              content:
                "مرحباً {{contact_name}}! يسعدنا تواصلك معنا. هذا قالب ترحيبي من {{company_name}}.",
              buttons: ["زيارة الموقع", "تواصل معنا"],
            },
            followup: {
              content:
                "متابعة سريعة بخصوص استفسارك السابق حول {{product_name}}. هل لازلت مهتماً؟",
              buttons: ["نعم مهتم", "لاحقاً"],
            },
            custom: {
              content:
                "مرحباً {{contact_name}}! شكراً لاهتمامك بـ {{service_name}}. يمكنك التواصل معنا على {{contact_phone}} أو {{contact_email}}.",
              buttons: ["احجز الآن", "استفسار"],
            },
          };

          const value = select.value;
          const oldButtons = previewContent.querySelector(
            ".wd-preview-buttons"
          );
          if (oldButtons) oldButtons.remove();

          if (value && templates[value]) {
            let content = templates[value].content;

            // استبدال المتغيرات بالقيم المدخلة
            if (value === "custom") {
              const var1 =
                document.getElementById("template-var1")?.value ||
                "{{contact_name}}";
              const var2 =
                document.getElementById("template-var2")?.value ||
                "{{service_name}}";

              content = content
                .replace("{{contact_name}}", var1)
                .replace("{{service_name}}", var2)
                .replace("{{contact_phone}}", "{{contact_phone}}")
                .replace("{{contact_email}}", "{{contact_email}}");
            } else {
              // استبدال المتغيرات الافتراضية
              content = content
                .replace("{{contact_name}}", "اسم العميل")
                .replace("{{company_name}}", "اسم الشركة")
                .replace("{{product_name}}", "اسم المنتج")
                .replace("{{service_name}}", "اسم الخدمة")
                .replace("{{contact_phone}}", "رقم الهاتف")
                .replace("{{contact_email}}", "البريد الإلكتروني");
            }

            previewBody.textContent = content;

            if (
              templates[value].buttons &&
              templates[value].buttons.length > 0
            ) {
              const buttonsContainer = document.createElement("div");
              buttonsContainer.className = "wd-preview-buttons";
              templates[value].buttons.forEach((b) => {
                const btn = document.createElement("button");
                btn.className = "wd-preview-button";
                btn.textContent = b;
                buttonsContainer.appendChild(btn);
              });
              previewContent.appendChild(buttonsContainer);
            }
          } else {
            previewBody.textContent = "اختر قالب لعرض المعاينة";
          }
        }

        function renderActionDetails(type) {
          const container = document.getElementById("action-details");
          if (type === "text") {
            container.innerHTML = `
               <label>النص</label>
               <div class="wd-text-editor">
                 <div class="wd-formatting-toolbar">
                   <button type="button" class="wd-toolbar-btn" id="bold-btn" title="عريض">
                     <i class="fas fa-bold"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="italic-btn" title="مائل">
                     <i class="fas fa-italic"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="link-btn" title="إدراج رابط">
                     <i class="fas fa-link"></i>
                   </button>
                   <div class="wd-toolbar-separator"></div>
                   <button type="button" class="wd-toolbar-btn" id="undo-btn" title="تراجع">
                     <i class="fas fa-undo"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="redo-btn" title="إعادة">
                     <i class="fas fa-redo"></i>
                   </button>
                   <div class="wd-toolbar-separator"></div>
                   <button type="button" class="wd-toolbar-btn" id="list-btn" title="قائمة">
                     <i class="fas fa-list"></i>
                   </button>
                   <button type="button" class="wd-toolbar-btn" id="variables-btn" title="إضافة متغير">
                     <i class="fas fa-code"></i>
                   </button>
                 </div>
                 <div class="wd-textarea-wrapper">
                   <textarea id="action-text" placeholder="اكتب الرسالة..."></textarea>
                 </div>
                 <div class="wd-variables-dropdown" id="variables-dropdown">
                   <div class="wd-variables-list">
                     <div class="wd-variable-item" data-variable="{{contact_name}}">
                       <i class="fas fa-user"></i>
                       <span>اسم جهة الاتصال</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{contact_phone}}">
                       <i class="fas fa-phone"></i>
                       <span>رقم الهاتف</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{contact_email}}">
                       <i class="fas fa-envelope"></i>
                       <span>البريد الإلكتروني</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{company_name}}">
                       <i class="fas fa-building"></i>
                       <span>اسم الشركة</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{current_date}}">
                       <i class="fas fa-calendar"></i>
                       <span>التاريخ الحالي</span>
                     </div>
                     <div class="wd-variable-item" data-variable="{{current_time}}">
                       <i class="fas fa-clock"></i>
                       <span>الوقت الحالي</span>
                     </div>
                   </div>
                 </div>
               </div>
             `;

            // إضافة event listeners لشريط الأدوات
            initializeToolbar();

            // إضافة event listeners للمتغيرات
            setupVariablesDropdown();
          } else if (type === "template") {
            container.innerHTML = `
               <div class="wd-message-container">
                 <div class="wd-message-form">
                   <label>اختر القالب</label>
                   <select id="action-template">
                     <option value="">اختر القالب</option>
                     <option value="welcome">قالب ترحيب</option>
                     <option value="followup">قالب متابعة</option>
                     <option value="custom">قالب مخصص</option>
                   </select>
                   
                   <div class="wd-template-variables" id="template-variables" style="display: none;">
                    <div class="wd-template-image-section">
                      <h4><i class="fas fa-image"></i> صورة القالب</h4>
                      <div class="wd-image-upload-container">
                        <div class="wd-image-preview" id="template-image-preview">
                          <i class="fas fa-cloud-upload-alt"></i>
                          <p>انقر لرفع صورة</p>
                          <input type="file" id="template-image-input" accept="image/*" style="display: none;">
                        </div>
                        <button type="button" class="wd-remove-image-btn" id="remove-image-btn" style="display: none;">
                          <i class="fas fa-times"></i>
                          إزالة الصورة
                        </button>
                      </div>
                    </div>
                    
                     <h4><i class="fas fa-cogs"></i> متغيرات القالب</h4>
                     <div class="wd-variable-fields">
                       <div class="wd-form-group">
                         <label for="template-var1">المتغير الأول</label>
                         <div class="wd-variable-input">
                           <input
                             type="text"
                             id="template-var1"
                             class="wd-form-control"
                             placeholder="أدخل المتغير الأول أو اختر من القائمة"
                           />
                           <button
                             type="button"
                             class="wd-variable-button"
                             onclick="showVariableList('template-var1')"
                           >
                             <i class="fas fa-list"></i>
                           </button>
                         </div>
                         <div class="wd-variable-list" id="template-var1List">
                           <div class="wd-variable-search">
                             <input
                               type="text"
                               placeholder="ابحث عن متغير..."
                               oninput="searchVariables('template-var1', this.value)"
                             />
                             <i class="fas fa-search"></i>
                           </div>
                           <div class="wd-variable-options">
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'اسم العميل', '{{contact_name}}')">
                               <i class="fas fa-user"></i>
                               اسم العميل
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'اسم الشركة', '{{company_name}}')">
                               <i class="fas fa-building"></i>
                               اسم الشركة
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'المنتج', '{{product_name}}')">
                               <i class="fas fa-box"></i>
                               المنتج
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'الخدمة', '{{service_name}}')">
                               <i class="fas fa-cogs"></i>
                               الخدمة
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var1', 'التاريخ', '{{current_date}}')">
                               <i class="fas fa-calendar"></i>
                               التاريخ
                             </div>
                           </div>
                         </div>
                       </div>
                       
                       <div class="wd-form-group">
                         <label for="template-var2">المتغير الثاني</label>
                         <div class="wd-variable-input">
                           <input
                             type="text"
                             id="template-var2"
                             class="wd-form-control"
                             placeholder="أدخل المتغير الثاني أو اختر من القائمة"
                           />
                           <button
                             type="button"
                             class="wd-variable-button"
                             onclick="showVariableList('template-var2')"
                           >
                             <i class="fas fa-list"></i>
                           </button>
                         </div>
                         <div class="wd-variable-list" id="template-var2List">
                           <div class="wd-variable-search">
                             <input
                               type="text"
                               placeholder="ابحث عن متغير..."
                               oninput="searchVariables('template-var2', this.value)"
                             />
                             <i class="fas fa-search"></i>
                           </div>
                           <div class="wd-variable-options">
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'رقم الهاتف', '{{contact_phone}}')">
                               <i class="fas fa-phone"></i>
                               رقم الهاتف
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'البريد الإلكتروني', '{{contact_email}}')">
                               <i class="fas fa-envelope"></i>
                               البريد الإلكتروني
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'السعر', '{{price}}')">
                               <i class="fas fa-tag"></i>
                               السعر
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'الوقت', '{{current_time}}')">
                               <i class="fas fa-clock"></i>
                               الوقت
                             </div>
                             <div class="wd-variable-option" onclick="selectVariable('template-var2', 'الموقع', '{{location}}')">
                               <i class="fas fa-map-marker-alt"></i>
                               الموقع
                             </div>
                           </div>
                         </div>
                       </div>
                     </div>
                   </div>
                 </div>
                 <div class="wd-message-preview">
                   <div class="wd-preview-title">معاينة القالب</div>
                   <div class="wd-template-preview" id="templatePreviewSection">
                     <div class="wd-preview-content" id="previewContent">
                       <div class="wd-preview-message">
                         <div class="wd-preview-body" id="templatePreviewBody">اختر قالب لعرض المعاينة</div>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>
             `;
            const templateSelect = document.getElementById("action-template");
            if (templateSelect) {
              templateSelect.addEventListener("change", updateTemplatePreview);
              templateSelect.addEventListener(
                "change",
                toggleTemplateVariables
              );
            }

            // إضافة event listeners لحقول المتغيرات
            const var1Input = document.getElementById("template-var1");
            const var2Input = document.getElementById("template-var2");

            if (var1Input) {
              var1Input.addEventListener("input", updateTemplatePreview);
            }
            if (var2Input) {
              var2Input.addEventListener("input", updateTemplatePreview);
            }
          } else {
            container.innerHTML = `
              <label>اختر التدفق</label>
              <select id="action-flow">
                <option value="">اختر التدفق</option>
                <option value="welcome-flow">تدفق الترحيب</option>
                <option value="followup-flow">تدفق المتابعة</option>
              </select>
            `;
          }
        }

        // منطق إظهار حقول التذكير تدريجياً
        const reminderTypeSelect = document.getElementById("reminder-type");
        const reminderUnitGroup = document.getElementById(
          "reminder-unit-group"
        );
        const reminderUnitSelect = document.getElementById("reminder-unit");
        const reminderTimeGroup = document.getElementById(
          "reminder-time-group"
        );

        function toggleReminderUnit() {
          const reminderUnitCol = document.getElementById("reminder-unit-col");
          const reminderTimeCol = document.getElementById("reminder-time-col");
          const hasType =
            reminderTypeSelect && reminderTypeSelect.value === "after";

          if (reminderUnitCol) {
            reminderUnitCol.style.display = hasType ? "flex" : "none";
          }
          if (reminderTimeCol) {
            reminderTimeCol.style.display = hasType ? "flex" : "none";
          }
        }

        function toggleReminderTime() {
          const hasUnit = reminderUnitSelect && reminderUnitSelect.value !== "";
          if (!hasUnit || reminderUnitSelect.value === "immediately") {
            if (reminderTimeGroup) reminderTimeGroup.style.display = "none";
          } else {
            if (reminderTimeGroup) reminderTimeGroup.style.display = "block";
          }
        }

        if (reminderTypeSelect)
          reminderTypeSelect.addEventListener("change", toggleReminderUnit);
        if (reminderUnitSelect)
          reminderUnitSelect.addEventListener("change", toggleReminderTime);
        // تهيئة أولية
        toggleReminderUnit();
        toggleReminderTime();

        // دوال إدارة متغيرات القوالب
        function toggleTemplateVariables() {
          const templateSelect = document.getElementById("action-template");
          const variablesSection =
            document.getElementById("template-variables");

          if (templateSelect && variablesSection) {
            if (templateSelect.value === "custom") {
              variablesSection.style.display = "block";
            } else {
              variablesSection.style.display = "none";
            }
            updateTemplatePreview();
          }
        }

        // وظائف المتغيرات
        window.showVariableList = function (variableId) {
          const list = document.getElementById(variableId + "List");
          if (list) {
            list.style.display =
              list.style.display === "none" ? "block" : "none";
          }
        };

        window.searchVariables = function (variableId, searchTerm) {
          const options = document.querySelectorAll(
            `#${variableId}List .wd-variable-option`
          );
          searchTerm = searchTerm.toLowerCase();

          options.forEach((option) => {
            const text = option.textContent.toLowerCase();
            option.style.display = text.includes(searchTerm) ? "block" : "none";
          });
        };

        window.selectVariable = function (
          variableId,
          displayText,
          variableCode
        ) {
          const input = document.getElementById(variableId);
          const list = document.getElementById(variableId + "List");

          if (input) {
            input.value = displayText;
          }
          if (list) {
            list.style.display = "none";
          }

          // تحديث المعاينة إذا كان القالب المخصص محدد
          const templateSelect = document.getElementById("action-template");
          if (templateSelect && templateSelect.value === "custom") {
            updateTemplatePreview();
          }
        };

        // إغلاق قوائم المتغيرات عند النقر خارجها
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".wd-variable-input")) {
            document.querySelectorAll(".wd-variable-list").forEach((list) => {
              list.style.display = "none";
            });
          }
        });

        // دالة إعداد قائمة المتغيرات المنسدلة
        function setupVariablesDropdown() {
          setTimeout(() => {
            const variablesBtn = document.getElementById("variables-btn");
            const variablesDropdown =
              document.getElementById("variables-dropdown");

            console.log(
              "Setting up variables dropdown...",
              variablesBtn,
              variablesDropdown
            );

            if (variablesBtn && variablesDropdown) {
              // إضافة event listener للزر
              variablesBtn.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("Variables button clicked!");

                const isVisible = variablesDropdown.classList.contains("show");
                console.log("Dropdown is currently visible:", isVisible);

                if (isVisible) {
                  variablesDropdown.classList.remove("show");
                  console.log("Hiding dropdown");
                } else {
                  variablesDropdown.classList.add("show");
                  console.log("Showing dropdown");
                }
              });

              // إضافة event listeners للمتغيرات
              document.querySelectorAll(".wd-variable-item").forEach((item) => {
                item.addEventListener("click", function (e) {
                  e.preventDefault();
                  e.stopPropagation();

                  const variable = this.getAttribute("data-variable");
                  const textarea = document.getElementById("action-text");

                  if (textarea && variable) {
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const textAfter = textarea.value.substring(cursorPos);
                    textarea.value = textBefore + variable + textAfter;

                    // تحديث موضع المؤشر
                    const newCursorPos = cursorPos + variable.length;
                    textarea.setSelectionRange(newCursorPos, newCursorPos);
                    textarea.focus();

                    // إغلاق القائمة
                    variablesDropdown.classList.remove("show");
                  }
                });
              });

              // إغلاق القائمة عند النقر خارجها
              document.addEventListener("click", function (e) {
                if (
                  !variablesBtn.contains(e.target) &&
                  !variablesDropdown.contains(e.target)
                ) {
                  variablesDropdown.classList.remove("show");
                }
              });
            }
          }, 100);
        }

        // دالة تهيئة شريط الأدوات
        function initializeToolbar() {
          const textarea = document.getElementById("action-text");
          const boldBtn = document.getElementById("bold-btn");
          const italicBtn = document.getElementById("italic-btn");
          const linkBtn = document.getElementById("link-btn");
          const undoBtn = document.getElementById("undo-btn");
          const redoBtn = document.getElementById("redo-btn");
          const listBtn = document.getElementById("list-btn");

          let undoStack = [];
          let redoStack = [];
          let lastValue = "";

          // حفظ الحالة للتراجع
          function saveState() {
            if (textarea.value !== lastValue) {
              undoStack.push(lastValue);
              redoStack = [];
              lastValue = textarea.value;
            }
          }

          // تطبيق التنسيق
          function applyFormatting(format) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (selectedText) {
              let formattedText = "";
              switch (format) {
                case "bold":
                  formattedText = `**${selectedText}**`;
                  break;
                case "italic":
                  formattedText = `*${selectedText}*`;
                  break;
                case "link":
                  const url = prompt("أدخل الرابط:");
                  if (url) {
                    formattedText = `[${selectedText}](${url})`;
                  } else {
                    return;
                  }
                  break;
                case "list":
                  const lines = selectedText.split("\n");
                  formattedText = lines.map((line) => `• ${line}`).join("\n");
                  break;
              }

              saveState();
              textarea.value =
                textarea.value.substring(0, start) +
                formattedText +
                textarea.value.substring(end);
              textarea.setSelectionRange(start, start + formattedText.length);
              textarea.focus();
            }
          }

          // تراجع
          function undo() {
            if (undoStack.length > 0) {
              redoStack.push(textarea.value);
              textarea.value = undoStack.pop();
              lastValue = textarea.value;
            }
          }

          // إعادة
          function redo() {
            if (redoStack.length > 0) {
              undoStack.push(textarea.value);
              textarea.value = redoStack.pop();
              lastValue = textarea.value;
            }
          }

          // Event listeners
          if (boldBtn) {
            boldBtn.addEventListener("click", () => applyFormatting("bold"));
          }

          if (italicBtn) {
            italicBtn.addEventListener("click", () =>
              applyFormatting("italic")
            );
          }

          if (linkBtn) {
            linkBtn.addEventListener("click", () => applyFormatting("link"));
          }

          if (undoBtn) {
            undoBtn.addEventListener("click", undo);
          }

          if (redoBtn) {
            redoBtn.addEventListener("click", redo);
          }

          if (listBtn) {
            listBtn.addEventListener("click", () => applyFormatting("list"));
          }

          // حفظ الحالة عند الكتابة
          if (textarea) {
            textarea.addEventListener("input", saveState);
            textarea.addEventListener("keydown", function (e) {
              if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                  case "z":
                    if (e.shiftKey) {
                      e.preventDefault();
                      redo();
                    } else {
                      e.preventDefault();
                      undo();
                    }
                    break;
                  case "y":
                    e.preventDefault();
                    redo();
                    break;
                }
              }
            });
          }
        }

        function initializeEmailToolbar() {
          const textarea = document.getElementById("email-body");
          const boldBtn = document.getElementById("email-bold-btn");
          const italicBtn = document.getElementById("email-italic-btn");
          const linkBtn = document.getElementById("email-link-btn");
          const undoBtn = document.getElementById("email-undo-btn");
          const redoBtn = document.getElementById("email-redo-btn");
          const listBtn = document.getElementById("email-list-btn");
          const variablesBtn = document.getElementById("email-variables-btn");
          const variablesDropdown = document.getElementById(
            "email-variables-dropdown"
          );

          if (!textarea) return;

          let undoStack = [];
          let redoStack = [];
          let lastValue = textarea.value;

          function saveState() {
            if (textarea.value !== lastValue) {
              undoStack.push(lastValue);
              redoStack = [];
              lastValue = textarea.value;
            }
          }

          function applyFormatting(format) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (!selectedText) return;

            let formattedText = "";
            switch (format) {
              case "bold":
                formattedText = `**${selectedText}**`;
                break;
              case "italic":
                formattedText = `*${selectedText}*`;
                break;
              case "link":
                const url = prompt("أدخل الرابط:");
                if (!url) return;
                formattedText = `[${selectedText}](${url})`;
                break;
              case "list":
                formattedText = selectedText
                  .split("\n")
                  .map((line) => `• ${line}`)
                  .join("\n");
                break;
            }

            saveState();
            textarea.value =
              textarea.value.substring(0, start) +
              formattedText +
              textarea.value.substring(end);
            textarea.setSelectionRange(start, start + formattedText.length);
            textarea.focus();
          }

          function undo() {
            if (undoStack.length > 0) {
              redoStack.push(textarea.value);
              textarea.value = undoStack.pop();
              lastValue = textarea.value;
            }
          }

          function redo() {
            if (redoStack.length > 0) {
              undoStack.push(textarea.value);
              textarea.value = redoStack.pop();
              lastValue = textarea.value;
            }
          }

          if (boldBtn)
            boldBtn.addEventListener("click", () => applyFormatting("bold"));
          if (italicBtn)
            italicBtn.addEventListener("click", () =>
              applyFormatting("italic")
            );
          if (linkBtn)
            linkBtn.addEventListener("click", () => applyFormatting("link"));
          if (listBtn)
            listBtn.addEventListener("click", () => applyFormatting("list"));
          if (undoBtn) undoBtn.addEventListener("click", undo);
          if (redoBtn) redoBtn.addEventListener("click", redo);

          if (variablesBtn && variablesDropdown) {
            const variableItems =
              variablesDropdown.querySelectorAll(".wd-variable-item");

            function hideDropdown() {
              variablesDropdown.classList.remove("show");
              document.removeEventListener("click", outsideHandler);
            }

            function outsideHandler(event) {
              if (
                !variablesDropdown.contains(event.target) &&
                !variablesBtn.contains(event.target)
              ) {
                hideDropdown();
              }
            }

            variablesBtn.addEventListener("click", function (e) {
              e.preventDefault();
              e.stopPropagation();
              if (variablesDropdown.classList.contains("show")) {
                hideDropdown();
              } else {
                variablesDropdown.classList.add("show");
                document.addEventListener("click", outsideHandler);
              }
            });

            variableItems.forEach((item) => {
              item.addEventListener("click", function (event) {
                event.preventDefault();
                const variable = this.getAttribute("data-variable");
                if (!variable) return;

                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;

                saveState();
                textarea.value =
                  textarea.value.substring(0, start) +
                  variable +
                  textarea.value.substring(end);
                const cursor = start + variable.length;
                textarea.setSelectionRange(cursor, cursor);
                textarea.focus();
                hideDropdown();
              });
            });
          }

          textarea.addEventListener("input", saveState);
          textarea.addEventListener("keydown", function (e) {
            if (e.ctrlKey || e.metaKey) {
              switch (e.key.toLowerCase()) {
                case "z":
                  e.preventDefault();
                  if (e.shiftKey) {
                    redo();
                  } else {
                    undo();
                  }
                  break;
                case "y":
                  e.preventDefault();
                  redo();
                  break;
              }
            }
          });
        }
      })();
    </script>
  </body>
</html>
