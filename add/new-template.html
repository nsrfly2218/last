<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>إضافة قالب جديد</title>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    html,
    body {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    .wd-template-layout {
      display: flex;
      gap: 20px;
      height: calc(100vh - 100px);
    }

    .wd-category-box {
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    .wd-category-title {
      margin: 0 0 6px 0;
      color: #1f2937;
      font-size: 17px;
      font-weight: 700;
    }

    .wd-category-description {
      margin: 0 0 14px 0;
      color: #6b7280;
      font-size: 13px;
      line-height: 1.6;
    }

    .wd-category-tabs {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 14px;
      width: 100%;
    }

    .wd-category-tab {
      width: 100%;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #374151;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      font-weight: 600;
    }

    .wd-category-tab.active {
      border-color: #9dd7b5;
      background: #eefaf2;
      color: #2f6b45;
      box-shadow: inset 0 -2px 0 #9dd7b5;
    }

    .wd-category-options {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      background: #f8fafc;
      border: 1px solid #eef2f7;
      border-radius: 10px;
      padding: 10px;
    }

    .wd-category-options.active {
      display: grid;
    }

    .wd-category-option {
      border: 1px solid #e5e7eb;
      background: #fff;
      border-radius: 8px;
      padding: 9px 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: right;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .wd-category-option::before {
      content: "";
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #c8ced8;
      background: #fff;
      flex-shrink: 0;
    }

    .wd-category-option .wd-option-label {
      display: block;
      color: #1f2937;
      font-size: 12.5px;
      font-weight: 500;
    }

    .wd-category-option .wd-option-note {
      display: block;
      margin-top: 3px;
      color: #9ca3af;
      font-size: 11px;
    }

    .wd-category-option.selected {
      border-color: #9dd7b5;
      background: #eefaf2;
    }

    .wd-category-option.selected::before {
      border-color: #63b285;
      background: #63b285;
      box-shadow: inset 0 0 0 2px #fff;
    }

    @media (max-width: 900px) {
      .wd-category-tabs {
        grid-template-columns: 1fr;
      }
    }

    .wd-template-form {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .wd-template-form::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    .wd-template-preview {
      width: 350px;
      background: #e5ddd5 url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 20h20v20H0V20zm20 0h20v20H20V20zm20 0h20v20H40V20zm20-20h20v20H60V0zm0 20h20v20H60V20zm20-20h20v20H80V0zm0 20h20v20H80V20zm0 20h20v20H80V40zm20-20h20v20h-20V20zM0 40h20v20H0V40zm20 0h20v20H20V40zm20 0h20v20H40V40zm20-20h20v20H60V20zm0 20h20v20H60V40zm20-20h20v20H80V20zm0 20h20v20H80V40zm0 20h20v20H80V60zm20-20h20v20h-20V40zM0 60h20v20H0V60zm20 0h20v20H20V60zm20 0h20v20H40V60zm20-20h20v20H60V40zm0 20h20v20H60V60z' fill='%23cccccc' fill-opacity='0.12' fill-rule='evenodd'/%3E%3C/svg%3E");
      padding: 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      height: 400px;
    }

    /* Remove the mobile-like frame elements */
    .wd-template-preview::before,
    .wd-template-preview::after {
      display: none;
    }

    /* Hide the WhatsApp header */
    .wd-whatsapp-header {
      display: none;
    }

    /* Fixed height to keep consistent size */
    .wd-preview-content {
      flex: 1;
      background: transparent;
      padding: 20px;
      border-radius: 0;
      overflow-y: auto;
      height: 100%;
      display: flex;
      flex-direction: column;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .wd-preview-content::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    /* Make the message bubble look more like WhatsApp with fixed width */
    .wd-preview-message {
      background: #fff;
      border-radius: 7.5px 7.5px 7.5px 0;
      padding: 10px 12px;
      margin-bottom: 0;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 85%;
      width: 280px;
      min-height: 45px;
      align-self: flex-start;
      position: relative;
    }

    /* Fixed size and styling for the buttons to match the message width */
    .wd-preview-buttons {
      margin-top: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: white;
      padding: 0;
      margin-right: 0;
      max-width: 85%;
      width: 280px;
      /* Same width as message */
      align-self: flex-start;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      border-radius: 0 0 7.5px 7.5px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    /* Style buttons to match WhatsApp buttons */
    .wd-preview-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 10px 12px;
      background: white;
      color: #128c7e;
      border: none;
      border-top: 1px solid #f0f0f0;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      text-align: center;
      outline: none;
      transition: background-color 0.2s;
    }

    .wd-preview-button:hover {
      background: #f5f6f6;
    }

    .wd-preview-button i {
      font-size: 16px;
      color: #128c7e;
    }

    /* WhatsApp footer with input box - hide it */
    .wd-whatsapp-footer {
      display: none;
    }

    .wd-preview-header {
      padding: 10px 15px;
      background: #075e54;
      color: white;
      margin-bottom: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
    }

    .wd-whatsapp-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #128c7e;
      margin-left: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wd-whatsapp-header .avatar i {
      font-size: 20px;
    }

    .wd-whatsapp-header .contact-info {
      flex: 1;
    }

    .wd-whatsapp-header .contact-name {
      font-weight: bold;
      font-size: 16px;
    }

    .wd-whatsapp-header .contact-status {
      font-size: 12px;
      opacity: 0.8;
    }

    .wd-whatsapp-header .icons {
      display: flex;
      gap: 15px;
    }

    .wd-whatsapp-header .icons i {
      font-size: 18px;
    }

    .wd-preview-header h3 {
      margin: 0 0 10px 0;
      color: white;
      font-size: 18px;
    }

    .wd-preview-type {
      display: inline-block;
      padding: 4px 12px;
      background: #4a90e2;
      color: white;
      border-radius: 16px;
      font-size: 14px;
    }

    .wd-preview-content {
      flex: 1;
      background: transparent;
      padding: 20px;
      border-radius: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .wd-preview-message {
      background: #fff;
      border-radius: 7.5px 7.5px 7.5px 0;
      padding: 10px 12px 10px 12px;
      margin-bottom: 0;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 85%;
      width: 280px;
      min-height: 45px;
      align-self: flex-start;
      position: relative;
    }

    .wd-preview-message::before {
      content: "";
      position: absolute;
      top: 0;
      left: -8px;
      width: 0;
      height: 0;
      border-top: 8px solid #fff;
      border-left: 8px solid transparent;
    }

    .wd-preview-header-text {
      font-weight: bold;
      color: #075e54;
      margin-bottom: 8px;
    }

    .wd-preview-body {
      font-size: 14px;
      color: #303030;
      margin: 0;
      line-height: 19px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .wd-preview-footer {
      font-size: 12px;
      margin-top: 10px;
      padding-top: 5px;
      color: #757575;
    }

    .wd-preview-timestamp {
      text-align: left;
      font-size: 11px;
      color: #8c8c8c;
      margin-top: 5px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .wd-preview-image {
      max-width: 100%;
      margin: 0 0 8px 0;
      border-radius: 6px;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
    }

    .wd-preview-doc {
      background: #f5f6f6;
      padding: 15px;
      margin: 0 0 8px 0;
      border-radius: 6px;
      text-align: center;
    }

    .wd-preview-location {
      background: #f5f6f6;
      padding: 10px;
      margin: 0 0 8px 0;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .wd-location-icon {
      color: #128c7e;
      font-size: 20px;
    }

    .wd-preview-buttons {
      margin-top: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: transparent;
      padding: 0;
      margin-right: 0;
      max-width: 85%;
      width: 280px;
      align-self: flex-start;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      border-radius: 0 0 7.5px 7.5px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .wd-preview-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      background: #fff;
      color: #039be5;
      border: none;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14.2px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
      height: auto;
      margin: 0;
      width: 100%;
      border-radius: 0;
    }

    .wd-preview-button:first-child {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }

    .wd-preview-button:last-child {
      border-bottom-left-radius: 7.5px;
      border-bottom-right-radius: 7.5px;
      border-bottom: none;
    }

    .wd-preview-button i {
      margin-left: 8px;
      font-size: 16px;
      color: #039be5;
    }

    .wd-preview-button:hover {
      background: #f5f5f5;
    }

    .wd-preview-carousel-slider {
      width: 280px;
      max-width: 85%;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      margin-top: 8px;
      align-self: flex-start;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .wd-preview-carousel-slider::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    .wd-preview-carousel-card {
      min-width: 240px;
      max-width: 240px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      overflow: hidden;
      flex-shrink: 0;
    }

    .wd-preview-carousel-media {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block;
      background: #f3f4f6;
    }

    .wd-preview-carousel-body {
      padding: 9px 10px;
      font-size: 13px;
      line-height: 1.5;
      color: #303030;
      border-top: 1px solid #f3f4f6;
    }

    .wd-preview-carousel-actions {
      border-top: 1px solid #f3f4f6;
    }

    .wd-preview-carousel-action {
      width: 100%;
      border: none;
      border-top: 1px solid #f3f4f6;
      background: #fff;
      color: #039be5;
      font-size: 12.5px;
      padding: 8px 10px;
      cursor: default;
      text-align: center;
    }

    .wd-preview-carousel-action:first-child {
      border-top: none;
    }

    .wd-preview-product-wrap {
      width: 280px;
      max-width: 85%;
      align-self: flex-start;
      margin-bottom: 8px;
    }

    .wd-preview-product-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
      overflow: hidden;
    }

    .wd-preview-product-image {
      width: 100%;
      height: 130px;
      background: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 12px;
      gap: 4px;
    }

    .wd-preview-product-image i {
      font-size: 18px;
    }

    .wd-preview-product-info {
      padding: 10px;
      border-top: 1px solid #f3f4f6;
    }

    .wd-preview-product-name {
      font-size: 13px;
      color: #1f2937;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .wd-preview-product-price {
      font-size: 12px;
      color: #6b7280;
    }

    .wd-preview-product-action {
      width: 100%;
      border: none;
      border-top: 1px solid #f3f4f6;
      background: #fff;
      color: #039be5;
      font-size: 13px;
      padding: 9px 10px;
      text-align: center;
      cursor: default;
    }

    .wd-preview-products-slider {
      width: 280px;
      max-width: 85%;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      align-self: flex-start;
      margin-bottom: 8px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .wd-preview-products-slider::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    .wd-preview-products-slider .wd-preview-product-card {
      min-width: 200px;
      max-width: 200px;
      flex-shrink: 0;
    }

    .wd-form-section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .wd-section-title {
      margin: 0 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      color: #333;
      font-size: 18px;
    }

    .wd-form-group {
      margin-bottom: 20px;
    }

    .wd-form-group:last-child {
      margin-bottom: 0;
    }

    .wd-carousel-cards-box {
      margin-top: 18px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fafafa;
      padding: 14px;
    }

    .wd-carousel-cards-title {
      margin: 0 0 12px 0;
      font-size: 15px;
      color: #374151;
    }

    .wd-carousel-cards-config {
      display: grid;
      grid-template-columns: repeat(4, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .wd-carousel-cards-config .wd-form-group {
      margin-bottom: 0;
    }

    .wd-carousel-cards-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .wd-carousel-card-tab {
      border: 1px solid #d1d5db;
      background: #fff;
      color: #374151;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .wd-carousel-card-tab.active {
      border-color: #9dd7b5;
      background: #eefaf2;
      color: #2f6b45;
      font-weight: 600;
    }

    .wd-carousel-card-panel {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      padding: 12px;
    }

    .wd-carousel-card-buttons-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }

    @media (max-width: 1100px) {
      .wd-carousel-cards-config {
        grid-template-columns: repeat(2, minmax(150px, 1fr));
      }
    }

    .wd-template-main-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      align-items: start;
    }

    .wd-template-main-fields .wd-form-group {
      margin-bottom: 0;
    }

    .wd-action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .wd-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .wd-btn-secondary {
      background: #f8f9fa;
      border: 1px solid #ddd;
      color: #333;
    }

    .wd-btn-secondary:hover {
      background: #e9ecef;
    }

    .wd-btn-primary {
      background: #4a90e2;
      border: none;
      color: white;
    }

    .wd-btn-primary:hover {
      background: #357abd;
    }

    .wd-variables-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .wd-variables-section h4 {
      margin: 0 0 15px 0;
      color: #333;
    }

    .wd-variable-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .wd-variable-label {
      min-width: 80px;
      font-weight: 500;
    }

    .wd-variable-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* إضافة أنماط جديدة */
    .wd-preview-frame {
      margin: 0 0 8px 0;
      text-align: center;
      display: block;
      border-radius: 6px;
      overflow: hidden;
    }

    .wd-preview-frame img {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
    }

    .wd-preview-frame video {
      width: 100%;
      max-height: 200px;
    }

    .wd-preview-frame .wd-file-icon {
      font-size: 48px;
      color: #65676b;
      margin: 10px 0;
    }

    .wd-preview-frame .wd-location-icon {
      font-size: 24px;
      color: #4a90e2;
      margin-right: 8px;
    }

    .wd-optional {
      color: #666;
      font-size: 14px;
      margin-right: 5px;
    }

    .wd-buttons-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #666;
      font-size: 14px;
      line-height: 1.5;
    }

    .wd-text-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .wd-text-controls button {
      padding: 6px 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .wd-text-controls button:hover {
      background: #e9ecef;
    }

    .wd-text-controls button.active {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }

    /* أنماط السحب والإفلات */
    .wd-draggable-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .wd-button-group {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: move;
      transition: all 0.3s ease;
    }

    .wd-button-group:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .wd-button-group.dragging {
      opacity: 0.5;
      border: 2px dashed #4a90e2;
    }

    .wd-button-group .wd-button-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .wd-button-group .wd-button-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .wd-button-group .wd-button-actions {
      display: flex;
      gap: 8px;
    }

    .wd-button-group .wd-button-action {
      padding: 4px 8px;
      border: none;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .wd-button-group .wd-button-action:hover {
      background: #e9ecef;
    }

    .wd-button-group .wd-button-action.delete {
      color: #dc3545;
    }

    .wd-button-group .wd-button-action.delete:hover {
      background: #dc3545;
      color: white;
    }

    .wd-form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .wd-form-col {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .wd-form-col.button-text {
      flex: 1;
    }


    .wd-form-col.button-value {
      flex: 3;
    }

    /* إضافة أنماط جديدة للعدادات */
    .wd-char-counter {
      font-size: 12px;
      color: #666;
      text-align: left;
      margin-top: 5px;
    }

    .wd-char-counter.error {
      color: #dc3545;
    }

    /* إضافة أنماط جديدة للمعاينة */
    .wd-preview-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .wd-preview-name {
      font-weight: 500;
      color: #333;
    }

    .wd-preview-language {
      color: #666;
      font-size: 14px;
    }

    .wd-preview-type {
      display: inline-block;
      padding: 4px 12px;
      background: #4a90e2;
      color: white;
      border-radius: 16px;
      font-size: 14px;
    }

    .wd-preview-type.marketing {
      background: #4a90e2;
    }

    .wd-preview-type.utility {
      background: #28a745;
    }

    .wd-preview-type.authentication {
      background: #dc3545;
    }

    .wd-preview-type.carousel {
      background: #ffc107;
      color: #333;
    }

    .wd-preview-type.product-card-slider {
      background: #17a2b8;
    }

    .wd-preview-type.single-product {
      background: #6f42c1;
    }

    .wd-preview-type.multiple-products {
      background: #fd7e14;
    }

    /* إضافة أنماط جديدة للنافذة المنبثقة للمتغيرات */
    .wd-variables-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 400px;
      max-width: 90%;
    }

    .wd-variables-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .wd-variables-popup-title {
      font-size: 18px;
      font-weight: 500;
      color: #333;
    }

    .wd-variables-popup-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }

    .wd-variables-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    .wd-variable-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
    }

    .wd-variable-item:hover {
      background: #e9ecef;
    }

    .wd-variable-text {
      flex: 1;
    }

    .wd-variable-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 5px;
    }

    .wd-variables-popup-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .wd-whatsapp-footer {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #f0f0f0;
      border-top: 1px solid #d1d1d1;
    }

    .wd-whatsapp-input {
      flex: 1;
      display: flex;
      align-items: center;
      background: white;
      border-radius: 18px;
      padding: 8px 15px;
      margin: 0 8px;
    }

    .wd-whatsapp-input span {
      color: #999;
      font-size: 14px;
    }

    .wd-whatsapp-footer .wd-icon {
      width: 24px;
      height: 24px;
      color: #919191;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
    }

    .wd-preview-date {
      text-align: center;
      margin: 10px 0;
      font-size: 12.5px;
      color: #54656f;
      background: rgba(225, 245, 254, 0.92);
      border-radius: 7.5px;
      padding: 5px 12px;
      display: inline-block;
      align-self: center;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }

    /* تنسيقات رسائل الخطأ */
    .wd-error-message {
      display: none;
      color: #dc3545;
      font-size: 13px;
      margin-top: 6px;
      padding: 8px 12px;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      border-right: 4px solid #dc3545;
      line-height: 1.5;
      animation: slideDown 0.3s ease-out;
    }

    .wd-error-message::before {
      content: "\f071";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      margin-left: 8px;
      color: #dc3545;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* تنسيقات الحقول التي تحتوي على خطأ */
    .wd-form-control.error,
    .wd-form-control:invalid {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .wd-form-control.error:focus,
    .wd-form-control:invalid:focus {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    /* تنسيق علامة المطلوب */
    .wd-required {
      color: #dc3545;
      font-weight: bold;
      margin-right: 3px;
    }

    /* تنسيقات Switch */
    .wd-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .wd-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .wd-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .wd-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    .wd-switch input:checked+.wd-slider {
      background-color: #2ecc71;
    }

    .wd-switch input:focus+.wd-slider {
      box-shadow: 0 0 1px #2ecc71;
    }

    .wd-switch input:checked+.wd-slider:before {
      transform: translateX(26px);
    }
  </style>
</head>

<body>
  <div class="wd-container">
    <!-- القسم الأول: القائمة الجانبية -->
    <aside class="wd-sidebar">
      <div class="wd-logo">
        <img src="../imgs/logo.png" alt="شعار المنصة" />
      </div>
      <nav class="wd-nav">
        <ul>
          <li class="wd-nav-item">
            <i class="fa-solid fa-gauge"></i>
            <span><a href="../index.html" class="wd-nav-link">لوحة التحكم</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-comments"></i>
            <span><a href="../chat.html" class="wd-nav-link">المحادثات</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-users"></i>
            <span><a href="../contacts.html" class="wd-nav-link">جهات الاتصال</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fa-solid fa-diagram-project"></i>
            <span><a href="../flows.html" class="wd-nav-link">التدفقات</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-bullhorn"></i>
            <span><a href="../campaigns.html" class="wd-nav-link">الحملات</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-calendar"></i>
            <span><a href="../calendar.html" class="wd-nav-link">التقويم</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-file-alt"></i>
            <span><a href="../contents.html" class="wd-nav-link">المحتويات</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-code"></i>
            <span><a href="../developers.html" class="wd-nav-link">المطورين</a></span>
          </li>
          <li class="wd-nav-item">
            <i class="fas fa-cog"></i>
            <span><a href="../settings.html" class="wd-nav-link">الإعدادات</a></span>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- القسم الثاني: المحتوى الرئيسي -->
    <main class="wd-main-content" style="right: 65px">
      <div class="wd-content-header" style="right: 65px">
        <div class="wd-header-left">
          <button class="wd-back-btn" onclick="window.location.href='../contents.html'">
            <i class="fas fa-arrow-right"></i>
          </button>
          <h1>إضافة قالب جديد</h1>
        </div>
      </div>

      <div class="wd-content-body" style="right: 65px">
        <div class="wd-template-layout">
          <div class="wd-template-form">
            <div class="wd-category-box">
              <h3 class="wd-category-title">اختيار الفئة</h3>
              <p class="wd-category-description">
                اختر فئة القالب ثم حدد النوع المناسب من الخيارات المتاحة لكل فئة.
              </p>

              <div class="wd-category-tabs">
                <button type="button" class="wd-category-tab active" data-category-tab="marketing"
                  onclick="switchTemplateCategoryTab('marketing')">
                  تسويق
                </button>
                <button type="button" class="wd-category-tab" data-category-tab="utility"
                  onclick="switchTemplateCategoryTab('utility')">
                  أداة مساعدة
                </button>
                <button type="button" class="wd-category-tab" data-category-tab="authentication"
                  onclick="switchTemplateCategoryTab('authentication')">
                  المصادقة
                </button>
              </div>

              <div class="wd-category-options active" data-category-options="marketing">
                <div class="wd-category-option selected" data-template-value="marketing"
                  onclick="selectTemplateCategoryOption(this, 'marketing')">
                  <span class="wd-option-label">افتراضي</span>
                </div>
                <div class="wd-category-option" data-template-value="carousel"
                  onclick="selectTemplateCategoryOption(this, 'marketing')">
                  <span class="wd-option-label">عرض متعدد البطاقات</span>
                </div>
                <div class="wd-category-option" data-template-value="single-product"
                  onclick="selectTemplateCategoryOption(this, 'marketing')">
                  <span class="wd-option-label">منتج واحد</span>
                </div>
                <div class="wd-category-option" data-template-value="multiple-products"
                  onclick="selectTemplateCategoryOption(this, 'marketing')">
                  <span class="wd-option-label">متعدد المنتجات</span>
                </div>
                <div class="wd-category-option" data-template-value="product-card-slider"
                  onclick="selectTemplateCategoryOption(this, 'marketing')">
                  <span class="wd-option-label">عرض متعدد لبطاقات المنتجات</span>
                </div>
              </div>

              <div class="wd-category-options" data-category-options="utility">
                <div class="wd-category-option selected" data-template-value="utility"
                  onclick="selectTemplateCategoryOption(this, 'utility')">
                  <span class="wd-option-label">افتراضي</span>
                </div>
              </div>

              <div class="wd-category-options" data-category-options="authentication">
                <div class="wd-category-option selected" data-template-value="authentication"
                  onclick="selectTemplateCategoryOption(this, 'authentication')">
                  <span class="wd-option-label">رمز المرور لمرة واحدة</span>
                </div>
              </div>
              <input type="hidden" id="templateType" value="marketing" />
              <div class="wd-error-message" id="templateTypeError" style="display: none"></div>
            </div>

            <!-- قسم اسم، لغة وفئة القالب -->
            <div class="wd-form-section">
              <h3 class="wd-section-title">اسم ولغة القالب</h3>
              <div class="wd-template-main-fields">
                <div class="wd-form-group">
                  <label for="templateName">اسم القالب <span class="wd-required">*</span></label>
                  <input type="text" id="templateName" class="wd-form-control"
                    placeholder="أدخل اسم القالب (أحرف إنجليزية و _ فقط)" oninput="validateTemplateName(this)"
                    maxlength="512" pattern="[A-Za-z_]+" title="يجب أن يحتوي اسم القالب على أحرف إنجليزية و _ فقط" />
                  <div class="wd-char-counter" id="templateNameCounter">
                    0/512
                  </div>
                  <div class="wd-error-message" id="templateNameError"></div>
                </div>

                <div class="wd-form-group">
                  <label for="templateLanguage">اللغة <span class="wd-required">*</span></label>
                  <select id="templateLanguage" class="wd-form-control" onchange="updateTemplatePreview()">
                    <option value="">اختر لغة القالب</option>
                    <option value="af">Afrikaans</option>
                    <option value="sq">Albanian</option>
                    <option value="ar">Arabic</option>
                    <option value="az">Azerbaijani</option>
                    <option value="bn">Bengali</option>
                    <option value="bg">Bulgarian</option>
                    <option value="ca">Catalan</option>
                    <option value="zh_CN">Chinese (CHN)</option>
                    <option value="zh_HK">Chinese (HKG)</option>
                    <option value="zh_TW">Chinese (TAI)</option>
                    <option value="hr">Croatian</option>
                    <option value="cs">Czech</option>
                    <option value="da">Danish</option>
                    <option value="nl">Dutch</option>
                    <option value="en">English</option>
                    <option value="en_GB">English (UK)</option>
                    <option value="en_US">English (US)</option>
                    <option value="et">Estonian</option>
                    <option value="fil">Filipino</option>
                    <option value="fi">Finnish</option>
                    <option value="fr">French</option>
                    <option value="ka">Georgian</option>
                    <option value="de">German</option>
                    <option value="el">Greek</option>
                    <option value="gu">Gujarati</option>
                    <option value="ha">Hausa</option>
                    <option value="he">Hebrew</option>
                    <option value="hi">Hindi</option>
                    <option value="hu">Hungarian</option>
                    <option value="id">Indonesian</option>
                    <option value="ga">Irish</option>
                    <option value="it">Italian</option>
                    <option value="ja">Japanese</option>
                    <option value="kn">Kannada</option>
                    <option value="kk">Kazakh</option>
                    <option value="ky_KG">Kyrgyz (Kyrgyzstan)</option>
                    <option value="lo">Lao</option>
                    <option value="lv">Latvian</option>
                    <option value="lt">Lithuanian</option>
                    <option value="mk">Macedonian</option>
                    <option value="ms">Malay</option>
                    <option value="ml">Malayalam</option>
                    <option value="mr">Marathi</option>
                    <option value="nb">Norwegian</option>
                    <option value="fa">Persian</option>
                    <option value="pl">Polish</option>
                    <option value="pt_BR">Portuguese (BR)</option>
                    <option value="pt_PT">Portuguese (POR)</option>
                    <option value="pa">Punjabi</option>
                    <option value="ro">Romanian</option>
                    <option value="ru">Russian</option>
                    <option value="sr">Serbian</option>
                    <option value="sk">Slovak</option>
                    <option value="sl">Slovenian</option>
                    <option value="es">Spanish</option>
                    <option value="es_AR">Spanish (ARG)</option>
                    <option value="es_ES">Spanish (SPA)</option>
                    <option value="es_MX">Spanish (MEX)</option>
                    <option value="sw">Swahili</option>
                    <option value="sv">Swedish</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                    <option value="th">Thai</option>
                    <option value="tr">Turkish</option>
                    <option value="uk">Ukrainian</option>
                    <option value="ur">Urdu</option>
                    <option value="uz">Uzbek</option>
                    <option value="vi">Vietnamese</option>
                    <option value="zu">Zulu</option>
                  </select>
                  <div class="wd-error-message" id="templateLanguageError"></div>
                </div>
              </div>
            </div>

            <!-- قسم المحتوى -->
            <div class="wd-form-section" id="contentSection">
              <h3 class="wd-section-title">المحتوى</h3>
              <div class="wd-form-group">
                <label for="templateHeader">رأس الرسالة
                  <span id="headerRequired" style="display: none; color: #dc3545; margin-right: 5px">*</span>
                </label>
                <select id="templateHeader" class="wd-form-control" onchange="handleHeaderChange()">
                  <option value="none">بدون</option>
                  <option value="text">نص</option>
                  <option value="image">صورة</option>
                  <option value="video">فيديو</option>
                  <option value="document">ملف</option>
                  <option value="location">موقع</option>
                </select>
                <div class="wd-error-message" id="templateHeaderError"></div>
              </div>

              <!-- حقول رأس الرسالة -->
              <div id="headerFields" style="display: none">
                <div class="wd-form-group" id="headerTextGroup" style="display: none">
                  <label for="headerText">نص الرأس <span class="wd-required">*</span></label>
                  <input type="text" id="headerText" class="wd-form-control" placeholder="أدخل نص الرأس"
                    oninput="updateTemplatePreview()" maxlength="60" />
                  <div class="wd-char-counter" id="headerTextCounter">
                    0/60
                  </div>
                  <div class="wd-error-message" id="headerTextError"></div>
                </div>

                <div class="wd-form-group" id="headerImageGroup" style="display: none">
                  <label for="headerImage">صورة الرأس <span class="wd-required">*</span></label>
                  <input type="file" id="headerImage" class="wd-form-control" accept="image/*"
                    onchange="updateTemplatePreview()" />
                  <div class="wd-error-message" id="headerImageError"></div>
                </div>

                <div class="wd-form-group" id="headerVideoGroup" style="display: none">
                  <label for="headerVideo">فيديو الرأس <span class="wd-required">*</span></label>
                  <input type="file" id="headerVideo" class="wd-form-control" accept="video/*"
                    onchange="updateTemplatePreview()" />
                  <div class="wd-error-message" id="headerVideoError"></div>
                </div>

                <div class="wd-form-group" id="headerDocumentGroup" style="display: none">
                  <label for="headerDocument">ملف الرأس <span class="wd-required">*</span></label>
                  <input type="file" id="headerDocument" class="wd-form-control" onchange="updateTemplatePreview()" />
                  <div class="wd-error-message" id="headerDocumentError"></div>
                </div>

                <div class="wd-form-group" id="headerLocationGroup" style="display: none">
                  <label for="headerLocation">موقع الرأس <span class="wd-required">*</span></label>
                  <input type="text" id="headerLocation" class="wd-form-control" placeholder="أدخل عنوان الموقع"
                    oninput="updateTemplatePreview()" />
                  <div class="wd-error-message" id="headerLocationError"></div>
                </div>
              </div>

              <div class="wd-form-group">
                <label for="templateContent">محتوى القالب <span class="wd-required">*</span></label>
                <div class="wd-text-controls">
                  <button onclick="formatText('emoji')" title="إضافة إيموجي">
                    <i class="far fa-smile"></i>
                  </button>
                  <button onclick="formatText('bold')" title="نص عريض">
                    <i class="fas fa-bold"></i>
                  </button>
                  <button onclick="formatText('italic')" title="نص مائل">
                    <i class="fas fa-italic"></i>
                  </button>
                  <button onclick="formatText('strikethrough')" title="يتوسطه خط">
                    <i class="fas fa-strikethrough"></i>
                  </button>
                  <button onclick="formatText('spacing')" title="تعديل المسافات">
                    <i class="fas fa-text-width"></i>
                  </button>
                  <button onclick="showVariables()" title="إضافة متغير">
                    <i class="fas fa-code"></i>
                  </button>
                </div>
                <textarea id="templateContent" class="wd-form-control" rows="6" placeholder="أدخل محتوى القالب"
                  oninput="updateTemplatePreview()" maxlength="1024"></textarea>
                <div class="wd-char-counter" id="templateContentCounter">
                  0/1024
                </div>
                <div class="wd-error-message" id="templateContentError"></div>
              </div>

              <div class="wd-form-group">
                <label for="templateFooter">تذييل الرسالة
                  <span class="wd-optional">· اختياري</span></label>
                <input type="text" id="templateFooter" class="wd-form-control"
                  placeholder="أدخل تذييل الرسالة (أحرف وأرقام فقط)" oninput="validateFooterInput(this)" maxlength="60"
                  pattern="[A-Za-z0-9\u0600-\u06FF\s]*" title="يُسمح فقط بالأحرف والأرقام" />
                <div class="wd-char-counter" id="templateFooterCounter">
                  0/60
                </div>
                <div class="wd-error-message" id="templateFooterError"></div>
              </div>

              <div class="wd-carousel-cards-box" id="carouselCardsSection" style="display: none">
                <h4 class="wd-carousel-cards-title">البطاقات</h4>
                <div class="wd-carousel-cards-config">
                  <div class="wd-form-group">
                    <label for="carouselCardsCount">العدد</label>
                    <select id="carouselCardsCount" class="wd-form-control"
                      onchange="handleCarouselCardsConfigChange()">
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                  <div class="wd-form-group">
                    <label for="carouselCardsHeaderType">رأس</label>
                    <select id="carouselCardsHeaderType" class="wd-form-control"
                      onchange="handleCarouselCardsConfigChange()">
                      <option value="image">صورة</option>
                      <option value="video">فيديو</option>
                    </select>
                  </div>
                  <div class="wd-form-group">
                    <label for="carouselCardsButton1Type">زر 1</label>
                    <select id="carouselCardsButton1Type" class="wd-form-control"
                      onchange="handleCarouselCardsConfigChange()">
                      <option value="none">بدون</option>
                      <option value="quick_reply">رد سريع</option>
                      <option value="phone">الهاتف</option>
                      <option value="link">رابط</option>
                    </select>
                  </div>
                  <div class="wd-form-group">
                    <label for="carouselCardsButton2Type">زر 2</label>
                    <select id="carouselCardsButton2Type" class="wd-form-control"
                      onchange="handleCarouselCardsConfigChange()">
                      <option value="none">بدون</option>
                      <option value="quick_reply">رد سريع</option>
                      <option value="phone">الهاتف</option>
                      <option value="link">رابط</option>
                    </select>
                  </div>
                </div>
                <div class="wd-carousel-cards-tabs" id="carouselCardsTabs"></div>
                <div class="wd-carousel-cards-content" id="carouselCardsPanels"></div>
                <div class="wd-error-message" id="carouselCardsError" style="display: none; margin-top: 10px;"></div>
              </div>
            </div>

            <!-- قسم الأزرار -->
            <div class="wd-form-section" id="buttonsSection">
              <h3 class="wd-section-title">الأزرار</h3>
              <div class="wd-buttons-info">
                يمكنك إنشاء أزرار تتيح للعملاء الرد على رسالتك أو اتخاذ إجراء.
                يمكنك إضافة ما يصل إلى 10 أزرار. وفي حالة إضافة أكثر من 3
                أزرار، ستظهر في قائمة.
              </div>
              <div class="wd-form-group">
                <label>أزرار الإجراءات
                  <span class="wd-optional">· اختياري</span></label>
                <div class="wd-action-buttons">
                  <button type="button" class="wd-btn wd-btn-secondary" onclick="addQuickReplyButton()"
                    id="addQuickReplyBtn">
                    <i class="fas fa-reply"></i>
                    + رد سريع
                  </button>
                  <button type="button" class="wd-btn wd-btn-secondary" onclick="addLinkButton()" id="addLinkBtn">
                    <i class="fas fa-link"></i>
                    + رابط
                  </button>
                  <button type="button" class="wd-btn wd-btn-secondary" onclick="addPhoneButton()" id="addPhoneBtn">
                    <i class="fas fa-phone"></i>
                    + هاتف
                  </button>
                  <button type="button" class="wd-btn wd-btn-secondary" onclick="addCopyButton()" id="addCopyBtn">
                    <i class="fas fa-copy"></i>
                    + نسخ رمز
                  </button>
                </div>
              </div>

              <!-- حقول الأزرار -->
              <div id="buttonFields" class="wd-draggable-container" style="display: none">
                <!-- سيتم إضافة حقول الأزرار هنا -->
              </div>
            </div>

            <!-- قسم المصادقة -->
            <div class="wd-form-section" id="authenticationSection" style="display: none">
              <h3 class="wd-section-title">إعدادات المصادقة</h3>

              <!-- خيار تنويه الأمان -->
              <div class="wd-form-group">
                <div style="
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin-bottom: 10px;
                    ">
                  <label style="margin: 0; font-weight: 500">تنويه أمان</label>
                  <label class="wd-switch" style="margin: 0">
                    <input type="checkbox" id="securityWarningToggle" onchange="updateTemplatePreview()" />
                    <span class="wd-slider"></span>
                  </label>
                </div>
              </div>

              <!-- خيار تحذير الانتهاء -->
              <div class="wd-form-group">
                <div style="
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin-bottom: 10px;
                    ">
                  <label style="margin: 0; font-weight: 500">تحذير الانتهاء</label>
                  <label class="wd-switch" style="margin: 0">
                    <input type="checkbox" id="expirationWarningToggle" onchange="toggleExpirationInput()" />
                    <span class="wd-slider"></span>
                  </label>
                </div>

                <div id="expirationInputGroup" style="display: none; margin-top: 10px">
                  <div style="display: flex; align-items: center; gap: 10px">
                    <label style="margin: 0; font-weight: 500; white-space: nowrap">تنتهي صلاحيتها خلال</label>
                    <input type="number" id="expirationMinutes" class="wd-form-control" min="1" max="90" value="1"
                      style="width: 100px" oninput="updateTemplatePreview()" />
                    <label style="margin: 0; white-space: nowrap">دقائق.</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="wd-form-actions">
              <button class="wd-btn wd-btn-secondary" onclick="window.location.href='../contents/whatsapp.html'">
                إلغاء
              </button>
              <button class="wd-btn" onclick="createTemplate()">
                إنشاء القالب
              </button>
            </div>
          </div>

          <div class="wd-template-preview">
            <!-- WhatsApp header removed -->
            <div class="wd-preview-content" id="previewContent">
              <div class="wd-preview-frame" id="headerPreview" style="display: none">
                <!-- سيتم عرض معاينة الرأس هنا -->
              </div>
              <div class="wd-preview-message">
                <!-- سيتم عرض محتوى الرسالة هنا -->
                <div class="wd-preview-body">&nbsp;</div>
                <div class="wd-preview-timestamp">
                  00:00
                  <i class="fas fa-check-double" style="color: #34b7f1"></i>
                </div>
              </div>
            </div>
            <!-- WhatsApp footer removed -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // التحكم في إظهار/إخفاء الأقسام بناءً على نوع القالب
    function handleTemplateTypeChange() {
      const templateType = document.getElementById("templateType").value;
      const contentSection = document.getElementById("contentSection");
      const buttonsSection = document.getElementById("buttonsSection");
      const authenticationSection = document.getElementById(
        "authenticationSection"
      );
      const templateHeader = document.getElementById("templateHeader");
      const headerFields = document.getElementById("headerFields");
      const headerTextGroup = document.getElementById("headerTextGroup");
      const templateHeaderGroup = templateHeader
        ? templateHeader.closest(".wd-form-group")
        : null;
      const templateFooter = document.getElementById("templateFooter");
      const templateFooterGroup = templateFooter
        ? templateFooter.closest(".wd-form-group")
        : null;
      const carouselCardsSection = document.getElementById("carouselCardsSection");

      if (templateType === "authentication") {
        // إخفاء قسم المحتوى والأزرار
        if (contentSection) contentSection.style.display = "none";
        if (buttonsSection) buttonsSection.style.display = "none";
        if (carouselCardsSection) carouselCardsSection.style.display = "none";
        // إظهار قسم المصادقة
        if (authenticationSection)
          authenticationSection.style.display = "block";
      } else {
        // إظهار قسم المحتوى والأزرار
        if (contentSection) contentSection.style.display = "block";
        // إخفاء قسم المصادقة
        if (authenticationSection)
          authenticationSection.style.display = "none";

        // القيم الافتراضية العامة لغير المصادقة
        if (templateHeaderGroup) templateHeaderGroup.style.display = "block";
        if (templateFooterGroup) templateFooterGroup.style.display = "block";
        if (buttonsSection) buttonsSection.style.display = "block";
        if (carouselCardsSection) carouselCardsSection.style.display = "none";

        // تخصيص الحقول حسب النوع
        if (templateType === "carousel") {
          // عرض متعدد البطاقات: بدون رأس + بدون تذييل + بدون أزرار
          if (templateHeader) {
            templateHeader.value = "none";
            handleHeaderChange();
          }
          if (templateHeaderGroup) templateHeaderGroup.style.display = "none";
          if (templateFooterGroup) templateFooterGroup.style.display = "none";
          if (buttonsSection) buttonsSection.style.display = "none";
          if (carouselCardsSection) {
            carouselCardsSection.style.display = "block";
            handleCarouselCardsConfigChange();
          }
        } else if (templateType === "single-product") {
          // منتج واحد: محتوى + تذييل فقط
          if (templateHeader) {
            templateHeader.value = "none";
            handleHeaderChange();
          }
          if (templateHeaderGroup) templateHeaderGroup.style.display = "none";
          if (templateFooterGroup) templateFooterGroup.style.display = "block";
          if (buttonsSection) buttonsSection.style.display = "none";
          if (carouselCardsSection) carouselCardsSection.style.display = "none";
        } else if (templateType === "multiple-products") {
          // متعدد المنتجات: نص الرأس + محتوى + تذييل
          if (templateHeader) {
            templateHeader.value = "text";
            handleHeaderChange();
          }
          if (templateHeaderGroup) templateHeaderGroup.style.display = "none";
          if (headerFields) headerFields.style.display = "block";
          if (headerTextGroup) headerTextGroup.style.display = "block";
          if (templateFooterGroup) templateFooterGroup.style.display = "block";
          if (buttonsSection) buttonsSection.style.display = "none";
          if (carouselCardsSection) carouselCardsSection.style.display = "none";
        } else if (templateType === "product-card-slider") {
          // عرض متعدد لبطاقات المنتجات: محتوى فقط
          if (templateHeader) {
            templateHeader.value = "none";
            handleHeaderChange();
          }
          if (templateHeaderGroup) templateHeaderGroup.style.display = "none";
          if (templateFooterGroup) templateFooterGroup.style.display = "none";
          if (buttonsSection) buttonsSection.style.display = "none";
          if (carouselCardsSection) carouselCardsSection.style.display = "none";
        }
      }

      updateTemplatePreview();
    }

    function switchTemplateCategoryTab(category) {
      document.querySelectorAll(".wd-category-tab").forEach((tab) => {
        tab.classList.toggle(
          "active",
          tab.getAttribute("data-category-tab") === category
        );
      });

      document.querySelectorAll(".wd-category-options").forEach((options) => {
        options.classList.toggle(
          "active",
          options.getAttribute("data-category-options") === category
        );
      });

      const activeOption = document.querySelector(
        `.wd-category-options[data-category-options="${category}"] .wd-category-option.selected`
      );
      if (activeOption) {
        applyTemplateTypeFromCategoryOption(activeOption);
      }
    }

    function selectTemplateCategoryOption(optionElement, category) {
      const parent = optionElement.closest(".wd-category-options");
      if (!parent) return;

      parent.querySelectorAll(".wd-category-option").forEach((opt) => {
        opt.classList.remove("selected");
      });
      optionElement.classList.add("selected");

      document.querySelectorAll(".wd-category-tab").forEach((tab) => {
        tab.classList.toggle(
          "active",
          tab.getAttribute("data-category-tab") === category
        );
      });

      applyTemplateTypeFromCategoryOption(optionElement);
    }

    function applyTemplateTypeFromCategoryOption(optionElement) {
      const templateTypeSelect = document.getElementById("templateType");
      if (!templateTypeSelect || !optionElement) return;

      const templateValue = optionElement.getAttribute("data-template-value");
      if (!templateValue) return;

      templateTypeSelect.value = templateValue;
      handleTemplateTypeChange();
    }

    const carouselCardsState = {
      activeIndex: 1,
      cards: [],
    };

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function handleCarouselCardsConfigChange() {
      const countEl = document.getElementById("carouselCardsCount");
      if (!countEl) return;
      const count = parseInt(countEl.value, 10) || 1;

      while (carouselCardsState.cards.length < count) {
        carouselCardsState.cards.push({
          content: "",
          mediaFile: null,
          mediaName: "",
          button1: { label: "", value: "" },
          button2: { label: "", value: "" },
        });
      }
      if (carouselCardsState.cards.length > count) {
        carouselCardsState.cards = carouselCardsState.cards.slice(0, count);
      }

      if (carouselCardsState.activeIndex > count) {
        carouselCardsState.activeIndex = count;
      }
      if (carouselCardsState.activeIndex < 1) {
        carouselCardsState.activeIndex = 1;
      }

      renderCarouselCardsUI();
      updateTemplatePreview();
    }

    function renderCarouselCardsUI() {
      const tabsContainer = document.getElementById("carouselCardsTabs");
      const panelsContainer = document.getElementById("carouselCardsPanels");
      const count = parseInt(
        document.getElementById("carouselCardsCount")?.value || "1",
        10
      );
      const headerType =
        document.getElementById("carouselCardsHeaderType")?.value || "image";
      const button1Type =
        document.getElementById("carouselCardsButton1Type")?.value || "none";
      const button2Type =
        document.getElementById("carouselCardsButton2Type")?.value || "none";

      if (!tabsContainer || !panelsContainer) return;

      let tabsHtml = "";
      let panelsHtml = "";

      for (let i = 1; i <= count; i++) {
        const isActive = carouselCardsState.activeIndex === i;
        const card = carouselCardsState.cards[i - 1] || {
          content: "",
          mediaFile: null,
          mediaName: "",
          button1: { label: "", value: "" },
          button2: { label: "", value: "" },
        };

        tabsHtml += `
          <button type="button" data-card-index="${i}" class="wd-carousel-card-tab ${isActive ? "active" : ""}"
            onclick="setCarouselCardTab(${i})">
            بطاقة ${i}
          </button>
        `;

        panelsHtml += `
          <div class="wd-carousel-card-panel" data-card-index="${i}" style="display:${isActive ? "block" : "none"}">
            <div class="wd-form-group">
              <label for="carouselCardMedia_${i}">${headerType === "video" ? "ارفع فيديو البطاقة" : "ارفع صورة البطاقة"
          }</label>
              <input type="file" id="carouselCardMedia_${i}" class="wd-form-control"
                accept="${headerType === "video" ? "video/*" : "image/*"}"
                onchange="updateCarouselCardMedia(${i}, this)" />
              ${card.mediaName
            ? `<div class="wd-char-counter">${escapeHtml(card.mediaName)}</div>`
            : ""
          }
            </div>
            <div class="wd-form-group">
              <label for="carouselCardContent_${i}">محتوى البطاقة ${i}</label>
              <textarea id="carouselCardContent_${i}" class="wd-form-control" rows="4"
                placeholder="أدخل محتوى البطاقة" oninput="updateCarouselCardContent(${i}, this.value)">${escapeHtml(
            card.content
          )}</textarea>
            </div>
            <div class="wd-carousel-card-buttons-row">
              ${getCarouselCardButtonFieldsHtml(i, "button1", "زر 1", button1Type, card.button1)}
              ${getCarouselCardButtonFieldsHtml(i, "button2", "زر 2", button2Type, card.button2)}
            </div>
          </div>
        `;
      }

      tabsContainer.innerHTML = tabsHtml;
      panelsContainer.innerHTML = panelsHtml;
    }

    function getCarouselCardButtonFieldsHtml(
      cardIndex,
      buttonKey,
      buttonTitle,
      buttonType,
      buttonState
    ) {
      if (buttonType === "none") {
        return `
          <div class="wd-form-group">
            <label>${buttonTitle}</label>
            <div class="wd-buttons-info" style="margin-bottom:0;">بدون</div>
          </div>
        `;
      }

      if (buttonType === "quick_reply") {
        return `
          <div class="wd-form-group">
            <label for="carousel_${buttonKey}_label_${cardIndex}">${buttonTitle} - نص الزر</label>
            <input type="text" id="carousel_${buttonKey}_label_${cardIndex}" class="wd-form-control"
              maxlength="25" value="${escapeHtml(buttonState?.label)}"
              oninput="updateCarouselCardButtonField(${cardIndex}, '${buttonKey}', 'label', this.value)" />
          </div>
        `;
      }

      if (buttonType === "phone") {
        return `
          <div class="wd-form-group">
            <label for="carousel_${buttonKey}_label_${cardIndex}">${buttonTitle} - نص الزر</label>
            <input type="text" id="carousel_${buttonKey}_label_${cardIndex}" class="wd-form-control"
              maxlength="25" value="${escapeHtml(buttonState?.label)}"
              oninput="updateCarouselCardButtonField(${cardIndex}, '${buttonKey}', 'label', this.value)" />
            <label for="carousel_${buttonKey}_value_${cardIndex}" style="margin-top:8px;">${buttonTitle} - رقم الهاتف</label>
            <input type="tel" id="carousel_${buttonKey}_value_${cardIndex}" class="wd-form-control"
              value="${escapeHtml(buttonState?.value)}"
              oninput="updateCarouselCardButtonField(${cardIndex}, '${buttonKey}', 'value', this.value)" />
          </div>
        `;
      }

      return `
        <div class="wd-form-group">
          <label for="carousel_${buttonKey}_label_${cardIndex}">${buttonTitle} - نص الزر</label>
          <input type="text" id="carousel_${buttonKey}_label_${cardIndex}" class="wd-form-control"
            maxlength="25" value="${escapeHtml(buttonState?.label)}"
            oninput="updateCarouselCardButtonField(${cardIndex}, '${buttonKey}', 'label', this.value)" />
          <label for="carousel_${buttonKey}_value_${cardIndex}" style="margin-top:8px;">${buttonTitle} - الرابط</label>
          <input type="url" id="carousel_${buttonKey}_value_${cardIndex}" class="wd-form-control"
            value="${escapeHtml(buttonState?.value)}"
            oninput="updateCarouselCardButtonField(${cardIndex}, '${buttonKey}', 'value', this.value)" />
        </div>
      `;
    }

    function setCarouselCardTab(index) {
      carouselCardsState.activeIndex = index;
      const tabs = document.querySelectorAll(".wd-carousel-card-tab");
      const panels = document.querySelectorAll(".wd-carousel-card-panel");

      tabs.forEach((tab) => {
        tab.classList.toggle(
          "active",
          parseInt(tab.getAttribute("data-card-index"), 10) === index
        );
      });

      panels.forEach((panel) => {
        panel.style.display =
          parseInt(panel.getAttribute("data-card-index"), 10) === index
            ? "block"
            : "none";
      });
    }

    function updateCarouselCardContent(index, value) {
      if (!carouselCardsState.cards[index - 1]) return;
      carouselCardsState.cards[index - 1].content = value;
      updateTemplatePreview();
    }

    function updateCarouselCardMedia(index, inputElement) {
      if (!carouselCardsState.cards[index - 1]) return;
      const mediaFile =
        inputElement && inputElement.files && inputElement.files[0]
          ? inputElement.files[0]
          : null;
      carouselCardsState.cards[index - 1].mediaFile = mediaFile;
      carouselCardsState.cards[index - 1].mediaName = mediaFile
        ? mediaFile.name
        : "";
      updateTemplatePreview();
    }

    function updateCarouselCardButtonField(index, buttonKey, field, value) {
      if (!carouselCardsState.cards[index - 1]) return;
      if (!carouselCardsState.cards[index - 1][buttonKey]) {
        carouselCardsState.cards[index - 1][buttonKey] = { label: "", value: "" };
      }
      carouselCardsState.cards[index - 1][buttonKey][field] = value;
      updateTemplatePreview();
    }

    function showCarouselCardsValidationError(message, cardIndex) {
      const carouselError = document.getElementById("carouselCardsError");
      if (carouselError) {
        carouselError.style.display = "block";
        carouselError.textContent = message;
      }
      if (cardIndex) {
        setCarouselCardTab(cardIndex);
      }
    }

    // التحكم في إظهار/إخفاء حقل دقائق الانتهاء
    function toggleExpirationInput() {
      const expirationToggle = document.getElementById(
        "expirationWarningToggle"
      );
      const expirationInputGroup = document.getElementById(
        "expirationInputGroup"
      );

      if (expirationToggle && expirationInputGroup) {
        if (expirationToggle.checked) {
          expirationInputGroup.style.display = "block";
        } else {
          expirationInputGroup.style.display = "none";
        }
        updateTemplatePreview();
      }
    }

    function handleHeaderChange() {
      const headerType = document.getElementById("templateHeader").value;
      const headerFields = document.getElementById("headerFields");
      const headerRequired = document.getElementById("headerRequired");

      // إخفاء جميع حقول الرأس
      document
        .querySelectorAll("#headerFields .wd-form-group")
        .forEach((group) => {
          group.style.display = "none";
        });

      // إخفاء رسائل الخطأ
      document
        .querySelectorAll("#headerFields .wd-error-message")
        .forEach((error) => {
          error.style.display = "none";
        });

      if (headerType !== "none") {
        headerFields.style.display = "block";
        headerRequired.style.display = "inline";
        document.getElementById(
          `header${headerType.charAt(0).toUpperCase() + headerType.slice(1)
          }Group`
        ).style.display = "block";

        if (headerType === "text") {
          const headerText = document.getElementById("headerText");
          headerText.addEventListener("input", function () {
            updateCharCounter(this, "headerTextCounter", 60);
            updateTemplatePreview();
          });
        }
      } else {
        headerFields.style.display = "none";
        headerRequired.style.display = "none";
      }

      updateTemplatePreview();
    }

    let variableCount = 0;
    const MAX_TEMPLATE_VARIABLES = 10;
    const variableTexts = {};
    const variableInputs = new Set();
    const deletedVariables = new Set();

    function validateTemplateVariables(
      contentText,
      options = { checkEdges: true, checkMax: true }
    ) {
      const matches = contentText.match(/{{\d+}}/g) || [];
      const uniqueMatchesCount = new Set(matches).size;

      if (options.checkMax && uniqueMatchesCount > MAX_TEMPLATE_VARIABLES) {
        return {
          isValid: false,
          message: `الحد الأقصى لعدد المتغيرات هو ${MAX_TEMPLATE_VARIABLES}`,
        };
      }

      if (options.checkEdges && contentText && /^{{\d+}}/.test(contentText)) {
        return {
          isValid: false,
          message: "لا يمكن أن تبدأ الرسالة بمتغير",
        };
      }

      if (options.checkEdges && contentText && /{{\d+}}$/.test(contentText)) {
        return {
          isValid: false,
          message: "لا يمكن أن تنتهي الرسالة بمتغير",
        };
      }

      return { isValid: true, message: "" };
    }

    function showTemplateContentVariableError(message) {
      const contentInput = document.getElementById("templateContent");
      const contentError = document.getElementById("templateContentError");
      if (!contentInput || !contentError) return;

      contentInput.classList.add("error");
      contentError.style.display = "block";
      contentError.textContent = message;
    }

    function showVariables() {
      const content = document.getElementById("templateContent");
      if (!content) return;

      const currentMatches = content.value.match(/{{\d+}}/g) || [];
      const currentUniqueCount = new Set(currentMatches).size;
      if (currentUniqueCount >= MAX_TEMPLATE_VARIABLES) {
        showTemplateContentVariableError(
          `الحد الأقصى لعدد المتغيرات هو ${MAX_TEMPLATE_VARIABLES}`
        );
        return;
      }

      let variable;
      let reusedDeletedNumber = null;

      if (deletedVariables.size > 0) {
        reusedDeletedNumber = Math.min(...Array.from(deletedVariables));
        variable = `{{${reusedDeletedNumber}}}`;
      } else {
        variable = `{{${variableCount + 1}}}`;
      }

      const start = content.selectionStart;
      const end = content.selectionEnd;
      const text = content.value;
      const nextContent =
        text.substring(0, start) + variable + text.substring(end);
      const validation = validateTemplateVariables(nextContent, {
        checkEdges: false,
        checkMax: true,
      });

      if (!validation.isValid) {
        showTemplateContentVariableError(validation.message);
        return;
      }

      if (reusedDeletedNumber !== null) {
        deletedVariables.delete(reusedDeletedNumber);
      } else {
        variableCount++;
      }

      content.value = nextContent;
      content.selectionStart = content.selectionEnd = start + variable.length;

      variableInputs.add(variable);
      addVariableInput(variable);
      updateTemplatePreview();
    }

    function addVariableInput(variable) {
      const variablesSection = document.getElementById("variablesSection");
      if (!variablesSection) {
        const section = document.createElement("div");
        section.className = "wd-variables-section";
        section.id = "variablesSection";
        section.innerHTML = `
            <h4>نصوص المتغيرات</h4>
          `;
        const contentSection = document.getElementById("contentSection");
        if (contentSection) {
          contentSection.appendChild(section);
        }
      }

      const inputGroup = document.createElement("div");
      inputGroup.className = "wd-variable-input-group";
      inputGroup.id = `variable-input-${variable}`;
      inputGroup.innerHTML = `
          <span class="wd-variable-label">${variable}</span>
          <input type="text" class="wd-variable-input"
            placeholder="أدخل نص المتغير"
            oninput="handleVariableTextInput('${variable}', this.value)"
            value="${variableTexts[variable] || ""}">
        `;

      document.getElementById("variablesSection").appendChild(inputGroup);
    }

    function handleVariableTextInput(variable, text) {
      variableTexts[variable] = text;
      updateTemplatePreview();
    }

    function checkVariablesInContent() {
      const content = document.getElementById("templateContent").value;
      const currentVariables = new Set();

      const matches = content.match(/{{(\d+)}}/g) || [];
      matches.forEach((match) => currentVariables.add(match));

      variableInputs.forEach((variable) => {
        if (!currentVariables.has(variable)) {
          variableInputs.delete(variable);
          delete variableTexts[variable];

          const number = parseInt(variable.match(/\d+/)[0]);
          deletedVariables.add(number);

          const inputElement = document.getElementById(
            `variable-input-${variable}`
          );
          if (inputElement) {
            inputElement.remove();
          }
        }
      });

      matches.forEach((match) => {
        if (!variableInputs.has(match)) {
          variableInputs.add(match);
          addVariableInput(match);
          const number = parseInt(match.match(/\d+/)[0]);
          deletedVariables.delete(number);
        }
      });

      const variablesSection = document.getElementById("variablesSection");
      if (variablesSection && variableInputs.size === 0) {
        variablesSection.remove();
      }
    }

    function updateButtonFields() {
      const buttonFields = document.getElementById("buttonFields");
      const maxButtons = 10;
      const maxByType = { link: 2, phone: 1, copy: 1 };
      const counts = getButtonTypeCounts();
      const totalCount = buttonFields.children.length;
      const disableByTotal = totalCount >= maxButtons;

      if (totalCount > 0) {
        buttonFields.style.display = "flex";
      } else {
        buttonFields.style.display = "none";
      }

      document.getElementById("addQuickReplyBtn").disabled = disableByTotal;
      document.getElementById("addLinkBtn").disabled =
        disableByTotal || counts.link >= maxByType.link;
      document.getElementById("addPhoneBtn").disabled =
        disableByTotal || counts.phone >= maxByType.phone;
      document.getElementById("addCopyBtn").disabled =
        disableByTotal || counts.copy >= maxByType.copy;

      // تحديث المعاينة فوراً
      updateTemplatePreview();
    }

    function getButtonTypeCounts() {
      const buttonFields = document.getElementById("buttonFields");
      const counts = {
        quickReply: 0,
        link: 0,
        phone: 0,
        copy: 0,
      };

      if (!buttonFields) return counts;

      Array.from(buttonFields.children).forEach((buttonGroup) => {
        const type = buttonGroup.id.split("_")[0];
        if (Object.prototype.hasOwnProperty.call(counts, type)) {
          counts[type]++;
        }
      });

      return counts;
    }

    function updateTemplatePreview() {
      checkVariablesInContent();

      const headerType = document.getElementById("templateHeader").value;
      const content = document.getElementById("templateContent");
      const footer = document.getElementById("templateFooter");
      const footerGroup = footer ? footer.closest(".wd-form-group") : null;
      const footerIsVisible = footerGroup
        ? footerGroup.style.display !== "none"
        : true;
      const buttonsSection = document.getElementById("buttonsSection");
      const buttonsSectionVisible = buttonsSection
        ? buttonsSection.style.display !== "none"
        : true;
      const templateName = document.getElementById("templateName").value;
      const templateType = document.getElementById("templateType").value;
      const templateLanguage =
        document.getElementById("templateLanguage").value;

      updateCharCounter(content, "templateContentCounter", 1024);
      updateCharCounter(footer, "templateFooterCounter", 60);

      if (templateType !== "authentication") {
        const variableValidation = validateTemplateVariables(content.value, {
          checkEdges: false,
          checkMax: true,
        });
        if (!variableValidation.isValid) {
          showTemplateContentVariableError(variableValidation.message);
        } else if (content.value.trim()) {
          const contentError = document.getElementById("templateContentError");
          if (contentError && contentError.textContent !== "الرجاء إدخال محتوى القالب") {
            contentError.style.display = "none";
          }
          content.classList.remove("error");
        }
      }

      // Hide any example buttons when showing real ones
      const oldExampleButtons = document.querySelector(
        ".wd-preview-buttons-example"
      );
      if (oldExampleButtons) {
        oldExampleButtons.remove();
      }

      // Remove previous carousel slider preview if it exists
      const oldCarouselSlider = document.querySelector(".wd-preview-carousel-slider");
      if (oldCarouselSlider) {
        oldCarouselSlider.remove();
      }

      // Remove previous product preview blocks if they exist
      document
        .querySelectorAll(".wd-preview-product-wrap, .wd-preview-products-slider")
        .forEach((el) => el.remove());

      // Update contact name in WhatsApp header if template name is provided
      if (templateName) {
        document.querySelector(
          ".wd-whatsapp-header .contact-name"
        ).textContent = templateName;
      }

      let previewHTML = "";

      // إخفاء رأس الرسالة في فئة المصادقة
      if (templateType === "authentication") {
        headerPreview.style.display = "none";
      } else if (headerType !== "none") {
        let headerContent = "";
        switch (headerType) {
          case "text":
            headerContent = document.getElementById("headerText").value;
            if (headerContent) {
              previewHTML += `<div class="wd-preview-header-text">${headerContent}</div>`;
            }
            break;
          case "image":
            const imageFile = document.getElementById("headerImage").files[0];
            if (imageFile) {
              const imageUrl = URL.createObjectURL(imageFile);
              previewHTML += `<img src="${imageUrl}" alt="معاينة الصورة" class="wd-preview-image">`;
              headerPreview.style.display = "none";
            } else {
              headerContent =
                '<i class="fas fa-image wd-file-icon"></i><br>لم يتم اختيار صورة';
              headerPreview.innerHTML = headerContent;
              headerPreview.style.display = "block";
            }
            break;
          case "video":
            const videoFile = document.getElementById("headerVideo").files[0];
            if (videoFile) {
              const videoUrl = URL.createObjectURL(videoFile);
              previewHTML += `<video src="${videoUrl}" controls class="wd-preview-image"></video>`;
              headerPreview.style.display = "none";
            } else {
              headerContent =
                '<i class="fas fa-video wd-file-icon"></i><br>لم يتم اختيار فيديو';
              headerPreview.innerHTML = headerContent;
              headerPreview.style.display = "block";
            }
            break;
          case "document":
            const docFile =
              document.getElementById("headerDocument").files[0];
            if (docFile) {
              previewHTML += `<div class="wd-preview-doc"><i class="fas fa-file wd-file-icon"></i><br>${docFile.name}</div>`;
              headerPreview.style.display = "none";
            } else {
              headerContent =
                '<i class="fas fa-file wd-file-icon"></i><br>لم يتم اختيار ملف';
              headerPreview.innerHTML = headerContent;
              headerPreview.style.display = "block";
            }
            break;
          case "location":
            const location = document.getElementById("headerLocation").value;
            if (location) {
              previewHTML += `<div class="wd-preview-location"><i class="fas fa-map-marker-alt wd-location-icon"></i>${location}</div>`;
              headerPreview.style.display = "none";
            } else {
              headerContent =
                '<i class="fas fa-map-marker-alt wd-location-icon"></i>لم يتم تحديد الموقع';
              headerPreview.innerHTML = headerContent;
              headerPreview.style.display = "block";
            }
            break;
        }
      } else {
        headerPreview.style.display = "none";
      }

      // التحقق من نوع القالب
      if (templateType === "authentication") {
        // معاينة خاصة بفئة المصادقة
        let authContent = "{{1}} هو كود التحقق الخاص بك.";

        // استبدال المتغيرات إذا كانت موجودة
        Object.keys(variableTexts).forEach((variable) => {
          const text = variableTexts[variable] || variable;
          authContent = authContent.replace(
            new RegExp(variable.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "g"),
            text
          );
        });

        // إضافة تنويه الأمان إذا كان مفعلاً
        const securityWarningToggle = document.getElementById(
          "securityWarningToggle"
        );
        if (securityWarningToggle && securityWarningToggle.checked) {
          authContent +=
            "<br>للحفاظ على أمانك، لا تشارك هذا الكود مع أي شخص.";
        }

        previewHTML += `<div class="wd-preview-body">${authContent}</div>`;

        // إضافة تحذير الانتهاء كتذييل إذا كان مفعلاً
        const expirationWarningToggle = document.getElementById(
          "expirationWarningToggle"
        );
        if (expirationWarningToggle && expirationWarningToggle.checked) {
          const expirationMinutes =
            document.getElementById("expirationMinutes")?.value || "1";
          const expirationText = `تنتهي صلاحيتها خلال ${expirationMinutes} دقائق.`;
          previewHTML += `<div class="wd-preview-footer">${expirationText}</div>`;
        }
      } else {
        // المعاينة العادية للتسويق وأداة مساعدة
        if (content.value) {
          let formattedContent = content.value;

          Object.keys(variableTexts).forEach((variable) => {
            const text = variableTexts[variable] || variable;
            formattedContent = formattedContent.replace(
              new RegExp(
                variable.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                "g"
              ),
              text
            );
          });

          formattedContent = formattedContent
            .replace(/\*([^*]+)\*/g, "<strong>$1</strong>")
            .replace(/_([^_]+)_/g, "<em>$1</em>")
            .replace(/~([^~]+)~/g, "<del>$1</del>")
            .replace(/\n/g, "<br>");

          previewHTML += `<div class="wd-preview-body">${formattedContent}</div>`;
        } else {
          // إضافة مساحة فارغة للمحافظة على الحجم الثابت
          previewHTML += `<div class="wd-preview-body">&nbsp;</div>`;
        }

        if (footerIsVisible && footer.value) {
          let formattedFooter = footer.value;

          Object.keys(variableTexts).forEach((variable) => {
            const text = variableTexts[variable] || variable;
            formattedFooter = formattedFooter.replace(
              new RegExp(
                variable.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                "g"
              ),
              text
            );
          });

          // تذييل الرسالة لا يدعم التنسيق (نص عادي فقط)
          previewHTML += `<div class="wd-preview-footer">${formattedFooter}</div>`;
        }
      }

      // Add timestamp
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, "0");
      const minutes = now.getMinutes().toString().padStart(2, "0");
      previewHTML += `<div class="wd-preview-timestamp">${hours}:${minutes} <i class="fas fa-check-double" style="color: #34b7f1;"></i></div>`;

      // Update message content
      const messageElement = document.querySelector(".wd-preview-message");
      messageElement.innerHTML = previewHTML;

      // Set the default message styling
      messageElement.style.borderBottomLeftRadius = "7.5px";
      messageElement.style.borderBottomRightRadius = "7.5px";
      messageElement.style.marginBottom = "15px";

      // Handle buttons separately
      const buttonFields = document.getElementById("buttonFields");
      const buttonsContainer = document.querySelector(
        ".wd-preview-buttons:not(.wd-preview-buttons-example)"
      );

      // Remove previous buttons container if it exists
      if (buttonsContainer) {
        buttonsContainer.remove();
      }

      // Add buttons if they exist (فقط للتسويق وأداة مساعدة)
      if (
        templateType !== "authentication" &&
        buttonsSectionVisible &&
        buttonFields &&
        buttonFields.children.length > 0
      ) {
        const newButtonsContainer = document.createElement("div");
        newButtonsContainer.className = "wd-preview-buttons";

        // Set fixed width to match the message width
        newButtonsContainer.style.width = "280px";
        newButtonsContainer.style.maxWidth = "85%";

        Array.from(buttonFields.children).forEach((buttonGroup) => {
          const type = buttonGroup.id.split("_")[0];
          let buttonHTML = "";

          switch (type) {
            case "phone":
              const phoneText = document.getElementById(
                `phoneButtonText_${buttonGroup.id}`
              ).value;
              const phoneNumber = document.getElementById(
                `phoneNumber_${buttonGroup.id}`
              ).value;
              if (phoneText || phoneNumber) {
                // Show button even if only one field is filled
                buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-phone"></i>
                      ${phoneText || "اتصال"}
                    </button>
                  `;
              }
              break;

            case "link":
              const linkText = document.getElementById(
                `linkButtonText_${buttonGroup.id}`
              ).value;
              const linkUrl = document.getElementById(
                `linkUrl_${buttonGroup.id}`
              ).value;
              if (linkText || linkUrl) {
                // Show button even if only one field is filled
                buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-link"></i>
                      ${linkText || "رابط"}
                    </button>
                  `;
              }
              break;

            case "copy":
              const copyText = document.getElementById(
                `copyButtonText_${buttonGroup.id}`
              ).value;
              const copyCode = document.getElementById(
                `copyCode_${buttonGroup.id}`
              ).value;
              if (copyText || copyCode) {
                // Show button even if only one field is filled
                buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-copy"></i>
                      ${copyText || "نسخ"}
                    </button>
                  `;
              }
              break;

            case "quickReply":
              const quickReplyText = document.getElementById(
                `quickReplyButtonText_${buttonGroup.id}`
              ).value;
              if (quickReplyText) {
                // Show button even if only one field is filled
                buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-reply"></i>
                      ${quickReplyText || "رد سريع"}
                    </button>
                  `;
              }
              break;
          }

          if (buttonHTML) {
            newButtonsContainer.innerHTML += buttonHTML;
          }
        });

        if (newButtonsContainer.innerHTML) {
          // أضف الأزرار مباشرة بعد الرسالة
          messageElement.after(newButtonsContainer);

          // تعديل شكل الرسالة إذا كان هناك أزرار
          messageElement.style.borderBottomLeftRadius = "0";
          messageElement.style.borderBottomRightRadius = "0";
          messageElement.style.marginBottom = "0";
        }
      }

      if (templateType === "carousel") {
        const carouselSlider = renderCarouselCardsPreviewSlider();
        if (carouselSlider) {
          messageElement.after(carouselSlider);
        }
      }

      if (
        templateType === "single-product" ||
        templateType === "multiple-products" ||
        templateType === "product-card-slider"
      ) {
        const productPreview = renderProductTemplatePreviewByType(templateType);
        if (productPreview) {
          messageElement.before(productPreview);
        }
      }
    }

    function renderCarouselCardsPreviewSlider() {
      const count = parseInt(
        document.getElementById("carouselCardsCount")?.value || "1",
        10
      );
      const headerType =
        document.getElementById("carouselCardsHeaderType")?.value || "image";
      const button1Type =
        document.getElementById("carouselCardsButton1Type")?.value || "none";
      const button2Type =
        document.getElementById("carouselCardsButton2Type")?.value || "none";

      const slider = document.createElement("div");
      slider.className = "wd-preview-carousel-slider";

      for (let i = 1; i <= count; i++) {
        const card = carouselCardsState.cards[i - 1] || {
          content: "",
          mediaFile: null,
          mediaName: "",
          button1: { label: "", value: "" },
          button2: { label: "", value: "" },
        };
        const mediaFile = card.mediaFile || null;
        const mediaUrl = mediaFile ? URL.createObjectURL(mediaFile) : "";

        const cardEl = document.createElement("div");
        cardEl.className = "wd-preview-carousel-card";

        let mediaHtml = "";
        if (headerType === "video") {
          mediaHtml = mediaUrl
            ? `<video class="wd-preview-carousel-media" src="${mediaUrl}" controls></video>`
            : `<div class="wd-preview-carousel-media"></div>`;
        } else {
          mediaHtml = mediaUrl
            ? `<img class="wd-preview-carousel-media" src="${mediaUrl}" alt="Card ${i}" />`
            : `<div class="wd-preview-carousel-media"></div>`;
        }

        const cardBody = card.content
          ? escapeHtml(card.content).replace(/\n/g, "<br>")
          : "";

        const actions = [];
        const b1 = getCarouselPreviewButtonLabel(button1Type, card.button1, 1);
        const b2 = getCarouselPreviewButtonLabel(button2Type, card.button2, 2);
        if (b1) actions.push(b1);
        if (b2) actions.push(b2);

        const actionsHtml = actions.length
          ? `<div class="wd-preview-carousel-actions">${actions
            .map((label) => `<button class="wd-preview-carousel-action">${escapeHtml(label)}</button>`)
            .join("")}</div>`
          : "";

        cardEl.innerHTML = `
          ${mediaHtml}
          <div class="wd-preview-carousel-body">${cardBody}</div>
          ${actionsHtml}
        `;
        slider.appendChild(cardEl);
      }

      return slider;
    }

    function getCarouselPreviewButtonLabel(buttonType, buttonData, index) {
      if (buttonType === "none") return "";
      if (buttonType === "quick_reply") return buttonData?.label || "";
      if (buttonType === "phone") return buttonData?.label || "";
      if (buttonType === "link") return buttonData?.label || "";
      return "";
    }

    function renderProductTemplatePreviewByType(templateType) {
      if (templateType === "product-card-slider") {
        const slider = document.createElement("div");
        slider.className = "wd-preview-products-slider";

        for (let i = 1; i <= 5; i++) {
          const card = document.createElement("div");
          card.className = "wd-preview-product-card";
          card.innerHTML = `
            <div class="wd-preview-product-image">
              <i class="fas fa-image"></i>
              <span>بدون صورة</span>
            </div>
            <div class="wd-preview-product-info">
              <div class="wd-preview-product-name">اسم المنتج ${i}</div>
              <div class="wd-preview-product-price">السعر</div>
            </div>
            <button class="wd-preview-product-action">عرض</button>
          `;
          slider.appendChild(card);
        }

        return slider;
      }

      const wrap = document.createElement("div");
      wrap.className = "wd-preview-product-wrap";
      const actionText =
        templateType === "multiple-products" ? "عرض العناصر" : "عرض";

      wrap.innerHTML = `
        <div class="wd-preview-product-card">
          <div class="wd-preview-product-image">
            <i class="fas fa-image"></i>
            <span>بدون صورة</span>
          </div>
          <div class="wd-preview-product-info">
            <div class="wd-preview-product-name">اسم المنتج</div>
            <div class="wd-preview-product-price">السعر</div>
          </div>
          <button class="wd-preview-product-action">${actionText}</button>
        </div>
      `;

      return wrap;
    }

    function formatText(type) {
      const content = document.getElementById("templateContent");
      const start = content.selectionStart;
      const end = content.selectionEnd;
      const text = content.value;
      let newText = "";

      switch (type) {
        case "emoji":
          newText = text.substring(0, start) + "😊" + text.substring(end);
          break;
        case "bold":
          newText =
            text.substring(0, start) +
            "*" +
            text.substring(start, end) +
            "*" +
            text.substring(end);
          break;
        case "italic":
          newText =
            text.substring(0, start) +
            "_" +
            text.substring(start, end) +
            "_" +
            text.substring(end);
          break;
        case "strikethrough":
          newText =
            text.substring(0, start) +
            "~" +
            text.substring(start, end) +
            "~" +
            text.substring(end);
          break;
        case "spacing":
          newText =
            text.substring(0, start) +
            "  " +
            text.substring(start, end) +
            "  " +
            text.substring(end);
          break;
      }

      content.value = newText;
      updateTemplatePreview();
    }

    function createTemplate() {
      const name = document.getElementById("templateName").value;
      const type = document.getElementById("templateType").value;
      const language = document.getElementById("templateLanguage").value;
      const content = document.getElementById("templateContent").value;
      const headerType = document.getElementById("templateHeader").value;

      // إخفاء جميع رسائل الخطأ وإزالة class error من جميع الحقول
      document
        .querySelectorAll(".wd-error-message")
        .forEach((el) => (el.style.display = "none"));
      document
        .querySelectorAll(".wd-form-control")
        .forEach((el) => el.classList.remove("error"));

      let isValid = true;

      if (!name) {
        const nameInput = document.getElementById("templateName");
        const nameError = document.getElementById("templateNameError");
        nameInput.classList.add("error");
        nameError.style.display = "block";
        nameError.textContent = "الرجاء إدخال اسم القالب";
        isValid = false;
      } else {
        document.getElementById("templateName").classList.remove("error");
      }

      if (!type) {
        const typeInput = document.getElementById("templateType");
        const typeError = document.getElementById("templateTypeError");
        typeInput.classList.add("error");
        typeError.style.display = "block";
        typeError.textContent = "الرجاء اختيار نوع القالب";
        isValid = false;
      } else {
        document.getElementById("templateType").classList.remove("error");
      }

      if (!language) {
        const languageInput = document.getElementById("templateLanguage");
        const languageError = document.getElementById(
          "templateLanguageError"
        );
        languageInput.classList.add("error");
        languageError.style.display = "block";
        languageError.textContent = "الرجاء اختيار لغة القالب";
        isValid = false;
      } else {
        document.getElementById("templateLanguage").classList.remove("error");
      }

      // التحقق من رأس الرسالة (فقط للتسويق وأداة مساعدة)
      if (type !== "authentication" && headerType !== "none") {
        let headerValid = false;
        let headerErrorId = "";
        let headerInputId = "";

        switch (headerType) {
          case "text":
            const headerText = document.getElementById("headerText").value;
            headerInputId = "headerText";
            if (!headerText || headerText.trim() === "") {
              headerErrorId = "headerTextError";
              isValid = false;
            } else {
              headerValid = true;
            }
            break;
          case "image":
            const headerImage =
              document.getElementById("headerImage").files[0];
            headerInputId = "headerImage";
            if (!headerImage) {
              headerErrorId = "headerImageError";
              isValid = false;
            } else {
              headerValid = true;
            }
            break;
          case "video":
            const headerVideo =
              document.getElementById("headerVideo").files[0];
            headerInputId = "headerVideo";
            if (!headerVideo) {
              headerErrorId = "headerVideoError";
              isValid = false;
            } else {
              headerValid = true;
            }
            break;
          case "document":
            const headerDocument =
              document.getElementById("headerDocument").files[0];
            headerInputId = "headerDocument";
            if (!headerDocument) {
              headerErrorId = "headerDocumentError";
              isValid = false;
            } else {
              headerValid = true;
            }
            break;
          case "location":
            const headerLocation =
              document.getElementById("headerLocation").value;
            headerInputId = "headerLocation";
            if (!headerLocation || headerLocation.trim() === "") {
              headerErrorId = "headerLocationError";
              isValid = false;
            } else {
              headerValid = true;
            }
            break;
        }

        if (!headerValid && headerErrorId && headerInputId) {
          const headerInput = document.getElementById(headerInputId);
          const headerError = document.getElementById(headerErrorId);
          headerInput.classList.add("error");
          headerError.style.display = "block";
          headerError.textContent =
            "الرجاء إدخال " +
            (headerType === "text"
              ? "نص الرأس"
              : headerType === "image"
                ? "صورة الرأس"
                : headerType === "video"
                  ? "فيديو الرأس"
                  : headerType === "document"
                    ? "ملف الرأس"
                    : "موقع الرأس");
        } else if (headerValid && headerInputId) {
          document.getElementById(headerInputId).classList.remove("error");
        }
      }

      // التحقق من محتوى القالب (فقط للتسويق وأداة مساعدة)
      if (type !== "authentication" && !content) {
        const contentInput = document.getElementById("templateContent");
        const contentError = document.getElementById("templateContentError");
        contentInput.classList.add("error");
        contentError.style.display = "block";
        contentError.textContent = "الرجاء إدخال محتوى القالب";
        isValid = false;
      } else if (type !== "authentication") {
        document.getElementById("templateContent").classList.remove("error");
      }

      if (type !== "authentication" && content) {
        const variableValidation = validateTemplateVariables(content, {
          checkEdges: true,
          checkMax: true,
        });
        if (!variableValidation.isValid) {
          showTemplateContentVariableError(variableValidation.message);
          isValid = false;
        }
      }

      if (type === "carousel") {
        const carouselError = document.getElementById("carouselCardsError");
        if (carouselError) {
          carouselError.style.display = "none";
          carouselError.textContent = "";
        }

        const cardsCount = parseInt(
          document.getElementById("carouselCardsCount")?.value || "1",
          10
        );
        const button1Type =
          document.getElementById("carouselCardsButton1Type")?.value || "none";
        const button2Type =
          document.getElementById("carouselCardsButton2Type")?.value || "none";

        for (let i = 1; i <= cardsCount; i++) {
          const currentCard = carouselCardsState.cards[i - 1] || {};
          const cardContentInput = document.getElementById(`carouselCardContent_${i}`);

          if (!currentCard.mediaFile) {
            showCarouselCardsValidationError(`الرجاء رفع صورة/فيديو للبطاقة رقم ${i}`, i);
            isValid = false;
            break;
          }

          if (!cardContentInput || !cardContentInput.value.trim()) {
            showCarouselCardsValidationError(`محتوى البطاقة رقم ${i} مطلوب`, i);
            isValid = false;
            break;
          }

          if (button1Type !== "none") {
            const b1Label = document.getElementById(`carousel_button1_label_${i}`);
            if (!b1Label || !b1Label.value.trim()) {
              showCarouselCardsValidationError(`نص زر 1 في البطاقة رقم ${i} مطلوب`, i);
              isValid = false;
              break;
            }

            if (button1Type === "phone" || button1Type === "link") {
              const b1Value = document.getElementById(`carousel_button1_value_${i}`);
              if (!b1Value || !b1Value.value.trim()) {
                showCarouselCardsValidationError(
                  `${button1Type === "phone" ? "رقم هاتف" : "رابط"} زر 1 في البطاقة رقم ${i} مطلوب`,
                  i
                );
                isValid = false;
                break;
              }
            }
          }

          if (button2Type !== "none") {
            const b2Label = document.getElementById(`carousel_button2_label_${i}`);
            if (!b2Label || !b2Label.value.trim()) {
              showCarouselCardsValidationError(`نص زر 2 في البطاقة رقم ${i} مطلوب`, i);
              isValid = false;
              break;
            }

            if (button2Type === "phone" || button2Type === "link") {
              const b2Value = document.getElementById(`carousel_button2_value_${i}`);
              if (!b2Value || !b2Value.value.trim()) {
                showCarouselCardsValidationError(
                  `${button2Type === "phone" ? "رقم هاتف" : "رابط"} زر 2 في البطاقة رقم ${i} مطلوب`,
                  i
                );
                isValid = false;
                break;
              }
            }
          }
        }
      }

      // جمع بيانات المصادقة إذا كان النوع مصادقة
      if (type === "authentication") {
        const securityWarning = document.getElementById(
          "securityWarningToggle"
        ).checked;
        const expirationWarning = document.getElementById(
          "expirationWarningToggle"
        ).checked;
        const expirationMinutes =
          document.getElementById("expirationMinutes").value;

        console.log("Security Warning:", securityWarning);
        console.log("Expiration Warning:", expirationWarning);
        if (expirationWarning) {
          console.log("Expiration Minutes:", expirationMinutes);
        }
      }

      if (isValid) {
        alert("تم إنشاء القالب بنجاح");
        window.location.href = "../contents.html";
      }
    }

    function validateTemplateName(input) {
      const value = input.value;
      const errorElement = document.getElementById("templateNameError");
      updateCharCounter(input, "templateNameCounter", 512);

      if (!/^[A-Za-z_]+$/.test(value)) {
        errorElement.style.display = "block";
        errorElement.textContent =
          "يجب أن يحتوي اسم القالب على أحرف إنجليزية و _ فقط";
        input.value = value.replace(/[^A-Za-z_]/g, "");
      } else {
        errorElement.style.display = "none";
      }

      updateTemplatePreview();
    }

    function validateFooterInput(input) {
      const value = input.value;
      const errorElement = document.getElementById("templateFooterError");
      updateCharCounter(input, "templateFooterCounter", 60);

      // السماح فقط بالأحرف (عربية وإنجليزية) والأرقام والمسافات
      const allowedPattern = /^[A-Za-z0-9\u0600-\u06FF\s]*$/;

      if (!allowedPattern.test(value)) {
        // إزالة الأحرف غير المسموحة
        const cleanedValue = value.replace(
          /[^A-Za-z0-9\u0600-\u06FF\s]/g,
          ""
        );
        input.value = cleanedValue;

        // إظهار رسالة خطأ مؤقتة
        errorElement.style.display = "block";
        errorElement.textContent = "يُسمح فقط بالأحرف والأرقام";
        input.classList.add("error");

        // إخفاء رسالة الخطأ بعد 3 ثوان
        setTimeout(() => {
          errorElement.style.display = "none";
          input.classList.remove("error");
        }, 3000);
      } else {
        errorElement.style.display = "none";
        input.classList.remove("error");
      }

      updateTemplatePreview();
    }

    function updateCharCounter(input, counterId, maxLength) {
      const count = input.value.length;
      const counter = document.getElementById(counterId);
      counter.textContent = `${count}/${maxLength}`;
      if (count > maxLength) {
        counter.classList.add("error");
      } else {
        counter.classList.remove("error");
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      const content = document.getElementById("templateContent");
      const footer = document.getElementById("templateFooter");
      const name = document.getElementById("templateName");
      const type = document.getElementById("templateType");
      const language = document.getElementById("templateLanguage");
      const headerText = document.getElementById("headerText");
      const headerLocation = document.getElementById("headerLocation");

      // إزالة class error عند إدخال البيانات
      if (name) {
        name.addEventListener("input", function () {
          this.classList.remove("error");
          document.getElementById("templateNameError").style.display = "none";
        });
      }

      if (type) {
        type.addEventListener("change", function () {
          this.classList.remove("error");
          document.getElementById("templateTypeError").style.display = "none";
          handleTemplateTypeChange();
        });
        // التحقق من الحالة الأولية
        handleTemplateTypeChange();
      }

      if (language) {
        language.addEventListener("change", function () {
          this.classList.remove("error");
          document.getElementById("templateLanguageError").style.display =
            "none";
        });
      }

      if (content) {
        content.addEventListener("input", function () {
          updateCharCounter(this, "templateContentCounter", 1024);
          this.classList.remove("error");
          document.getElementById("templateContentError").style.display =
            "none";
        });
      }

      if (headerText) {
        headerText.addEventListener("input", function () {
          this.classList.remove("error");
          document.getElementById("headerTextError").style.display = "none";
        });
      }

      if (headerLocation) {
        headerLocation.addEventListener("input", function () {
          this.classList.remove("error");
          document.getElementById("headerLocationError").style.display =
            "none";
        });
      }

      // إزالة class error عند اختيار ملف
      const headerImage = document.getElementById("headerImage");
      const headerVideo = document.getElementById("headerVideo");
      const headerDocument = document.getElementById("headerDocument");

      if (headerImage) {
        headerImage.addEventListener("change", function () {
          this.classList.remove("error");
          document.getElementById("headerImageError").style.display = "none";
        });
      }

      if (headerVideo) {
        headerVideo.addEventListener("change", function () {
          this.classList.remove("error");
          document.getElementById("headerVideoError").style.display = "none";
        });
      }

      if (headerDocument) {
        headerDocument.addEventListener("change", function () {
          this.classList.remove("error");
          document.getElementById("headerDocumentError").style.display =
            "none";
        });
      }

      if (footer) {
        footer.addEventListener("input", function () {
          validateFooterInput(this);
        });
      }

      // إضافة مثال للأزرار عند تحميل الصفحة ليظهر الحجم الثابت
      showButtonsExample();

      // تهيئة صندوق اختيار الفئة من أعلى الصفحة
      switchTemplateCategoryTab("marketing");

      updateTemplatePreview();
    });

    // وظيفة لإظهار مثال للأزرار عند تحميل الصفحة
    function showButtonsExample() {
      // التحقق من نوع القالب - لا تظهر الأزرار في المصادقة
      const templateType = document.getElementById("templateType")?.value;
      if (templateType === "authentication") {
        return; // لا تظهر مثال الأزرار في المصادقة
      }

      // إضافة مثال مؤقت للأزرار ليظهر الحجم الثابت
      const previewContent = document.getElementById("previewContent");
      const messageElement = document.querySelector(".wd-preview-message");

      // إزالة أي مثال سابق
      const oldExampleButtons = document.querySelector(
        ".wd-preview-buttons-example"
      );
      if (oldExampleButtons) {
        oldExampleButtons.remove();
      }

      // إنشاء حاوية أزرار مؤقتة
      const exampleButtons = document.createElement("div");
      exampleButtons.className =
        "wd-preview-buttons wd-preview-buttons-example";

      // Set fixed width to match the message width
      exampleButtons.style.width = "280px";
      exampleButtons.style.maxWidth = "85%";

      // إضافة محتوى الأزرار المؤقتة
      exampleButtons.innerHTML = `
          <button class="wd-preview-button">
            <i class="fas fa-reply"></i>
            رد سريع
          </button>
          <button class="wd-preview-button">
            <i class="fas fa-link"></i>
            فتح الرابط
          </button>
          <button class="wd-preview-button">
            <i class="fas fa-phone"></i>
            اتصل بنا
          </button>
        `;

      // إضافة الأزرار بعد الرسالة
      messageElement.after(exampleButtons);

      // تعديل شكل الرسالة
      messageElement.style.borderBottomLeftRadius = "0";
      messageElement.style.borderBottomRightRadius = "0";
      messageElement.style.marginBottom = "0";
    }

    function getLanguageName(code) {
      const languageSelect = document.getElementById("templateLanguage");
      const option = languageSelect.querySelector(`option[value="${code}"]`);
      return option ? option.textContent : "";
    }

    function getTemplateTypeName(type) {
      const types = {
        marketing: "تسويق",
        utility: "أداة مساعدة",
        authentication: "المصادقة",
        carousel: "سلايدر",
        "product-card-slider": "سلايدر بطاقة منتجات",
        "single-product": "منتج واحد",
        "multiple-products": "منتجات متعددة",
      };
      return types[type] || "فئة القالب";
    }

    document
      .getElementById("templateType")
      .addEventListener("change", function () {
        updateTemplatePreview();
      });

    document
      .getElementById("templateLanguage")
      .addEventListener("change", function () {
        updateTemplatePreview();
      });

    document
      .getElementById("templateName")
      .addEventListener("input", function () {
        updateTemplatePreview();
      });

    document
      .getElementById("templateContent")
      .addEventListener("input", function () {
        checkVariablesInContent();
      });

    let buttonCount = 0;

    function addQuickReplyButton() {
      buttonCount++;
      const id = `quickReply_${buttonCount}`;
      const buttonFields = document.getElementById("buttonFields");

      const buttonGroup = document.createElement("div");
      buttonGroup.className = "wd-button-group";
      buttonGroup.id = id;
      buttonGroup.draggable = true;

      buttonGroup.innerHTML = `
          <div class="wd-button-header">
            <div class="wd-button-title">
              <i class="fas fa-reply"></i>
              رد سريع
            </div>
            <div class="wd-button-actions">
              <button type="button" class="wd-button-action delete" onclick="removeButton('${id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="wd-form-row">
            <div class="wd-form-col button-text">
              <label for="quickReplyButtonText_${id}">نص الزر <span class="wd-required">*</span></label>
              <input type="text" id="quickReplyButtonText_${id}" class="wd-form-control"
                placeholder="نص يظهر على الزر" maxlength="25" oninput="updateTemplatePreview()">
              <div class="wd-char-counter" id="quickReplyButtonTextCounter_${id}">0/25</div>
            </div>
          </div>
        `;

      buttonFields.appendChild(buttonGroup);
      setupDragAndDrop(buttonGroup);

      const buttonTextInput = document.getElementById(
        `quickReplyButtonText_${id}`
      );
      buttonTextInput.addEventListener("input", function () {
        updateCharCounter(this, `quickReplyButtonTextCounter_${id}`, 25);
        updateTemplatePreview();
      });

      updateButtonFields();
    }

    function addLinkButton() {
      const buttonFields = document.getElementById("buttonFields");
      const counts = getButtonTypeCounts();
      if (counts.link >= 2 || buttonFields.children.length >= 10) {
        updateButtonFields();
        return;
      }

      buttonCount++;
      const id = `link_${buttonCount}`;

      const buttonGroup = document.createElement("div");
      buttonGroup.className = "wd-button-group";
      buttonGroup.id = id;
      buttonGroup.draggable = true;

      buttonGroup.innerHTML = `
          <div class="wd-button-header">
            <div class="wd-button-title">
              <i class="fas fa-link"></i>
              رابط
            </div>
            <div class="wd-button-actions">
              <button type="button" class="wd-button-action delete" onclick="removeButton('${id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="wd-form-row">
            <div class="wd-form-col button-text">
              <label for="linkButtonText_${id}">نص الزر <span class="wd-required">*</span></label>
              <input type="text" id="linkButtonText_${id}" class="wd-form-control"
                placeholder="نص يظهر على الزر" maxlength="25" oninput="updateTemplatePreview()">
              <div class="wd-char-counter" id="linkButtonTextCounter_${id}">0/25</div>
            </div>
            <div class="wd-form-col button-value">
              <label for="linkUrl_${id}">الرابط <span class="wd-required">*</span></label>
              <input type="url" id="linkUrl_${id}" class="wd-form-control"
                placeholder="أدخل الرابط بتنسيق https://example.com" oninput="updateTemplatePreview()">
            </div>
          </div>
        `;

      buttonFields.appendChild(buttonGroup);
      setupDragAndDrop(buttonGroup);

      const buttonTextInput = document.getElementById(`linkButtonText_${id}`);
      buttonTextInput.addEventListener("input", function () {
        updateCharCounter(this, `linkButtonTextCounter_${id}`, 25);
        updateTemplatePreview();
      });

      updateButtonFields();
    }

    function addPhoneButton() {
      const buttonFields = document.getElementById("buttonFields");
      const counts = getButtonTypeCounts();
      if (counts.phone >= 1 || buttonFields.children.length >= 10) {
        updateButtonFields();
        return;
      }

      buttonCount++;
      const id = `phone_${buttonCount}`;

      const buttonGroup = document.createElement("div");
      buttonGroup.className = "wd-button-group";
      buttonGroup.id = id;
      buttonGroup.draggable = true;

      buttonGroup.innerHTML = `
          <div class="wd-button-header">
            <div class="wd-button-title">
              <i class="fas fa-phone"></i>
              اتصال
            </div>
            <div class="wd-button-actions">
              <button type="button" class="wd-button-action delete" onclick="removeButton('${id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="wd-form-row">
            <div class="wd-form-col button-text">
              <label for="phoneButtonText_${id}">نص الزر <span class="wd-required">*</span></label>
              <input type="text" id="phoneButtonText_${id}" class="wd-form-control"
                placeholder="نص يظهر على الزر" maxlength="25" oninput="updateTemplatePreview()">
              <div class="wd-char-counter" id="phoneButtonTextCounter_${id}">0/25</div>
            </div>
            <div class="wd-form-col button-value">
              <label for="phoneNumber_${id}">رقم الهاتف <span class="wd-required">*</span></label>
              <input type="tel" id="phoneNumber_${id}" class="wd-form-control"
                placeholder="أدخل رقم الهاتف بتنسيق +123456789" oninput="updateTemplatePreview()">
            </div>
          </div>
        `;

      buttonFields.appendChild(buttonGroup);
      setupDragAndDrop(buttonGroup);

      const buttonTextInput = document.getElementById(
        `phoneButtonText_${id}`
      );
      buttonTextInput.addEventListener("input", function () {
        updateCharCounter(this, `phoneButtonTextCounter_${id}`, 25);
        updateTemplatePreview();
      });

      updateButtonFields();
    }

    function addCopyButton() {
      const buttonFields = document.getElementById("buttonFields");
      const counts = getButtonTypeCounts();
      if (counts.copy >= 1 || buttonFields.children.length >= 10) {
        updateButtonFields();
        return;
      }

      buttonCount++;
      const id = `copy_${buttonCount}`;

      const buttonGroup = document.createElement("div");
      buttonGroup.className = "wd-button-group";
      buttonGroup.id = id;
      buttonGroup.draggable = true;

      buttonGroup.innerHTML = `
          <div class="wd-button-header">
            <div class="wd-button-title">
              <i class="fas fa-copy"></i>
              نسخ رمز
            </div>
            <div class="wd-button-actions">
              <button type="button" class="wd-button-action delete" onclick="removeButton('${id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="wd-form-row">
            <div class="wd-form-col button-text">
              <label for="copyButtonText_${id}">نص الزر <span class="wd-required">*</span></label>
              <input type="text" id="copyButtonText_${id}" class="wd-form-control"
                placeholder="نص يظهر على الزر" maxlength="25" oninput="updateTemplatePreview()">
              <div class="wd-char-counter" id="copyButtonTextCounter_${id}">0/25</div>
            </div>
            <div class="wd-form-col button-value">
              <label for="copyCode_${id}">رمز العرض <span class="wd-required">*</span></label>
              <input type="text" id="copyCode_${id}" class="wd-form-control"
                placeholder="النص الذي سيتم نسخه عند النقر على الزر" oninput="updateTemplatePreview()">
            </div>
          </div>
        `;

      buttonFields.appendChild(buttonGroup);
      setupDragAndDrop(buttonGroup);

      const buttonTextInput = document.getElementById(`copyButtonText_${id}`);
      buttonTextInput.addEventListener("input", function () {
        updateCharCounter(this, `copyButtonTextCounter_${id}`, 25);
        updateTemplatePreview();
      });

      updateButtonFields();
    }

    function removeButton(id) {
      const buttonElement = document.getElementById(id);
      if (buttonElement) {
        buttonElement.remove();
        updateButtonFields();
      }
    }

    function setupDragAndDrop(element) {
      element.addEventListener("dragstart", handleDragStart);
      element.addEventListener("dragover", handleDragOver);
      element.addEventListener("dragenter", handleDragEnter);
      element.addEventListener("dragleave", handleDragLeave);
      element.addEventListener("drop", handleDrop);
      element.addEventListener("dragend", handleDragEnd);
    }

    let draggedElement = null;

    function handleDragStart(e) {
      this.classList.add("dragging");
      draggedElement = this;
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/html", this.outerHTML);
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = "move";
      return false;
    }

    function handleDragEnter(e) {
      this.classList.add("dragover");
    }

    function handleDragLeave(e) {
      this.classList.remove("dragover");
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      if (draggedElement !== this) {
        const container = document.getElementById("buttonFields");
        const children = Array.from(container.children);
        const draggedIndex = children.indexOf(draggedElement);
        const targetIndex = children.indexOf(this);

        if (draggedIndex < targetIndex) {
          container.insertBefore(draggedElement, this.nextSibling);
        } else {
          container.insertBefore(draggedElement, this);
        }

        updateTemplatePreview();
      }

      this.classList.remove("dragover");
      return false;
    }

    function handleDragEnd(e) {
      this.classList.remove("dragging");
      document.querySelectorAll(".wd-button-group").forEach(function (item) {
        item.classList.remove("dragover");
      });
    }
  </script>
</body>

</html>

</html>